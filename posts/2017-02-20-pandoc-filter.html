<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>enter_haken - using pandoc filters to create graphs with hakyll</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
    </head>
    <body>
        <div id="header">
            <div id="navigation">
                <a href="../">enter_haken</a>
                <a href="../projects.html">projects</a>
                <a href="../cookbook.html">cookbook</a>
                <a href="../notes.html">notes</a>
                <a href="../read.html">read</a>
                <a href="../about.html">about</a>
            </div>
        </div>

        <div id="content">
            <h1>using pandoc filters to create graphs with hakyll</h1>

<div class="info">
    
    Posted on February 20, 2017
    
        
</div>

<p>When you want to convert one document format into an other, <a href="https://jaspervdj.be/hakyll/">Pandoc</a> is your friend. <a href="http://pandoc.org/">Hakyll</a> is using it for converting Markdown into HTML. Once installed (eg. via cabal / stack) you can call pandoc from command line.</p>
<pre><code>$ echo &quot;# test&quot; | pandoc -t native
[Header 1 (&quot;test&quot;,[],[]) [Str &quot;test&quot;]]</code></pre>
<p>This simple example shows the native format. A list of definitions can be found at <a href="http://hackage.haskell.org/package/pandoc-types-1.17.0.5/docs/Text-Pandoc-Definition.html">Hackage</a>. Every document format read is converted into this native format. It is the pandoc internal representation of the document.</p>
<pre><code>$ echo &quot;# test&quot; | pandoc -w html
&lt;h1 id=&quot;test&quot;&gt;test&lt;/h1&gt;</code></pre>
<p>You can get a html output as well. A <a href="http://pandoc.org/scripting.html">pandoc filter</a> can be used to inject a custom behavior between reading and writing a document. This feature is needed to write filters to work with Hakyll</p>
<!--more-->
<p>At first I have to look, how to get a graph, more precisely the graph visualization into the Haskell world. Due to my input comes from a markdown document, it will be plain text. The simple approach is to call the external <code>dot</code> process with this <code>String</code> and read the result. If a library is needed for further implementation this part can be switched out.</p>
<pre><code>import System.Process

graph = &quot;digraph { a -&gt; b; b -&gt; c; a -&gt; c; }&quot;

main :: IO()
main = do
    svg &lt;- readProcess &quot;dot&quot; [&quot;-Tsvg&quot;] graph
    putStr svg </code></pre>
<p>In this example you can pipe a <code>String</code> to an external process and get a result as a <code>String IO</code>.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
 &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Generated by graphviz version 2.38.0 (20140413.2041)
 --&gt;
&lt;!-- Title: %3 Pages: 1 --&gt;
&lt;svg width=&quot;89pt&quot; height=&quot;188pt&quot;
 viewBox=&quot;0.00 0.00 89.00 188.00&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
&lt;g id=&quot;graph0&quot; class=&quot;graph&quot; transform=&quot;scale(1 1) rotate(0) translate(4 184)&quot;&gt;
&lt;title&gt;%3&lt;/title&gt;
&lt;polygon fill=&quot;white&quot; stroke=&quot;none&quot; points=&quot;-4,4 -4,-184 85,-184 85,4 -4,4&quot;/&gt;

...

&lt;g id=&quot;edge2&quot; class=&quot;edge&quot;&gt;&lt;title&gt;b&amp;#45;&amp;gt;c&lt;/title&gt;
&lt;path fill=&quot;none&quot; stroke=&quot;black&quot; d=&quot;M33.3986,-72.411C36.5136,-64.3352 40.3337,-54.4312 43.8346,-45.3547&quot;/&gt;
&lt;polygon fill=&quot;black&quot; stroke=&quot;black&quot; points=&quot;47.1265,-46.5458 47.4597,-35.9562 40.5955,-44.0267 47.1265,-46.5458&quot;/&gt;
&lt;/g&gt;
&lt;/g&gt;
&lt;/svg&gt;</code></pre>
<p>This looks promising. I choose <code>svg</code>, because it can be easily integrated into a html document.</p>
<p>At first a create a simple environment for testing. I use a <code>index.html</code> as a simple template,</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;
&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;
    &lt;head&gt;
        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;
        &lt;title&gt;hakyll test&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
       &lt;div id=&quot;content&quot;&gt;
            $body$
        &lt;/div&gt;
   &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>and a <code>index.markdown</code> with some test data.</p>
<pre><code># hallo

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam

```
codeblock
```

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam

```{lang=&quot;dot&quot;}
digraph graphName { a -&gt; b; b -&gt; c; a -&gt; c; }
```</code></pre>
<p>A hakyll main function can look as following.</p>
<pre><code>{-# LANGUAGE OverloadedStrings #-}
import Hakyll

main :: IO ()
main = hakyll $ do
    match &quot;index.markdown&quot; $ do
        route $ setExtension &quot;html&quot;
        compile $ pandocCompiler 
            &gt;&gt;= loadAndApplyTemplate &quot;template.html&quot; defaultContext

    match &quot;template.html&quot; $ compile templateCompiler</code></pre>
<p>This function will create a single <code>index.html</code> in the output folder. The interesting part here is the <code>pandocCompiler</code>. There is a <a href="https://hackage.haskell.org/package/hakyll-4.9.5.1/docs/Hakyll-Web-Pandoc.html#g:2">derived compiler</a> <code>pandocCompilerWithTransform</code> which allows you to specify a transformation for the given content. Given the type signature <code>pandocCompilerWithTransform :: ReaderOptions -&gt; WriterOptions -&gt; (Pandoc -&gt; Pandoc) -&gt; Compiler (Item String)</code>, I have an entry point for the filter. I need something that takes a <code>Pandoc</code> and returns a <code>Pandoc</code>.</p>
<pre><code>graphViz :: Pandoc -&gt; Pandoc
graphViz = walk codeBlock

codeBlock :: Block -&gt; Block
codeBlock (CodeBlock _ contents) = Para [Str contents]
codeBlock x = x</code></pre>
<p>The <a href="https://hackage.haskell.org/package/pandoc-types-1.19/docs/Text-Pandoc-Walk.html">walk function</a> is used to do something with a specified Pandoc structure. For the filter it is a <code>CodeBlock</code> to look for. This example converts all <code>CodeBlock</code>s into paragraphs.</p>
<p>At this point I need the <code>String</code> representation of the dot lang graph.</p>
<pre><code>svg :: String -&gt; String
svg contents = unsafePerformIO $ readProcess &quot;dot&quot; [&quot;-Tsvg&quot;] contents</code></pre>
<p><a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/System-IO-Unsafe.html#v:unsafePerformIO">unsafePerformIO</a> is a kind of ‘backdoor’. It should be used only with care.</p>
<p>With the new walker,</p>
<pre><code>codeBlock :: Block -&gt; Block
codeBlock cb@(CodeBlock (id, classes, namevals) contents) = 
    case lookup &quot;lang&quot; namevals of
        Just f -&gt; RawBlock (Format &quot;html&quot;) $ svg contents
        nothing -&gt; cb
codeBlock x = x</code></pre>
<p>I can call the custom compiler with the <code>graphViz</code> function.</p>
<pre><code>pandocPostCompiler :: Compiler (Item String)
pandocPostCompiler = pandocCompilerWithTransform
    defaultHakyllReaderOptions
    defaultHakyllWriterOptions
    graphViz</code></pre>
<p>Putting it all together</p>
<pre><code>{-# LANGUAGE OverloadedStrings #-}
import Hakyll
import Text.Pandoc
import Text.Pandoc.Walk ( walk )

import System.Process ( readProcess )
import System.IO.Unsafe ( unsafePerformIO )

main :: IO ()
main = hakyll $ do
    match &quot;index.markdown&quot; $ do
        route $ setExtension &quot;html&quot;
        compile $ pandocPostCompiler 
            &gt;&gt;= loadAndApplyTemplate &quot;template.html&quot; defaultContext

    match &quot;template.html&quot; $ compile templateCompiler

pandocPostCompiler :: Compiler (Item String)
pandocPostCompiler = pandocCompilerWithTransform
    defaultHakyllReaderOptions
    defaultHakyllWriterOptions
    graphViz

graphViz :: Pandoc -&gt; Pandoc
graphViz = walk codeBlock

codeBlock :: Block -&gt; Block
codeBlock cb@(CodeBlock (id, classes, namevals) contents) = 
    case lookup &quot;lang&quot; namevals of
        Just f -&gt; RawBlock (Format &quot;html&quot;) $ svg contents
        nothing -&gt; cb
codeBlock x = x

svg :: String -&gt; String
svg contents = unsafePerformIO $ readProcess &quot;dot&quot; [&quot;-Tsvg&quot;] contents</code></pre>
<p>This code transforms a markdown document into html and converts all codeblocks with a <code>lang</code> tag into a svg version of the given graph. At this point, I don’t use the value of <code>lang</code>. It is possible to implement a different behaviour for other tags or different values.</p>
<p>See the <a href="../example/pandoc/dotlang/index.html">result</a> or check out the <a href="https://github.com/enter-haken/hakyll-dot-demo">code</a>, if you like it.</p>

        </div>
        <div id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
        </div>
    </body>
</html>
