<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>enter_haken - Working with immutable data in Postgres</title>
        <!--<link rel="stylesheet" type="text/css" href="/css/default.css" />-->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
        <link rel="stylesheet" type="text/css" href="../css/milligram.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
        <script src="js/vis.min.js"></script>
    </head>
    <body>
        <section id="navigation">
            <a href="../">enter_haken</a>
            <a href="../projects.html">projects</a>
            <a href="../cookbook.html">cookbook</a>
            <a href="../notes.html">notes</a>
            <a href="../read.html">read</a>
            <a href="../about.html">about</a>
        </section>

        <section id="content">
            <h1>Working with immutable data in Postgres</h1>

<div class="info">
    
    Posted on July 15, 2017
    
        
</div>

<p>After taking a <a href="../posts/2017-07-06-database-architecture.html">first look</a> at the JSON columns, letâ€™s look at a few possible applications. Imagine a simple shop system with articles, prices and purchase orders.</p>
<p>An article can be <code>active</code> or <code>inactive</code>.</p>
<pre><code>CREATE TYPE article_status AS ENUM (
    'active',
    'inactive'
);</code></pre>
<p>Every article has an <code>article_number</code>.</p>
<pre><code>CREATE TABLE article (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    article_number VARCHAR(128) UNIQE NOT NULL DEFAULT '',
    name VARCHAR(128),
    description VARCHAR(2048),
    status article_status NOT NULL DEFAULT 'active'
);</code></pre>
<p>You can see that <code>id</code> and <code>article_number</code> are unique, so both could be used as a primary key. This is not normalized in a usual way.</p>
<p>There are a few points, why to stick to this solution.</p>
<!--more-->
<ul>
<li>A primary key should only be used to identify a record. Not more, not less.</li>
<li>There must be no reuse for a business case, like it would be for <code>article_number</code>. The <code>article_number</code> could not be changed so easily, after being promoted to a primary key.</li>
<li>A <code>article_number</code> identifies an article entity not a database record.</li>
</ul>
<h1 id="prices-with-history">prices with history</h1>
<p>Every <code>article</code> can have a price.</p>
<pre><code>CREATE TABLE price (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_article UUID NOT NULL REFERENCES article(id),
    price real NOT NULL DEFAULT 0.0,
    scale_lower_limit INT NOT NULL DEFAULT 1,
    scale_upper_limit INT NOT NULL DEFAULT 2147483647,
    valid_from DATE NOT NULL DEFAULT current_date,
    valid_to DATE NOT NULL DEFAULT current_date + interval '1 year'
);</code></pre>
<p>An <code>article</code> can have multiple prices over time. There can be multiple price scales. A <code>price</code> will be more likely changed than an <code>article</code>. Price changes may be interesting for reporting issues.</p>
<p>You can store these changes in a JSONB column.</p>
<pre><code>ALTER TABLE price ADD COLUMN history JSONB;</code></pre>
<p>Every time, a price record changes. these changes should be saved. These saved items should be immutable over time.</p>
<pre><code>CREATE FUNCTION history_trigger() RETURNS TRIGGER AS $$.

BEGIN
    IF NEW.history IS NULL THEN
        NEW.history := '[]'::JSONB;
    END IF;

    NEW.history := NEW.history::JSONB || (row_to_json(OLD)::JSONB - 'history');
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER price_history_trigger BEFORE UPDATE ON price
    FOR EACH ROW EXECUTE PROCEDURE history_trigger();</code></pre>
<p>First of all, an <code>article</code> has to be created.</p>
<pre><code>$ psql -U postgres -c &quot;INSERT INTO test.article (article_number, name, description) \
&gt; VALUES ('AB12345', 'Test article','Test desc')&quot;
INSERT 0 1</code></pre>
<p>For this newly inserted article</p>
<pre><code>$ psql -U postgres -c &quot;SELECT * from test.article&quot; | cat
                  id                  | article_number |     name     | description | status |         created_at         |         updated_at         
--------------------------------------+----------------+--------------+-------------+--------+----------------------------+----------------------------
 f12def37-3de6-4985-8912-054891631499 | AB12345        | Test article | Test desc   | active | 2017-07-15 19:17:14.727931 | 2017-07-15 19:17:14.727931
(1 row)</code></pre>
<p>you can add a <code>price</code>,</p>
<pre><code>$ psql -U postgres -c &quot;INSERT INTO test.price (id_article, price) \
&gt; VALUES ('f12def37-3de6-4985-8912-054891631499',50.5)&quot;
INSERT 0 1

$ psql -U postgres -c &quot;SELECT * FROM test.price&quot; | cat
                  id                  |              id_article              | price | scale_lower_limit | scale_upper_limit | valid_from |  valid_to  | history |         created_at         |         updated_at         
--------------------------------------+--------------------------------------+-------+-------------------+-------------------+------------+------------+---------+----------------------------+----------------------------
 3a113796-05fd-4ff3-a33f-b08f92c01cd8 | f12def37-3de6-4985-8912-054891631499 |  50.5 |                 1 |        2147483647 | 2017-07-15 | 2018-07-15 |         | 2017-07-15 19:21:39.245331 | 2017-07-15 19:21:39.245331
(1 row)</code></pre>
<p>and raise the price value for the <code>price</code> record.</p>
<pre><code>$ psql -U postgres -c &quot;UPDATE test.price SET price = 70.2 WHERE id = '3a113796-05fd-4ff3-a33f-b08f92c01cd8'&quot;
UPDATE 1

$ psql -U postgres -c &quot;SELECT * FROM test.price&quot; | cat
                  id                  |              id_article              | price | scale_lower_limit | scale_upper_limit | valid_from |  valid_to  |                                                                                                                                                           history                                                                                                                                                            |         created_at         |         updated_at
--------------------------------------+--------------------------------------+-------+-------------------+-------------------+------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------
 3a113796-05fd-4ff3-a33f-b08f92c01cd8 | f12def37-3de6-4985-8912-054891631499 |  70.2 |                 1 |        2147483647 | 2017-07-15 | 2018-07-15 | [{&quot;id&quot;: &quot;3a113796-05fd-4ff3-a33f-b08f92c01cd8&quot;, &quot;price&quot;: 50.5, &quot;valid_to&quot;: &quot;2018-07-15&quot;, &quot;created_at&quot;: &quot;2017-07-15T19:21:39.245331&quot;, &quot;id_article&quot;: &quot;f12def37-3de6-4985-8912-054891631499&quot;, &quot;updated_at&quot;: &quot;2017-07-15T19:21:39.245331&quot;, &quot;valid_from&quot;: &quot;2017-07-15&quot;, &quot;scale_lower_limit&quot;: 1, &quot;scale_upper_limit&quot;: 2147483647}] | 2017-07-15 19:21:39.245331 | 2017-07-15 19:25:04.672829
(1 row)</code></pre>
<p>The <code>history</code> is updated every time, a <code>price</code> record is updated.</p>
<h1 id="customer">customer</h1>
<p>A <code>customer</code> is a kind of <code>person</code> which has a <code>customer_number</code></p>
<pre><code>CREATE TABLE customer (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_person UUID NOT NULL REFERENCES person(id),
    customer_number VARCHAR(128) NOT NULL DEFAULT '',
    json_view JSONB
);</code></pre>
<p>As you can see, a <code>json_view</code> column is added to the <code>customer</code>. The only difference between a <code>person</code> and a customer is the <code>customer_number</code>.</p>
<p>Analog to the <code>persons</code> <a href="../posts/2017-07-06-database-architecture.html#json-column">update function</a> we can write an update function for a <code>customer</code></p>
<pre><code>CREATE FUNCTION update_json_view_customer(id_customer UUID) RETURNS VOID AS $$
DECLARE
    customer_raw JSONB;
    person_id UUID;
BEGIN

    IF NOT EXISTS (SELECT 1 FROM person p 
        JOIN customer c on p.id = c.id_person 
        WHERE p.json_view IS NOT NULL AND c.id = id_customer) THEN

        SELECT id_person FROM customer WHERE id = id_customer INTO person_id;

        RAISE NOTICE 'update json_view for person %', person_id;

        perform update_json_view_person(person_id);
    END IF;

    SELECT row_to_json(c) FROM 
        (SELECT c.id, customer_number, p.json_view AS person_json_view FROM customer c
            JOIN person p on c.id_person = p.id
            WHERE c.id = id_customer LIMIT 1) c INTO customer_raw;

    customer_raw := customer_raw || jsonb_build_object('person', customer_raw-&gt;'person_json_view');
    customer_raw := customer_raw - 'person_json_view';

    UPDATE customer SET json_view = customer_raw WHERE id = id_customer;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>The <code>json_view</code> of the <code>person</code> is reused.</p>
<p>Letâ€™s take a inserted person.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT id FROM test.person&quot;
                  id
--------------------------------------
 da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2
(1 row)</code></pre>
<p>and insert a new <code>customer</code> for this <code>person</code>.</p>
<pre><code>$ psql -U postgres -c &quot;INSERT INTO test.customer (customer_number, id_person) \
VALUES ('AB12345', 'da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2');&quot;
INSERT 0 1</code></pre>
<p>The newly inserted <code>customer</code> looks like</p>
<pre><code>$ psql -U postgres -c &quot;SELECT * FROM test.customer&quot; | cat
                  id                  |              id_person               | customer_number | json_view |         created_at         |         updated_at         
--------------------------------------+--------------------------------------+-----------------+-----------+----------------------------+----------------------------
 88a99ea7-4281-496b-9c95-3625101177ca | da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2 | AB12345         |           | 2017-07-15 18:41:27.811324 | 2017-07-15 18:41:27.811324
(1 row)</code></pre>
<p>Now the <code>customer</code>â€™s <code>json_view</code> must be filled.</p>
<pre><code>$ psql -U postgres -c &quot;SET search_path TO test,public; \
&gt;  SELECT test.update_json_view_customer('88a99ea7-4281-496b-9c95-3625101177ca');&quot;
 update_json_view_customer 
---------------------------
  
(1 row)

$ psql -U postgres -c &quot;SELECT * FROM test.customer&quot; | cat
                  id                  |              id_person               | customer_number |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              json_view                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |         created_at         |         updated_at         
--------------------------------------+--------------------------------------+-----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------
 88a99ea7-4281-496b-9c95-3625101177ca | da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2 | AB12345         | {&quot;id&quot;: &quot;88a99ea7-4281-496b-9c95-3625101177ca&quot;, &quot;person&quot;: {&quot;id&quot;: &quot;da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2&quot;, &quot;notes&quot;: null, &quot;website&quot;: null, &quot;addresses&quot;: [{&quot;id&quot;: &quot;9a78ceb0-5169-4bca-bbf5-aac54fcaa95a&quot;, &quot;city&quot;: &quot;Dortmund&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44339&quot;, &quot;address_type&quot;: &quot;private&quot;, &quot;house_number&quot;: &quot;123&quot;}, {&quot;id&quot;: &quot;c69ec275-0a05-42ce-80ea-1ea1b5bcbd78&quot;, &quot;city&quot;: &quot;Bochum&quot;, &quot;street&quot;: &quot;Fakeroad&quot;, &quot;postal_code&quot;: &quot;44866&quot;, &quot;address_type&quot;: &quot;work&quot;, &quot;house_number&quot;: &quot;321&quot;}], &quot;last_name&quot;: &quot;Hake&quot;, &quot;birth_date&quot;: null, &quot;first_name&quot;: &quot;Jan Frederik&quot;, &quot;phone_numbers&quot;: [{&quot;id&quot;: &quot;0df74379-6512-4f54-a1a7-fee1c1605342&quot;, &quot;phone_number&quot;: &quot;+49231123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;landline&quot;, &quot;is_primary_phone_number&quot;: true}, {&quot;id&quot;: &quot;a9d36784-7af3-47e8-b357-2f03500f7d66&quot;, &quot;phone_number&quot;: &quot;+49151123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;cellular_network&quot;, &quot;is_primary_phone_number&quot;: false}], &quot;email_addresses&quot;: [{&quot;id&quot;: &quot;ff2fee9e-490f-49b2-8e0e-69d5bddd2ca0&quot;, &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;is_primary_email_address&quot;: false}]}, &quot;customer_number&quot;: &quot;AB12345&quot;} | 2017-07-15 18:41:27.811324 | 2017-07-15 18:50:47.591534
(1 row)</code></pre>
<p>a little bit more beautifull</p>
<pre><code>{
    &quot;id&quot;: &quot;88a99ea7-4281-496b-9c95-3625101177ca&quot;,
    &quot;person&quot;: {
        &quot;id&quot;: &quot;da44de2f-aa0a-43c5-9fed-dcbb5b6c32a2&quot;,
        &quot;notes&quot;: null,
        &quot;website&quot;: null,
        &quot;addresses&quot;: [{
            &quot;id&quot;: &quot;9a78ceb0-5169-4bca-bbf5-aac54fcaa95a&quot;,
            &quot;city&quot;: &quot;Dortmund&quot;,
            &quot;street&quot;: &quot;Fakestreet&quot;,
            &quot;postal_code&quot;: &quot;44339&quot;,
            &quot;address_type&quot;: &quot;private&quot;,
            &quot;house_number&quot;: &quot;123&quot;
        }, {
            &quot;id&quot;: &quot;c69ec275-0a05-42ce-80ea-1ea1b5bcbd78&quot;,
            &quot;city&quot;: &quot;Bochum&quot;,
            &quot;street&quot;: &quot;Fakeroad&quot;,
            &quot;postal_code&quot;: &quot;44866&quot;,
            &quot;address_type&quot;: &quot;work&quot;,
            &quot;house_number&quot;: &quot;321&quot;
        }],
        &quot;last_name&quot;: &quot;Hake&quot;,
        &quot;birth_date&quot;: null,
        &quot;first_name&quot;: &quot;Jan Frederik&quot;,
        &quot;phone_numbers&quot;: [{
            &quot;id&quot;: &quot;0df74379-6512-4f54-a1a7-fee1c1605342&quot;,
            &quot;phone_number&quot;: &quot;+49231123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;landline&quot;,
            &quot;is_primary_phone_number&quot;: true
        }, {
            &quot;id&quot;: &quot;a9d36784-7af3-47e8-b357-2f03500f7d66&quot;,
            &quot;phone_number&quot;: &quot;+49151123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;cellular_network&quot;,
            &quot;is_primary_phone_number&quot;: false
        }],
        &quot;email_addresses&quot;: [{
            &quot;id&quot;: &quot;ff2fee9e-490f-49b2-8e0e-69d5bddd2ca0&quot;,
            &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;is_primary_email_address&quot;: false
        }]
    },
    &quot;customer_number&quot;: &quot;AB12345&quot;
}</code></pre>
<h1 id="a-purchase-process">a purchase process</h1>
<p>Now we have a <code>customer</code> and <code>articles</code> with <code>prices</code>. The next step is to buy something. But first we take a look at a common workflow, when you buy something in a shop.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="1035pt" height="233pt" viewBox="0.00 0.00 1035.05 233.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 229)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-229 1031.0475,-229 1031.0475,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="108.0475,-8 108.0475,-217 381.0475,-217 381.0475,-8 108.0475,-8"></polygon>
<text text-anchor="middle" x="244.5475" y="-201.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">mutable</text>
<text text-anchor="middle" x="244.5475" y="-186.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">data</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="457.0475,-89 457.0475,-181 959.0475,-181 959.0475,-89 457.0475,-89"></polygon>
<text text-anchor="middle" x="708.0475" y="-165.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">immutable</text>
<text text-anchor="middle" x="708.0475" y="-150.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">data</text>
</g>
<!-- po -->
<g id="node1" class="node">
<title>po</title>
<path fill="#ffffff" stroke="#ffffff" d="M176.0475,-130C176.0475,-130 128.0475,-130 128.0475,-130 122.0475,-130 116.0475,-124 116.0475,-118 116.0475,-118 116.0475,-104 116.0475,-104 116.0475,-98 122.0475,-92 128.0475,-92 128.0475,-92 176.0475,-92 176.0475,-92 182.0475,-92 188.0475,-98 188.0475,-104 188.0475,-104 188.0475,-118 188.0475,-118 188.0475,-124 182.0475,-130 176.0475,-130"></path>
<text text-anchor="middle" x="152.0475" y="-114.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">purchase</text>
<text text-anchor="middle" x="152.0475" y="-99.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">order</text>
</g>
<!-- rts -->
<g id="node2" class="node">
<title>rts</title>
<path fill="#ffffff" stroke="#ffffff" d="M361.0475,-171C361.0475,-171 320.0475,-171 320.0475,-171 314.0475,-171 308.0475,-165 308.0475,-159 308.0475,-159 308.0475,-145 308.0475,-145 308.0475,-139 314.0475,-133 320.0475,-133 320.0475,-133 361.0475,-133 361.0475,-133 367.0475,-133 373.0475,-139 373.0475,-145 373.0475,-145 373.0475,-159 373.0475,-159 373.0475,-165 367.0475,-171 361.0475,-171"></path>
<text text-anchor="middle" x="340.5475" y="-155.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ready to</text>
<text text-anchor="middle" x="340.5475" y="-140.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">send</text>
</g>
<!-- po&#45;&gt;rts -->
<g id="edge1" class="edge">
<title>po-&gt;rts</title>
<path fill="none" stroke="#000000" d="M188.3485,-125.6463C199.9209,-129.8487 212.8816,-134.0788 225.0475,-137 248.8105,-142.7058 275.8793,-146.3674 297.8362,-148.6432"></path>
<polygon fill="#000000" stroke="#000000" points="297.5568,-152.1325 307.8501,-149.6228 298.2384,-145.1657 297.5568,-152.1325"></polygon>
</g>
<!-- item -->
<g id="node3" class="node">
<title>item</title>
<path fill="#ffffff" stroke="#ffffff" d="M355.5475,-99C355.5475,-99 325.5475,-99 325.5475,-99 319.5475,-99 313.5475,-93 313.5475,-87 313.5475,-87 313.5475,-75 313.5475,-75 313.5475,-69 319.5475,-63 325.5475,-63 325.5475,-63 355.5475,-63 355.5475,-63 361.5475,-63 367.5475,-69 367.5475,-75 367.5475,-75 367.5475,-87 367.5475,-87 367.5475,-93 361.5475,-99 355.5475,-99"></path>
<text text-anchor="middle" x="340.5475" y="-77.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">items</text>
</g>
<!-- po&#45;&gt;item -->
<g id="edge2" class="edge">
<title>po-&gt;item</title>
<path fill="none" stroke="#000000" d="M167.3926,-91.7386C180.7742,-76.6092 201.668,-56.6935 225.0475,-48 250.9891,-38.3538 281.075,-47.5781 304.0362,-58.6997"></path>
<polygon fill="#000000" stroke="#000000" points="302.5984,-61.8961 313.0916,-63.3604 305.8018,-55.6721 302.5984,-61.8961"></polygon>
<text text-anchor="middle" x="248.0475" y="-51.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">add</text>
</g>
<!-- po&#45;&gt;item -->
<g id="edge3" class="edge">
<title>po-&gt;item</title>
<path fill="none" stroke="#000000" d="M188.0542,-105.02C199.8404,-103.0789 212.9995,-100.929 225.0475,-99 251.2875,-94.7987 280.9029,-90.1859 303.5752,-86.6818"></path>
<polygon fill="#000000" stroke="#000000" points="304.1174,-90.1396 313.4665,-85.1553 303.0497,-83.2215 304.1174,-90.1396"></polygon>
<text text-anchor="middle" x="248.0475" y="-102.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">modify</text>
</g>
<!-- po&#45;&gt;item -->
<g id="edge4" class="edge">
<title>po-&gt;item</title>
<path fill="none" stroke="#000000" d="M188.1663,-116.4602C211.992,-118.955 243.7298,-120.1561 271.0475,-114 282.3208,-111.4595 293.9121,-106.8672 304.3189,-101.9"></path>
<polygon fill="#000000" stroke="#000000" points="306.1399,-104.9019 313.5002,-97.2811 302.994,-98.6487 306.1399,-104.9019"></polygon>
<text text-anchor="middle" x="248.0475" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">remove</text>
</g>
<!-- snd -->
<g id="node4" class="node">
<title>snd</title>
<path fill="#ffffff" stroke="#ffffff" d="M507.0475,-134C507.0475,-134 477.0475,-134 477.0475,-134 471.0475,-134 465.0475,-128 465.0475,-122 465.0475,-122 465.0475,-110 465.0475,-110 465.0475,-104 471.0475,-98 477.0475,-98 477.0475,-98 507.0475,-98 507.0475,-98 513.0475,-98 519.0475,-104 519.0475,-110 519.0475,-110 519.0475,-122 519.0475,-122 519.0475,-128 513.0475,-134 507.0475,-134"></path>
<text text-anchor="middle" x="492.0475" y="-112.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">send</text>
</g>
<!-- rts&#45;&gt;snd -->
<g id="edge5" class="edge">
<title>rts-&gt;snd</title>
<path fill="none" stroke="#000000" d="M373.356,-151.4841C394.7537,-150.3788 423.0586,-147.4491 447.0475,-140 449.8221,-139.1384 452.6247,-138.1034 455.4026,-136.9536"></path>
<polygon fill="#000000" stroke="#000000" points="457.0536,-140.0467 464.6752,-132.6872 454.1277,-133.6876 457.0536,-140.0467"></polygon>
</g>
<!-- item&#45;&gt;snd -->
<g id="edge9" class="edge">
<title>item-&gt;snd</title>
<path fill="none" stroke="#000000" d="M367.6307,-75.7797C389.6639,-72.6913 421.2244,-70.9417 447.0475,-80 454.1872,-82.5045 461.0356,-86.6709 467.1418,-91.2987"></path>
<polygon fill="#000000" stroke="#000000" points="465.033,-94.0968 474.9661,-97.7827 469.4996,-88.707 465.033,-94.0968"></polygon>
<text text-anchor="middle" x="419.0475" y="-128.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">frozen</text>
<text text-anchor="middle" x="419.0475" y="-113.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">purchase</text>
<text text-anchor="middle" x="419.0475" y="-98.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">order</text>
<text text-anchor="middle" x="419.0475" y="-83.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">items</text>
</g>
<!-- delivered -->
<g id="node5" class="node">
<title>delivered</title>
<path fill="#ffffff" stroke="#ffffff" d="M653.0475,-134C653.0475,-134 606.0475,-134 606.0475,-134 600.0475,-134 594.0475,-128 594.0475,-122 594.0475,-122 594.0475,-110 594.0475,-110 594.0475,-104 600.0475,-98 606.0475,-98 606.0475,-98 653.0475,-98 653.0475,-98 659.0475,-98 665.0475,-104 665.0475,-110 665.0475,-110 665.0475,-122 665.0475,-122 665.0475,-128 659.0475,-134 653.0475,-134"></path>
<text text-anchor="middle" x="629.5475" y="-112.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">delivered</text>
</g>
<!-- snd&#45;&gt;delivered -->
<g id="edge6" class="edge">
<title>snd-&gt;delivered</title>
<path fill="none" stroke="#000000" d="M519.2131,-116C537.5748,-116 562.2756,-116 583.6508,-116"></path>
<polygon fill="#000000" stroke="#000000" points="583.8346,-119.5001 593.8346,-116 583.8345,-112.5001 583.8346,-119.5001"></polygon>
</g>
<!-- rfi -->
<g id="node6" class="node">
<title>rfi</title>
<path fill="#ffffff" stroke="#ffffff" d="M798.0475,-135C798.0475,-135 752.0475,-135 752.0475,-135 746.0475,-135 740.0475,-129 740.0475,-123 740.0475,-123 740.0475,-109 740.0475,-109 740.0475,-103 746.0475,-97 752.0475,-97 752.0475,-97 798.0475,-97 798.0475,-97 804.0475,-97 810.0475,-103 810.0475,-109 810.0475,-109 810.0475,-123 810.0475,-123 810.0475,-129 804.0475,-135 798.0475,-135"></path>
<text text-anchor="middle" x="775.0475" y="-119.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ready for</text>
<text text-anchor="middle" x="775.0475" y="-104.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">invoice</text>
</g>
<!-- delivered&#45;&gt;rfi -->
<g id="edge7" class="edge">
<title>delivered-&gt;rfi</title>
<path fill="none" stroke="#000000" d="M665.1408,-116C684.5731,-116 708.8402,-116 729.6251,-116"></path>
<polygon fill="#000000" stroke="#000000" points="729.8217,-119.5001 739.8217,-116 729.8216,-112.5001 729.8217,-119.5001"></polygon>
</g>
<!-- inv -->
<g id="node7" class="node">
<title>inv</title>
<path fill="#ffffff" stroke="#ffffff" d="M939.0475,-134C939.0475,-134 897.0475,-134 897.0475,-134 891.0475,-134 885.0475,-128 885.0475,-122 885.0475,-122 885.0475,-110 885.0475,-110 885.0475,-104 891.0475,-98 897.0475,-98 897.0475,-98 939.0475,-98 939.0475,-98 945.0475,-98 951.0475,-104 951.0475,-110 951.0475,-110 951.0475,-122 951.0475,-122 951.0475,-128 945.0475,-134 939.0475,-134"></path>
<text text-anchor="middle" x="918.0475" y="-112.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">invoiced</text>
</g>
<!-- rfi&#45;&gt;inv -->
<g id="edge8" class="edge">
<title>rfi-&gt;inv</title>
<path fill="none" stroke="#000000" d="M810.3958,-116C829.7824,-116 853.9809,-116 874.5223,-116"></path>
<polygon fill="#000000" stroke="#000000" points="874.5797,-119.5001 884.5796,-116 874.5796,-112.5001 874.5797,-119.5001"></polygon>
</g>
<!-- end -->
<g id="node9" class="node">
<title>end</title>
<polygon fill="none" stroke="#000000" points="1027.0475,-135.5 988.0475,-135.5 988.0475,-96.5 1027.0475,-96.5 1027.0475,-135.5"></polygon>
<polyline fill="none" stroke="#000000" points="1000.0475,-135.5 988.0475,-123.5 "></polyline>
<polyline fill="none" stroke="#000000" points="988.0475,-108.5 1000.0475,-96.5 "></polyline>
<polyline fill="none" stroke="#000000" points="1015.0475,-96.5 1027.0475,-108.5 "></polyline>
<polyline fill="none" stroke="#000000" points="1027.0475,-123.5 1015.0475,-135.5 "></polyline>
<text text-anchor="middle" x="1007.5475" y="-112.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">end</text>
</g>
<!-- inv&#45;&gt;end -->
<g id="edge11" class="edge">
<title>inv-&gt;end</title>
<path fill="none" stroke="#000000" d="M951.1197,-116C959.8028,-116 969.1166,-116 977.6242,-116"></path>
<polygon fill="#000000" stroke="#000000" points="977.8614,-119.5001 987.8614,-116 977.8613,-112.5001 977.8614,-119.5001"></polygon>
</g>
<!-- start -->
<g id="node8" class="node">
<title>start</title>
<polygon fill="none" stroke="#000000" points="39.5238,-129 -.0238,-111 39.5238,-93 79.0713,-111 39.5238,-129"></polygon>
<polyline fill="none" stroke="#000000" points="10.8981,-115.9711 10.8981,-106.0289 "></polyline>
<polyline fill="none" stroke="#000000" points="28.6018,-97.9711 50.4457,-97.9711 "></polyline>
<polyline fill="none" stroke="#000000" points="68.1494,-106.0289 68.1494,-115.9711 "></polyline>
<polyline fill="none" stroke="#000000" points="50.4457,-124.0289 28.6018,-124.0289 "></polyline>
<text text-anchor="middle" x="39.5238" y="-107.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">start</text>
</g>
<!-- start&#45;&gt;po -->
<g id="edge10" class="edge">
<title>start-&gt;po</title>
<path fill="none" stroke="#000000" d="M79.1954,-111C87.7453,-111 96.8566,-111 105.6374,-111"></path>
<polygon fill="#000000" stroke="#000000" points="105.7401,-114.5001 115.74,-111 105.74,-107.5001 105.7401,-114.5001"></polygon>
</g>
</g>
</svg>
</div>
<p>When you enter a web shop, you can search for articles, and put them into a shopping cart. While you are creating your cart, you can change the amount of an article, or delete previously added ones. When you are satisfied with your selection, you finalize your requisition. After finalization, parts of your cart like the items can not be changed any more.</p>
<p>Article descriptions or names can be changed over time. Prices may vary.</p>
<h2 id="a-purchase-order">a purchase order</h2>
<p>A purchase order can have one of the following states</p>
<pre><code>CREATE TYPE purchase_order_status AS ENUM (
    'requisition', 
    'ready_to_send', 
    'send', 
    'delivered',
    'ready_for_invoice',
    'invoiced',
    'finalized');</code></pre>
<p>It is assumed, that every purchase order has a relation to a <code>customer</code>. For this example this is enough.</p>
<pre><code>CREATE TABLE purchase_order (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_customer UUID NOT NULL REFERENCES customer(id),
    purchase_order_number VARCHAR(128) NOT NULL UNIQUE DEFAULT '',
    status purchase_order_status NOT NULL DEFAULT 'requisition'
);</code></pre>
<p>Every purchase order has a unique <code>purchase_order_number</code>.</p>
<pre><code>CREATE TABLE purchase_order_item (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_purchase_order UUID NOT NULL REFERENCES purchase_order(id),
    id_article UUID NOT NULL REFERENCES article(id),
    id_price UUID NOT NULL REFERENCES price(id),
    amount int NOT NULL DEFAULT 1
);</code></pre>
<p>A <code>purchase_order_item</code> has a reference to a <code>purchase_order</code>.</p>
<p>Unless we are in a mutable state, There is no need for storing extra data. This changes, when the <code>purchase_order_status</code> changes to <code>send</code>. The <code>purchase_order_items</code> canâ€™t be changed any more. The purchased items are on their way to the <code>customer</code>. The only thing, which can change is the <code>purchase_order_status</code>, but only forward in the chain.</p>
<p>This is the point, where the items should be saved in a immutable way. There are no immutable types in Postgres, but it can be made hard for a process to change such data columns, which should not be updated.</p>
<p>For our example, we must store the article, with itâ€™s price at the time of purchase. We also need the <code>customer</code>, who must have some kind of address, to send the delivery to.</p>
<pre><code>ALTER TABLE purchase_order ADD COLUMN frozen_purchase_order JSONB;</code></pre>
<p>This column should be updated, when the <code>purchase_order_status</code> is set to <code>send</code>. So, we need a trigger function which listens on state changes. The scaffold looks like</p>
<pre><code>CREATE FUNCTION freeze_purchase_order() RETURNS TRIGGER AS $$
BEGIN
    return NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER freeze_purchase_order_trigger BEFORE UPDATE ON purchase_order
    FOR EACH ROW EXECUTE PROCEDURE freeze_purchase_order();</code></pre>
<p>Now we listen to the <code>send</code> state. At this point, the purchase order some data have to be frozen. Everything below this state can be ignored.</p>
<pre><code>IF NEW.status = ANY('{requisition,ready_to_send}'::purchase_order_status[]) THEN
    RAISE NOTICE 'nothing to do';
    RETURN NEW;
END IF;</code></pre>
<p>To store some JSON objects we define some variables</p>
<pre><code>DECLARE
    frozen_purchase_order JSONB;
    customer JSONB;
    purchase_order_items JSONB;
    rawItem RECORD;</code></pre>
<p>The <code>frozen_purchase_order</code> will be the result JSON. First we get the current <code>customer</code></p>
<pre><code>SELECT json_view FROM customer WHERE id = NEW.id_customer INTO customer;</code></pre>
<p>A purchase order item contains an article and a price. The function to get a json representation for a item can look like</p>
<pre><code>CREATE FUNCTION get_json_from_item(item_id UUID) RETURNS JSONB AS $$
DECLARE
    result JSONB;
    article JSONB;
    price JSONB;
BEGIN
    SELECT row_to_json(item) FROM (SELECT id_article, id_price, amount FROM purchase_order_item WHERE id = item_id) item INTO result; 
    SELECT row_to_json(rawArticle) FROM (SELECT id, article_number, name, description FROM article WHERE id = (result-&gt;&gt;'id_article')::UUID) rawArticle INTO article;
    SELECT row_to_json(rawPrice) FROM (SELECT id, p.price, scale_lower_limit, scale_upper_limit, valid_from, valid_to FROM price p WHERE id = (result-&gt;&gt;'id_price')::UUID) rawPrice INTO price;

    result := result 
     || jsonb_build_object('article', article)
     || jsonb_build_object('price', price);

    result := result - 'id_article';
    result := result - 'id_price';

    RETURN result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>The purchase order trigger function can consume this function as following</p>
<pre><code>purchase_order_items := '[]'::JSONB;

FOR rawItem IN (SELECT get_json_from_item(id)::JSONB AS get_json FROM purchase_order_item WHERE id_purchase_order = NEW.id) 
LOOP
    purchase_order_items := purchase_order_items || rawItem.get_json;    
END LOOP;</code></pre>
<p>The current NEW record must be set as root for our result JSON.</p>
<pre><code>SELECT row_to_json(NEW.*) INTO frozen_purchase_order;</code></pre>
<p>Then the <code>customer</code> and the <code>items</code> have to be merged into the result.</p>
<pre><code>frozen_purchase_order := frozen_purchase_order 
    || jsonb_build_object('items', purchase_order_items)
    || jsonb_build_object('customer', customer);</code></pre>
<p>At last, some unnecessary fields must be deleted from our frozen purchase order.</p>
<pre><code>frozen_purchase_order := frozen_purchase_order - 'frozen_purchase_order';
frozen_purchase_order := frozen_purchase_order - 'id_customer';</code></pre>
<p>Then we have our result.</p>
<pre><code>NEW.frozen_purchase_order := frozen_purchase_order;</code></pre>
<p>The complete function looks like</p>
<pre><code>CREATE FUNCTION freeze_purchase_order() RETURNS TRIGGER AS $$
DECLARE
    frozen_purchase_order JSONB;
    customer JSONB;
    purchase_order_items JSONB;
    rawItem RECORD;
BEGIN
    IF NEW.status = ANY('{requisition,ready_to_send}'::purchase_order_status[]) THEN
        RAISE NOTICE 'nothing to do';
        RETURN NEW;
    END IF;
    RAISE NOTICE 'freeze';

    SELECT json_view FROM customer WHERE id = NEW.id_customer INTO customer;

    purchase_order_items := '[]'::JSONB;

    FOR rawItem IN (SELECT get_json_from_item(id)::JSONB AS get_json FROM purchase_order_item WHERE id_purchase_order = NEW.id) 
    LOOP
        purchase_order_items := purchase_order_items || rawItem.get_json;    
    END LOOP;

    SELECT row_to_json(NEW.*) INTO frozen_purchase_order;

    frozen_purchase_order := frozen_purchase_order 
        || jsonb_build_object('items', purchase_order_items)
        || jsonb_build_object('customer', customer);

    frozen_purchase_order := frozen_purchase_order - 'frozen_purchase_order';
    frozen_purchase_order := frozen_purchase_order - 'id_customer';

    NEW.frozen_purchase_order := frozen_purchase_order;
    
    RETURN NEW;
END
$$ LANGUAGE plpgsql;</code></pre>
<h2 id="add-some-data">add some data</h2>
<pre><code>$ psql -U postgres -c &quot;SELECT id FROM test.customer&quot;
                  id
--------------------------------------
 7a24ed2c-c873-4fdf-91cf-3574410acc49
(1 row)

$ psql -U postgres -c &quot;INSERT INTO test.purchase_order (id_customer, purchase_order_number) \
&gt; VALUES ('7a24ed2c-c873-4fdf-91cf-3574410acc49', 'PO12345');&quot;
INSERT 0 1

$ psql -U postgres -c &quot;SELECT * FROM test.purchase_order;&quot;
                  id                  |             id_customer              | purchase_order_number |   status    | frozen_purchase_order |        created_at         |        updated_at         
--------------------------------------+--------------------------------------+-----------------------+-------------+-----------------------+---------------------------+---------------------------
 29e2fa06-edfc-49ed-878b-49e8ded9bb89 | 7a24ed2c-c873-4fdf-91cf-3574410acc49 | PO12345               | requisition |                       | 2017-07-16 21:15:41.81893 | 2017-07-16 21:15:41.81893
(1 row)</code></pre>
<p>Now we add our <code>article</code> with our <code>price</code>.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT * FROM test.article&quot;
                  id                  | article_number |     name     | description | status |         created_at         |         updated_at         
--------------------------------------+----------------+--------------+-------------+--------+----------------------------+----------------------------
 0b177d42-368a-4cfa-bf8d-e863f4e8a1bd | AB12345        | Test article | Test desc   | active | 2017-07-16 21:06:03.668307 | 2017-07-16 21:06:03.668307
(1 row)

$ psql -U postgres -c &quot;SELECT * FROM test.price;&quot;
                  id                  |              id_article              | price | scale_lower_limit | scale_upper_limit | valid_from |  valid_to  | history |         created_at         |         updated_at         
--------------------------------------+--------------------------------------+-------+-------------------+-------------------+------------+------------+---------+----------------------------+----------------------------
 ac73b43d-e5ef-46dd-81e9-94291aa669c7 | 0b177d42-368a-4cfa-bf8d-e863f4e8a1bd |  50.5 |                 1 |        2147483647 | 2017-07-16 | 2018-07-16 |         | 2017-07-16 21:06:03.668307 | 2017-07-16 21:06:03.668307
(1 row)

$ psql -U postgres -c &quot;INSERT INTO test.purchase_order_item (id_purchase_order, id_article, id_price) \
&gt; VALUES ('29e2fa06-edfc-49ed-878b-49e8ded9bb89', '0b177d42-368a-4cfa-bf8d-e863f4e8a1bd', 'ac73b43d-e5ef-46dd-81e9-94291aa669c7')&quot;
INSERT 0 1</code></pre>
<p>Changing the state to <code>ready_to_send</code> will result</p>
<pre><code>$ psql -U postgres -c &quot;SET search_path TO test,public; UPDATE purchase_order SET status = 'ready_to_send' \ 
&gt; WHERE id = '29e2fa06-edfc-49ed-878b-49e8ded9bb89'&quot;
NOTICE:  nothing to do
UPDATE 1</code></pre>
<p>Now we set the state to â€˜sendâ€™</p>
<pre><code>$ psql -U postgres -c &quot;SET search_path TO test,public; UPDATE purchase_order SET status = 'send' \
&gt; WHERE id = '29e2fa06-edfc-49ed-878b-49e8ded9bb89'&quot;
NOTICE:  freeze
UPDATE 1

$ psql -U postgres -c &quot;SELECT * from test.purchase_order&quot; | cat
                  id                  |             id_customer              | purchase_order_number | status |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  frozen_purchase_order                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |        created_at         |        updated_at         
--------------------------------------+--------------------------------------+-----------------------+--------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------+---------------------------
 29e2fa06-edfc-49ed-878b-49e8ded9bb89 | 7a24ed2c-c873-4fdf-91cf-3574410acc49 | PO12345               | send   | {&quot;id&quot;: &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot;, &quot;items&quot;: [{&quot;price&quot;: {&quot;id&quot;: &quot;ac73b43d-e5ef-46dd-81e9-94291aa669c7&quot;, &quot;price&quot;: 50.5, &quot;valid_to&quot;: &quot;2018-07-16&quot;, &quot;valid_from&quot;: &quot;2017-07-16&quot;, &quot;scale_lower_limit&quot;: 1, &quot;scale_upper_limit&quot;: 2147483647}, &quot;amount&quot;: 1, &quot;article&quot;: {&quot;id&quot;: &quot;0b177d42-368a-4cfa-bf8d-e863f4e8a1bd&quot;, &quot;name&quot;: &quot;Test article&quot;, &quot;description&quot;: &quot;Test desc&quot;, &quot;article_number&quot;: &quot;AB12345&quot;}}], &quot;status&quot;: &quot;send&quot;, &quot;changes&quot;: null, &quot;customer&quot;: {&quot;id&quot;: &quot;7a24ed2c-c873-4fdf-91cf-3574410acc49&quot;, &quot;person&quot;: {&quot;id&quot;: &quot;35b40b2f-bf40-4f71-8319-f7757de3e1f4&quot;, &quot;notes&quot;: null, &quot;website&quot;: null, &quot;addresses&quot;: [{&quot;id&quot;: &quot;7a7f1e44-f6a6-495e-893b-e5806289ea81&quot;, &quot;city&quot;: &quot;Dortmund&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44339&quot;, &quot;address_type&quot;: &quot;private&quot;, &quot;house_number&quot;: &quot;123&quot;}, {&quot;id&quot;: &quot;1d8c41e5-bcd6-4842-864d-62c4da2fc506&quot;, &quot;city&quot;: &quot;Bochum&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44866&quot;, &quot;address_type&quot;: &quot;work&quot;, &quot;house_number&quot;: &quot;321&quot;}], &quot;last_name&quot;: &quot;Hake&quot;, &quot;birth_date&quot;: null, &quot;first_name&quot;: &quot;Jan Frederik&quot;, &quot;phone_numbers&quot;: [{&quot;id&quot;: &quot;618d19d6-3daf-4029-8d0f-1535272ec212&quot;, &quot;phone_number&quot;: &quot;+49123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;landline&quot;, &quot;is_primary_phone_number&quot;: true}, {&quot;id&quot;: &quot;81403e1d-1055-4953-8b1a-fcca9d034b1b&quot;, &quot;phone_number&quot;: &quot;+49151123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;cellular_network&quot;, &quot;is_primary_phone_number&quot;: false}], &quot;email_addresses&quot;: [{&quot;id&quot;: &quot;a2f79f62-a497-4bdb-8f1b-03d6b7aacb30&quot;, &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;is_primary_email_address&quot;: false}]}, &quot;customer_number&quot;: &quot;AB123456&quot;}, &quot;created_at&quot;: &quot;2017-07-16T21:15:41.81893&quot;, &quot;updated_at&quot;: &quot;2017-07-16T21:25:03.02978&quot;, &quot;purchase_order_number&quot;: &quot;PO12345&quot;} | 2017-07-16 21:15:41.81893 | 2017-07-16 21:26:44.87835
(1 row)</code></pre>
<p>The frozen purchase order looks like</p>
<pre><code>{
    &quot;id&quot;: &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot;,
    &quot;items&quot;: [{
        &quot;price&quot;: {
            &quot;id&quot;: &quot;ac73b43d-e5ef-46dd-81e9-94291aa669c7&quot;,
            &quot;price&quot;: 50.5,
            &quot;valid_to&quot;: &quot;2018-07-16&quot;,
            &quot;valid_from&quot;: &quot;2017-07-16&quot;,
            &quot;scale_lower_limit&quot;: 1,
            &quot;scale_upper_limit&quot;: 2147483647
        },
        &quot;amount&quot;: 1,
        &quot;article&quot;: {
            &quot;id&quot;: &quot;0b177d42-368a-4cfa-bf8d-e863f4e8a1bd&quot;,
            &quot;name&quot;: &quot;Test article&quot;,
            &quot;description&quot;: &quot;Test desc&quot;,
            &quot;article_number&quot;: &quot;AB12345&quot;
        }
    }],
    &quot;status&quot;: &quot;send&quot;,
    &quot;changes&quot;: null,
    &quot;customer&quot;: {
        &quot;id&quot;: &quot;7a24ed2c-c873-4fdf-91cf-3574410acc49&quot;,
        &quot;person&quot;: {
            &quot;id&quot;: &quot;35b40b2f-bf40-4f71-8319-f7757de3e1f4&quot;,
            &quot;notes&quot;: null,
            &quot;website&quot;: null,
            &quot;addresses&quot;: [{
                &quot;id&quot;: &quot;7a7f1e44-f6a6-495e-893b-e5806289ea81&quot;,
                &quot;city&quot;: &quot;Dortmund&quot;,
                &quot;street&quot;: &quot;Fakestreet&quot;,
                &quot;postal_code&quot;: &quot;44339&quot;,
                &quot;address_type&quot;: &quot;private&quot;,
                &quot;house_number&quot;: &quot;123&quot;
            }, {
                &quot;id&quot;: &quot;1d8c41e5-bcd6-4842-864d-62c4da2fc506&quot;,
                &quot;city&quot;: &quot;Bochum&quot;,
                &quot;street&quot;: &quot;Fakestreet&quot;,
                &quot;postal_code&quot;: &quot;44866&quot;,
                &quot;address_type&quot;: &quot;work&quot;,
                &quot;house_number&quot;: &quot;321&quot;
            }],
            &quot;last_name&quot;: &quot;Hake&quot;,
            &quot;birth_date&quot;: null,
            &quot;first_name&quot;: &quot;Jan Frederik&quot;,
            &quot;phone_numbers&quot;: [{
                &quot;id&quot;: &quot;618d19d6-3daf-4029-8d0f-1535272ec212&quot;,
                &quot;phone_number&quot;: &quot;+49123456789&quot;,
                &quot;communication_type&quot;: &quot;private&quot;,
                &quot;communication_network&quot;: &quot;landline&quot;,
                &quot;is_primary_phone_number&quot;: true
            }, {
                &quot;id&quot;: &quot;81403e1d-1055-4953-8b1a-fcca9d034b1b&quot;,
                &quot;phone_number&quot;: &quot;+49151123456789&quot;,
                &quot;communication_type&quot;: &quot;private&quot;,
                &quot;communication_network&quot;: &quot;cellular_network&quot;,
                &quot;is_primary_phone_number&quot;: false
            }],
            &quot;email_addresses&quot;: [{
                &quot;id&quot;: &quot;a2f79f62-a497-4bdb-8f1b-03d6b7aacb30&quot;,
                &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;,
                &quot;communication_type&quot;: &quot;private&quot;,
                &quot;is_primary_email_address&quot;: false
            }]
        },
        &quot;customer_number&quot;: &quot;AB123456&quot;
    },
    &quot;created_at&quot;: &quot;2017-07-16T21:15:41.81893&quot;,
    &quot;updated_at&quot;: &quot;2017-07-16T21:25:03.02978&quot;,
    &quot;purchase_order_number&quot;: &quot;PO12345&quot;
}</code></pre>
<p>This approach looks promising. In the <a href="2017-08-07-database-architecture-part3.html">next part</a>, we look into updating those structures.</p>

        </section>

        <section id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons Lizenzvertrag" style="border-width:0;vertical-align:middle;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
            </a>
        </section>
    </body>
</html>
