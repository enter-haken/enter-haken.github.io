<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>enter_haken - Generate a ERM from a PostgreSQL database schema</title>
        <!--<link rel="stylesheet" type="text/css" href="/css/default.css" />-->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
        <link rel="stylesheet" type="text/css" href="../css/milligram.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
        <script src="js/vis.min.js"></script>
    </head>
    <body>
        <section id="navigation">
            <a href="../">enter_haken</a>
            <a href="../projects.html">projects</a>
            <a href="../cookbook.html">cookbook</a>
            <a href="../notes.html">notes</a>
            <a href="../read.html">read</a>
            <a href="../about.html">about</a>
        </section>

        <section id="content">
            <h1>Generate a ERM from a PostgreSQL database schema</h1>

<div class="info">
    
    Posted on July 20, 2017
    
        
</div>

<p>Creating a <a href="https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model">ERM</a> is one of the first tasks, when a database is designed. During implementation, you have to sync the model with the schema. This manual task can be very annoying. With some database knowledge and some Linux standard tools, this task can be automated.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="352pt" height="101pt" viewBox="0.00 0.00 352.00 101.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 97)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-97 348,-97 348,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="8,-8 8,-85 96,-85 96,-8 8,-8"></polygon>
<text text-anchor="middle" x="52" y="-69.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">Database</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="116,-8 116,-85 336,-85 336,-8 116,-8"></polygon>
<text text-anchor="middle" x="226" y="-69.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">bash</text>
</g>
<!-- schema -->
<g id="node1" class="node">
<title>schema</title>
<path fill="#ffffff" stroke="#ffffff" d="M76,-54C76,-54 28,-54 28,-54 22,-54 16,-48 16,-42 16,-42 16,-28 16,-28 16,-22 22,-16 28,-16 28,-16 76,-16 76,-16 82,-16 88,-22 88,-28 88,-28 88,-42 88,-42 88,-48 82,-54 76,-54"></path>
<text text-anchor="middle" x="52" y="-38.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">database</text>
<text text-anchor="middle" x="52" y="-23.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">schema</text>
</g>
<!-- awk -->
<g id="node2" class="node">
<title>awk</title>
<path fill="#ffffff" stroke="#ffffff" d="M194,-54C194,-54 136,-54 136,-54 130,-54 124,-48 124,-42 124,-42 124,-28 124,-28 124,-22 130,-16 136,-16 136,-16 194,-16 194,-16 200,-16 206,-22 206,-28 206,-28 206,-42 206,-42 206,-48 200,-54 194,-54"></path>
<text text-anchor="middle" x="165" y="-38.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">awk</text>
<text text-anchor="middle" x="165" y="-23.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing</text>
</g>
<!-- schema&#45;&gt;awk -->
<g id="edge1" class="edge">
<title>schema-&gt;awk</title>
<path fill="none" stroke="#000000" d="M88.0646,-35C96.2353,-35 105.0649,-35 113.7291,-35"></path>
<polygon fill="#000000" stroke="#000000" points="113.7748,-38.5001 123.7748,-35 113.7747,-31.5001 113.7748,-38.5001"></polygon>
</g>
<!-- dot -->
<g id="node3" class="node">
<title>dot</title>
<path fill="#ffffff" stroke="#ffffff" d="M316,-54C316,-54 254,-54 254,-54 248,-54 242,-48 242,-42 242,-42 242,-28 242,-28 242,-22 248,-16 254,-16 254,-16 316,-16 316,-16 322,-16 328,-22 328,-28 328,-28 328,-42 328,-42 328,-48 322,-54 316,-54"></path>
<text text-anchor="middle" x="285" y="-38.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">graphviz</text>
<text text-anchor="middle" x="285" y="-23.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing </text>
</g>
<!-- awk&#45;&gt;dot -->
<g id="edge2" class="edge">
<title>awk-&gt;dot</title>
<path fill="none" stroke="#000000" d="M206.2972,-35C214.491,-35 223.2019,-35 231.7292,-35"></path>
<polygon fill="#000000" stroke="#000000" points="231.9924,-38.5001 241.9924,-35 231.9923,-31.5001 231.9924,-38.5001"></polygon>
</g>
</g>
</svg>
</div>
<!--more-->
<h1 id="get-the-schema">get the schema</h1>
<p>The <a href="https://www.postgresql.org/docs/current/static/information-schema.html">information_schema</a> exists in all databases.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT table_name, column_name, data_type, udt_name \
&gt; FROM information_schema.columns WHERE table_schema = 'test'&quot; | head
       table_name       |       column_name        |          data_type          |       udt_name        
------------------------+--------------------------+-----------------------------+-----------------------
 person_to_email        | id_person                | uuid                        | uuid
 person_to_email        | id_email                 | uuid                        | uuid
 person_to_email        | communication_type       | USER-DEFINED                | communication_type
 person_to_email        | is_primary_email_address | boolean                     | bool
 person_to_email        | created_at               | timestamp without time zone | timestamp
 person_to_email        | updated_at               | timestamp without time zone | timestamp
 person_view            | first_name               | character varying           | varchar
 person_view            | last_name                | character varying           | varchar</code></pre>
<p>These are all the columns from our test schema. We still need some information about references between the relations. For the next processing step, all of the necessary column data should be in one result record.</p>
<p>With the key column constraints</p>
<pre><code>$ psql -U postgres -c &quot;SELECT constraint_name, table_name, column_name \
&gt; FROM information_schema.key_column_usage WHERE table_schema = 'test'&quot; | head
              constraint_name               |       table_name       |      column_name      
--------------------------------------------+------------------------+-----------------------
 person_to_email_id_email_fkey              | person_to_email        | id_email
 person_to_email_id_person_fkey             | person_to_email        | id_person
 person_to_email_pkey                       | person_to_email        | id_person
 person_to_email_pkey                       | person_to_email        | id_email
 person_pkey                                | person                 | id
 address_pkey                               | address                | id
 employee_id_person_fkey                    | employee               | id_person
 employee_pkey                              | employee               | id</code></pre>
<p>and a list of <a href="https://www.postgresql.org/docs/current/static/infoschema-table-constraints.html">table_constraints</a>,</p>
<pre><code>$ psql -U postgres -c &quot;SELECT constraint_name, table_name, constraint_type \
&gt; FROM information_schema.table_constraints WHERE table_schema = 'test' \
&gt; AND constraint_type IN ('FOREIGN KEY','PRIMARY KEY')&quot; | head
              constraint_name               |       table_name       | constraint_type
--------------------------------------------+------------------------+-----------------
 person_pkey                                | person                 | PRIMARY KEY
 address_pkey                               | address                | PRIMARY KEY
 person_to_address_pkey                     | person_to_address      | PRIMARY KEY
 person_to_address_id_person_fkey           | person_to_address      | FOREIGN KEY
 person_to_address_id_address_fkey          | person_to_address      | FOREIGN KEY
 email_pkey                                 | email                  | PRIMARY KEY
 person_to_email_pkey                       | person_to_email        | PRIMARY KEY
 person_to_email_id_person_fkey             | person_to_email        | FOREIGN KEY</code></pre>
<p>we can build our first query.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT c.table_name, 
&gt; c.column_name, 
&gt; c.data_type, 
&gt; c.udt_name,
&gt; is_nullable, 
&gt; c.character_maximum_length,
&gt; (SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc 
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name 
&gt;                 AND c.table_name = kcu.table_name 
&gt;                 AND tc.constraint_type = 'PRIMARY KEY' LIMIT 1
&gt; ) primary_key
&gt; FROM information_schema.columns c 
&gt;         JOIN information_schema.tables t on c.table_name = t.table_name
&gt; WHERE c.table_schema = 'test' AND t.table_type = 'BASE TABLE'&quot; | head
       table_name       |       column_name        |          data_type          |       udt_name        | is_nullable | character_maximum_length | primary_key 
------------------------+--------------------------+-----------------------------+-----------------------+-------------+--------------------------+-------------
 person_to_email        | id_person                | uuid                        | uuid                  | NO          |                          | PRIMARY KEY
 person_to_email        | id_email                 | uuid                        | uuid                  | NO          |                          | PRIMARY KEY
 person_to_email        | communication_type       | USER-DEFINED                | communication_type    | NO          |                          | 
 person_to_email        | is_primary_email_address | boolean                     | bool                  | NO          |                          | 
 person_to_email        | created_at               | timestamp without time zone | timestamp             | NO          |                          | 
 person_to_email        | updated_at               | timestamp without time zone | timestamp             | NO          |                          | 
 person                 | id                       | uuid                        | uuid                  | NO          |                          | PRIMARY KEY
 person                 | first_name               | character varying           | varchar               | YES         |                      512 | </code></pre>
<p>Now we need the foreign keys and the target of the relation. These information can be fetched from the <a href="https://www.postgresql.org/docs/current/static/infoschema-constraint-column-usage.html">constraint_column_usage view</a>.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT table_name, column_name, constraint_name FROM information_schema.constraint_column_usage \
&gt; WHERE table_schema = 'test'&quot; | head
       table_name       |      column_name      |              constraint_name               
------------------------+-----------------------+--------------------------------------------
 person                 | id                    | person_pkey
 address                | id                    | address_pkey
 person_to_address      | id_person             | person_to_address_pkey
 person_to_address      | id_address            | person_to_address_pkey
 person                 | id                    | person_to_address_id_person_fkey
 address                | id                    | person_to_address_id_address_fkey
 email                  | id                    | email_pkey
 person_to_email        | id_person             | person_to_email_pkey</code></pre>
<p>With this we are coming to our next query.</p>
<pre><code>$  psql -U postgres -c &quot;SELECT c.table_name,
&gt; c.column_name,
&gt; c.data_type,
&gt; c.udt_name,
&gt; c.is_nullable,
&gt; c.character_maximum_length,
&gt; (SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name
&gt;                 AND c.table_name = kcu.table_name
&gt;                 AND tc.constraint_type = 'PRIMARY KEY' LIMIT 1
&gt; ) primary_key,
&gt; (SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name
&gt;                 AND c.table_name = kcu.table_name
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) foreign_key,
&gt; (SELECT ccu.table_name FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         JOIN information_schema.constraint_column_usage ccu
&gt;                 ON tc.constraint_name = ccu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name
&gt;                 AND c.table_name = kcu.table_name
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) reference_table,
&gt; (SELECT ccu.column_name FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         JOIN information_schema.constraint_column_usage ccu
&gt;                 ON tc.constraint_name = ccu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name
&gt;                 AND c.table_name = kcu.table_name
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) reference_column
&gt;
&gt; FROM information_schema.columns c
&gt;         JOIN information_schema.tables t on c.table_name = t.table_name
&gt; WHERE c.table_schema = 'test' AND t.table_type = 'BASE TABLE'&quot; | head
       table_name       |       column_name        |          data_type          |       udt_name        | is_nullable | character_maximum_length | primary_key | foreign_key | reference_table | reference_column
------------------------+--------------------------+-----------------------------+-----------------------+-------------+--------------------------+-------------+-------------+-----------------+------------------
 person_to_email        | id_person                | uuid                        | uuid                  | NO          |                          | PRIMARY KEY | FOREIGN KEY | person          | id
 person_to_email        | id_email                 | uuid                        | uuid                  | NO          |                          | PRIMARY KEY | FOREIGN KEY | email           | id
 person_to_email        | communication_type       | USER-DEFINED                | communication_type    | NO          |                          |             |             |                 |
 person_to_email        | is_primary_email_address | boolean                     | bool                  | NO          |                          |             |             |                 |
 person_to_email        | created_at               | timestamp without time zone | timestamp             | NO          |                          |             |             |                 |
 person_to_email        | updated_at               | timestamp without time zone | timestamp             | NO          |                          |             |             |                 |
 person                 | id                       | uuid                        | uuid                  | NO          |                          | PRIMARY KEY |             |                 |
 person                 | first_name               | character varying           | varchar               | YES         |                      512 |             |             |                 |</code></pre>
<p>There is one thing left. It would be nice, if you can see the enum values within the ERM. Let’s look, what we can do about it.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT e.enumlabel, t.typname FROM pg_type t \
&gt; JOIN pg_enum e ON t.oid = e.enumtypid \
&gt; JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace&quot;  | head
       enumlabel        |        typname
------------------------+-----------------------
 work                   | address_type
 invoice                | address_type
 delivery               | address_type
 private                | address_type
 organization           | communication_type
 private                | communication_type
 work                   | communication_type
 cellular_network       | communication_network</code></pre>
<p>This can be matched on the column <code>udt_name</code>.</p>
<p>Now we have our final SQL statement for now.</p>
<pre><code>$ psql -U postgres -c &quot;SELECT c.table_name, 
&gt; c.column_name, 
&gt; c.data_type, 
&gt; c.udt_name,
&gt; (SELECT string_agg(e.enumlabel::TEXT, ', ')
&gt;         FROM pg_type t 
&gt;            JOIN pg_enum e on t.oid = e.enumtypid  
&gt;            JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace WHERE t.typname = c.udt_name) enum_values,
&gt; c.is_nullable, 
&gt; c.character_maximum_length,
&gt; (SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc 
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name 
&gt;                 AND c.table_name = kcu.table_name 
&gt;                 AND tc.constraint_type = 'PRIMARY KEY' LIMIT 1
&gt; ) primary_key,
&gt; (SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc 
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name 
&gt;                 AND c.table_name = kcu.table_name 
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) foreign_key,
&gt; (SELECT ccu.table_name FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc 
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         JOIN information_schema.constraint_column_usage ccu
&gt;                 ON tc.constraint_name = ccu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name 
&gt;                 AND c.table_name = kcu.table_name 
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) reference_table,
&gt; (SELECT ccu.column_name FROM information_schema.key_column_usage kcu
&gt;         JOIN information_schema.table_constraints tc 
&gt;                 ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
&gt;         JOIN information_schema.constraint_column_usage ccu
&gt;                 ON tc.constraint_name = ccu.constraint_name
&gt;         WHERE c.column_name = kcu.column_name 
&gt;                 AND c.table_name = kcu.table_name 
&gt;                 AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
&gt; ) reference_column
&gt; 
&gt; FROM information_schema.columns c 
&gt;         JOIN information_schema.tables t on c.table_name = t.table_name
&gt; WHERE c.table_schema = 'test' AND t.table_type = 'BASE TABLE'&quot; | head
       table_name       |       column_name        |          data_type          |       udt_name        |                                     enum_values                                     | is_nullable | character_maximum_length | primary_key | foreign_key | reference_table | reference_column 
------------------------+--------------------------+-----------------------------+-----------------------+-------------------------------------------------------------------------------------+-------------+--------------------------+-------------+-------------+-----------------+------------------
 person_to_email        | id_person                | uuid                        | uuid                  |                                                                                     | NO          |                          | PRIMARY KEY | FOREIGN KEY | person          | id
 person_to_email        | id_email                 | uuid                        | uuid                  |                                                                                     | NO          |                          | PRIMARY KEY | FOREIGN KEY | email           | id
 person_to_email        | communication_type       | USER-DEFINED                | communication_type    | work, private, organization                                                         | NO          |                          |             |             |                 | 
 person_to_email        | is_primary_email_address | boolean                     | bool                  |                                                                                     | NO          |                          |             |             |                 | 
 person_to_email        | created_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 | 
 person_to_email        | updated_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 | 
 person                 | id                       | uuid                        | uuid                  |                                                                                     | NO          |                          | PRIMARY KEY |             |                 | 
 person                 | first_name               | character varying           | varchar               |                                                                                     | YES         |                      512 |             |             |                 | </code></pre>
<p>The <code>string_agg</code> function is used to concentrate the enum values.</p>
<h1 id="a-look-ahead">a look ahead</h1>
<p>Before starting to work with the raw schema data, we take a look at our goal. We use graphviz for drawing the ERM. My goal is to get close to a ERM visualization.</p>
<pre><code>digraph {
    node [shape=Mrecord; fontname=&quot;Courier New&quot; style=&quot;filled, bold&quot; fillcolor=&quot;white&quot;, fontcolor=&quot;black&quot;];
    customer [shape=plaintext; label=&lt;
     &lt;TABLE BORDER=&quot;1&quot; CELLBORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;3&quot;&gt;
     &lt;TR&gt;
        &lt;TD COLSPAN=&quot;5&quot; BGCOLOR=&quot;black&quot;&gt;&lt;FONT color=&quot;white&quot;&gt;&lt;B&gt;customer&lt;/B&gt;&lt;/FONT&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD&gt;column&lt;/TD&gt;
        &lt;TD&gt;type&lt;/TD&gt;
        &lt;TD&gt;nullable&lt;/TD&gt;
        &lt;TD&gt;PK&lt;/TD&gt;
        &lt;TD&gt;FK&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f1&quot;&gt;id&lt;/TD&gt;
        &lt;TD&gt;uuid&lt;/TD&gt;
        &lt;TD&gt;NO&lt;/TD&gt;
        &lt;TD&gt;PRIMARY KEY&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f2&quot;&gt;id_person&lt;/TD&gt;
        &lt;TD&gt;uuid&lt;/TD&gt;
        &lt;TD&gt;NO&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
        &lt;TD&gt;FOREIGN KEY&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f3&quot;&gt;customer_number&lt;/TD&gt;
        &lt;TD&gt;varchar&lt;/TD&gt;
        &lt;TD&gt;NO&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f4&quot;&gt;json_view&lt;/TD&gt;
        &lt;TD&gt;jsonb&lt;/TD&gt;
        &lt;TD&gt;YES&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f5&quot;&gt;created_at&lt;/TD&gt;
        &lt;TD&gt;timestamp&lt;/TD&gt;
        &lt;TD&gt;NO&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;TR&gt;
        &lt;TD port=&quot;f6&quot;&gt;updated_at&lt;/TD&gt;
        &lt;TD&gt;timestamp&lt;/TD&gt;
        &lt;TD&gt;NO&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
        &lt;TD&gt;&lt;/TD&gt;
     &lt;/TR&gt;
     &lt;/TABLE&gt;&gt;]
}</code></pre>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="504pt" height="186pt" viewBox="0.00 0.00 504.00 186.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 182)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-182 500,-182 500,4 -4,4"></polygon>
<!-- customer -->
<g id="node1" class="node">
<title>customer</title>
<polygon fill="#ffffff" stroke="transparent" stroke-width="2" points="496,-178 0,-178 0,0 496,0 496,-178"></polygon>
<polygon fill="#000000" stroke="transparent" points="9,-152 9,-173 487,-173 487,-152 9,-152"></polygon>
<text text-anchor="start" x="214.5" y="-159.8" font-family="Courier New" font-weight="bold" font-size="14.00" fill="#ffffff">customer</text>
<text text-anchor="start" x="49" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">column</text>
<text text-anchor="start" x="162.5" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">type</text>
<text text-anchor="start" x="223" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">nullable</text>
<text text-anchor="start" x="333" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">PK</text>
<text text-anchor="start" x="430" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">FK</text>
<text text-anchor="start" x="65.5" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">id</text>
<text text-anchor="start" x="162.5" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="248" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="296" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">PRIMARY KEY</text>
<text text-anchor="start" x="36.5" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">id_person</text>
<text text-anchor="start" x="162.5" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="248" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="393" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">FOREIGN KEY</text>
<text text-anchor="start" x="12" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">customer_number</text>
<text text-anchor="start" x="150.5" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="248" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="36.5" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">json_view</text>
<text text-anchor="start" x="158.5" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="244" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="32.5" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">created_at</text>
<text text-anchor="start" x="142" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="248" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="32.5" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">updated_at</text>
<text text-anchor="start" x="142" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="248" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<polygon fill="none" stroke="#000000" points="8,-4 8,-174 488,-174 488,-4 8,-4"></polygon>
</g>
</g>
</svg>
</div>
<p>The table column layout fits our needs for our relation. The <code>port</code> attribute is important for the edges.</p>
<p>If we have a <code>person</code> and a <code>customer</code>, adding</p>
<pre><code>customer -&gt; person;</code></pre>
<p>will create an edge for these relations.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="504pt" height="463pt" viewBox="0.00 0.00 504.00 463.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 459)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-459 500,-459 500,4 -4,4"></polygon>
<!-- person -->
<g id="node1" class="node">
<title>person</title>
<polygon fill="#ffffff" stroke="transparent" stroke-width="2" points="438.5,-241 57.5,-241 57.5,0 438.5,0 438.5,-241"></polygon>
<polygon fill="#000000" stroke="transparent" points="67,-214.5 67,-235.5 430,-235.5 430,-214.5 67,-214.5"></polygon>
<text text-anchor="start" x="223.5" y="-222.3" font-family="Courier New" font-weight="bold" font-size="14.00" fill="#ffffff">person</text>
<text text-anchor="start" x="86.5" y="-200.3" font-family="Courier New" font-size="14.00" fill="#000000">column</text>
<text text-anchor="start" x="179.5" y="-200.3" font-family="Courier New" font-size="14.00" fill="#000000">type</text>
<text text-anchor="start" x="240" y="-200.3" font-family="Courier New" font-size="14.00" fill="#000000">nullable</text>
<text text-anchor="start" x="350" y="-200.3" font-family="Courier New" font-size="14.00" fill="#000000">PK</text>
<text text-anchor="start" x="410" y="-200.3" font-family="Courier New" font-size="14.00" fill="#000000">FK</text>
<text text-anchor="start" x="103" y="-179.3" font-family="Courier New" font-size="14.00" fill="#000000">id</text>
<text text-anchor="start" x="179.5" y="-179.3" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="265" y="-179.3" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="313" y="-179.3" font-family="Courier New" font-size="14.00" fill="#000000">PRIMARY KEY</text>
<text text-anchor="start" x="70" y="-158.3" font-family="Courier New" font-size="14.00" fill="#000000">first_name</text>
<text text-anchor="start" x="167.5" y="-158.3" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="261" y="-158.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="74" y="-137.3" font-family="Courier New" font-size="14.00" fill="#000000">last_name</text>
<text text-anchor="start" x="167.5" y="-137.3" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="261" y="-137.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="70" y="-116.3" font-family="Courier New" font-size="14.00" fill="#000000">birth_date</text>
<text text-anchor="start" x="179.5" y="-116.3" font-family="Courier New" font-size="14.00" fill="#000000">date</text>
<text text-anchor="start" x="261" y="-116.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="90.5" y="-95.3" font-family="Courier New" font-size="14.00" fill="#000000">notes</text>
<text text-anchor="start" x="167.5" y="-95.3" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="261" y="-95.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="82.5" y="-74.3" font-family="Courier New" font-size="14.00" fill="#000000">website</text>
<text text-anchor="start" x="167.5" y="-74.3" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="261" y="-74.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="74" y="-53.3" font-family="Courier New" font-size="14.00" fill="#000000">json_view</text>
<text text-anchor="start" x="175.5" y="-53.3" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="261" y="-53.3" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="70" y="-32.3" font-family="Courier New" font-size="14.00" fill="#000000">created_at</text>
<text text-anchor="start" x="159" y="-32.3" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="265" y="-32.3" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="70" y="-11.3" font-family="Courier New" font-size="14.00" fill="#000000">updated_at</text>
<text text-anchor="start" x="159" y="-11.3" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="265" y="-11.3" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<polygon fill="none" stroke="#000000" points="65.5,-4 65.5,-237 430.5,-237 430.5,-4 65.5,-4"></polygon>
</g>
<!-- customer -->
<g id="node2" class="node">
<title>customer</title>
<polygon fill="#ffffff" stroke="transparent" stroke-width="2" points="496,-455 0,-455 0,-277 496,-277 496,-455"></polygon>
<polygon fill="#000000" stroke="transparent" points="9,-429 9,-450 487,-450 487,-429 9,-429"></polygon>
<text text-anchor="start" x="214.5" y="-436.8" font-family="Courier New" font-weight="bold" font-size="14.00" fill="#ffffff">customer</text>
<text text-anchor="start" x="49" y="-414.8" font-family="Courier New" font-size="14.00" fill="#000000">column</text>
<text text-anchor="start" x="162.5" y="-414.8" font-family="Courier New" font-size="14.00" fill="#000000">type</text>
<text text-anchor="start" x="223" y="-414.8" font-family="Courier New" font-size="14.00" fill="#000000">nullable</text>
<text text-anchor="start" x="333" y="-414.8" font-family="Courier New" font-size="14.00" fill="#000000">PK</text>
<text text-anchor="start" x="430" y="-414.8" font-family="Courier New" font-size="14.00" fill="#000000">FK</text>
<text text-anchor="start" x="65.5" y="-393.8" font-family="Courier New" font-size="14.00" fill="#000000">id</text>
<text text-anchor="start" x="162.5" y="-393.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="248" y="-393.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="296" y="-393.8" font-family="Courier New" font-size="14.00" fill="#000000">PRIMARY KEY</text>
<text text-anchor="start" x="36.5" y="-372.8" font-family="Courier New" font-size="14.00" fill="#000000">id_person</text>
<text text-anchor="start" x="162.5" y="-372.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="248" y="-372.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="393" y="-372.8" font-family="Courier New" font-size="14.00" fill="#000000">FOREIGN KEY</text>
<text text-anchor="start" x="12" y="-351.8" font-family="Courier New" font-size="14.00" fill="#000000">customer_number</text>
<text text-anchor="start" x="150.5" y="-351.8" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="248" y="-351.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="36.5" y="-330.8" font-family="Courier New" font-size="14.00" fill="#000000">json_view</text>
<text text-anchor="start" x="158.5" y="-330.8" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="244" y="-330.8" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="32.5" y="-309.8" font-family="Courier New" font-size="14.00" fill="#000000">created_at</text>
<text text-anchor="start" x="142" y="-309.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="248" y="-309.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="32.5" y="-288.8" font-family="Courier New" font-size="14.00" fill="#000000">updated_at</text>
<text text-anchor="start" x="142" y="-288.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="248" y="-288.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<polygon fill="none" stroke="#000000" points="8,-281 8,-451 488,-451 488,-281 8,-281"></polygon>
</g>
<!-- customer&#45;&gt;person -->
<g id="edge1" class="edge">
<title>customer-&gt;person</title>
<path fill="none" stroke="#000000" d="M248,-276.6744C248,-268.3971 248,-259.9002 248,-251.3508"></path>
<polygon fill="#000000" stroke="#000000" points="251.5001,-251.3002 248,-241.3003 244.5001,-251.3003 251.5001,-251.3002"></polygon>
</g>
</g>
</svg>
</div>
<h1 id="preparations">preparations</h1>
<p>First we export the schema to a file (e.g. <code>schema.txt</code>). This file will be used for the awk processing.</p>
<p>The first two lines of the head</p>
<pre><code>$ head -n 5 schema.txt
       table_name       |       column_name        |          data_type          |       udt_name        |                                     enum_values                                     | is_nullable | character_maximum_length | primary_key | foreign_key | reference_table | reference_column 
------------------------+--------------------------+-----------------------------+-----------------------+-------------------------------------------------------------------------------------+-------------+--------------------------+-------------+-------------+-----------------+------------------
 person                 | id                       | uuid                        | uuid                  |                                                                                     | NO          |                          | PRIMARY KEY |             |                 | 
 person                 | first_name               | character varying           | varchar               |                                                                                     | YES         |                      512 |             |             |                 | 
 person                 | last_name                | character varying           | varchar               |                                                                                     | YES         |                      512 |             |             |                 | </code></pre>
<p>must be removed. This can be done by</p>
<pre><code>$ head -n5 schema.txt | tail -n+3
 person                 | id                       | uuid                        | uuid                  |                                                                                     | NO          |                          | PRIMARY KEY |             |                 | 
 person                 | first_name               | character varying           | varchar               |                                                                                     | YES         |                      512 |             |             |                 | 
 person                 | last_name                | character varying           | varchar               |                                                                                     | YES         |                      512 |             |             |                 | </code></pre>
<p>The last two lines (one blank line) of the tail</p>
<pre><code> article                | status                   | USER-DEFINED                | article_status        | active, inactive                                                                    | NO          |                          |             |             |                 |
 article                | created_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 |
 article                | updated_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 |
(109 Zeilen)
    </code></pre>
<p>can be removed with</p>
<pre><code>$ tail -n 5 schema.txt | head -n -2
 article                | status                   | USER-DEFINED                | article_status        | active, inactive                                                                    | NO          |                          |             |             |                 |
 article                | created_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 |
 article                | updated_at               | timestamp without time zone | timestamp             |                                                                                     | NO          |                          |             |             |                 |</code></pre>
<p>Now we have a record in every line.</p>
<h1 id="get-started-with-awk">get started with awk</h1>
<p>An awk program has the following structure.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="277pt" height="44pt" viewBox="0.00 0.00 277.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>%3</title>
<polygon fill="#d3d3d3" stroke="transparent" points="-4,4 -4,-40 273,-40 273,4 -4,4"></polygon>
<!-- begin -->
<g id="node1" class="node">
<title>begin</title>
<path fill="#ffffff" stroke="#ffffff" d="M47,-36C47,-36 12,-36 12,-36 6,-36 0,-30 0,-24 0,-24 0,-12 0,-12 0,-6 6,0 12,0 12,0 47,0 47,0 53,0 59,-6 59,-12 59,-12 59,-24 59,-24 59,-30 53,-36 47,-36"></path>
<text text-anchor="middle" x="29.5" y="-14.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">BEGIN</text>
</g>
<!-- middle -->
<g id="node2" class="node">
<title>middle</title>
<path fill="#ffffff" stroke="#ffffff" d="M167,-36C167,-36 107,-36 107,-36 101,-36 95,-30 95,-24 95,-24 95,-12 95,-12 95,-6 101,0 107,0 107,0 167,0 167,0 173,0 179,-6 179,-12 179,-12 179,-24 179,-24 179,-30 173,-36 167,-36"></path>
<text text-anchor="middle" x="137" y="-14.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">middle part</text>
</g>
<!-- begin&#45;&gt;middle -->
<g id="edge1" class="edge">
<title>begin-&gt;middle</title>
<path fill="none" stroke="#000000" d="M59.1594,-18C67.1104,-18 75.9481,-18 84.7329,-18"></path>
<polygon fill="#000000" stroke="#000000" points="84.965,-21.5001 94.965,-18 84.965,-14.5001 84.965,-21.5001"></polygon>
</g>
<!-- end -->
<g id="node3" class="node">
<title>end</title>
<path fill="#ffffff" stroke="#ffffff" d="M257,-36C257,-36 227,-36 227,-36 221,-36 215,-30 215,-24 215,-24 215,-12 215,-12 215,-6 221,0 227,0 227,0 257,0 257,0 263,0 269,-6 269,-12 269,-12 269,-24 269,-24 269,-30 263,-36 257,-36"></path>
<text text-anchor="middle" x="242" y="-14.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">END</text>
</g>
<!-- middle&#45;&gt;end -->
<g id="edge2" class="edge">
<title>middle-&gt;end</title>
<path fill="none" stroke="#000000" d="M179.1025,-18C187.6072,-18 196.491,-18 204.8124,-18"></path>
<polygon fill="#000000" stroke="#000000" points="204.9812,-21.5001 214.9812,-18 204.9812,-14.5001 204.9812,-21.5001"></polygon>
</g>
</g>
</svg>
</div>
<p>The BEGIN and the END part is executed once. The middle part is executed for every data record.</p>
<p>The BEGIN part introduces the graph.</p>
<pre><code>BEGIN {
    print(&quot;digraph {&quot;)
    print(&quot;graph [overlap=false;splines=true;regular=true];&quot;)
    print(&quot;node [shape=Mrecord; fontname=\&quot;Courier New\&quot; style=\&quot;filled, bold\&quot; fillcolor=\&quot;white\&quot;, fontcolor=\&quot;black\&quot;];&quot;)
}</code></pre>
<p>The middle part must print every graphviz table for every relation in the schema.</p>
<pre><code>{
   if (length(currentTableName) &gt; 0 &amp;&amp; $1 != currentTableName) {
       print(&quot;&lt;/TABLE&gt;&gt;]&quot;)
   }
 
   if ($1 != currentTableName) {
        print(&quot;&quot;)
        print(trim($1) &quot; [shape=plaintext; label=&lt;&quot;)
        print(&quot;&lt;TABLE BORDER=\&quot;1\&quot; CELLBORDER=\&quot;0\&quot; CELLSPACING=\&quot;0\&quot; CELLPADDING=\&quot;3\&quot;&gt;&quot;)
        print(&quot;&lt;TR&gt;&quot;)
        print(&quot;&lt;TD COLSPAN=\&quot;5\&quot; BGCOLOR=\&quot;black\&quot;&gt;&lt;FONT color=\&quot;white\&quot;&gt;&lt;B&gt;&quot; trim($1) &quot;&lt;/B&gt;&lt;/FONT&gt;&lt;/TD&gt;&quot;)
        print(&quot;&lt;/TR&gt;&quot;)

        print(&quot;&lt;TR&gt;&quot;)
        print(&quot;&lt;TD&gt;column&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;type&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;nullable&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;PK&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;FK&lt;/TD&gt;&quot;)
        print(&quot;&lt;/TR&gt;&quot;)
        port = 0
    }

    print(&quot;&lt;TR&gt;&quot;)
    print(&quot;&lt;TD port=\&quot;f&quot; ++port &quot;\&quot;&gt;&quot;trim($2)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($4)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($6)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($8)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($9)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;/TR&gt;&quot;)

    currentTableName = $1
}</code></pre>
<p>The END part closes the last TABLE and closes the graph.</p>
<pre><code>END {
    print(&quot;&lt;/TABLE&gt;&gt;]&quot;)
    print(&quot;}&quot;)
}</code></pre>
<p>This script will generate graphviz tables for all relations in the database schema.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="1126pt" height="228pt" viewBox="0.00 0.00 1126.00 228.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 224)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-224 1122,-224 1122,4 -4,4"></polygon>
<!-- purchase_order -->
<g id="node1" class="node">
<title>purchase_order</title>
<polygon fill="#ffffff" stroke="transparent" stroke-width="2" points="645,-220 0,-220 0,0 645,0 645,-220"></polygon>
<polygon fill="#000000" stroke="transparent" points="9.5,-194 9.5,-215 636.5,-215 636.5,-194 9.5,-194"></polygon>
<text text-anchor="start" x="265" y="-201.8" font-family="Courier New" font-weight="bold" font-size="14.00" fill="#ffffff">purchase_order</text>
<text text-anchor="start" x="74.5" y="-179.8" font-family="Courier New" font-size="14.00" fill="#000000">column</text>
<text text-anchor="start" x="262.5" y="-179.8" font-family="Courier New" font-size="14.00" fill="#000000">type</text>
<text text-anchor="start" x="372.5" y="-179.8" font-family="Courier New" font-size="14.00" fill="#000000">nullable</text>
<text text-anchor="start" x="482.5" y="-179.8" font-family="Courier New" font-size="14.00" fill="#000000">PK</text>
<text text-anchor="start" x="579.5" y="-179.8" font-family="Courier New" font-size="14.00" fill="#000000">FK</text>
<text text-anchor="start" x="91" y="-158.8" font-family="Courier New" font-size="14.00" fill="#000000">id</text>
<text text-anchor="start" x="262.5" y="-158.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="397.5" y="-158.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="445.5" y="-158.8" font-family="Courier New" font-size="14.00" fill="#000000">PRIMARY KEY</text>
<text text-anchor="start" x="54" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">id_customer</text>
<text text-anchor="start" x="262.5" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="397.5" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="542.5" y="-137.8" font-family="Courier New" font-size="14.00" fill="#000000">FOREIGN KEY</text>
<text text-anchor="start" x="12.5" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">purchase_order_number</text>
<text text-anchor="start" x="250.5" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">varchar</text>
<text text-anchor="start" x="397.5" y="-116.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="74.5" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">status</text>
<text text-anchor="start" x="192.5" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">purchase_order_status</text>
<text text-anchor="start" x="397.5" y="-95.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="12.5" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">frozen_purchase_order</text>
<text text-anchor="start" x="258.5" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="393.5" y="-74.8" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="70.5" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">changes</text>
<text text-anchor="start" x="258.5" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="393.5" y="-53.8" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="58" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">created_at</text>
<text text-anchor="start" x="242" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="397.5" y="-32.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="58" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">updated_at</text>
<text text-anchor="start" x="242" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="397.5" y="-11.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<polygon fill="none" stroke="#000000" points="8,-4 8,-216 637,-216 637,-4 8,-4"></polygon>
</g>
<!-- purchase_order_item -->
<g id="node2" class="node">
<title>purchase_order_item</title>
<polygon fill="#ffffff" stroke="transparent" stroke-width="2" points="1118,-209.5 663,-209.5 663,-10.5 1118,-10.5 1118,-209.5"></polygon>
<polygon fill="#000000" stroke="transparent" points="672.5,-183 672.5,-204 1109.5,-204 1109.5,-183 672.5,-183"></polygon>
<text text-anchor="start" x="812.5" y="-190.8" font-family="Courier New" font-weight="bold" font-size="14.00" fill="#ffffff">purchase_order_item</text>
<text text-anchor="start" x="692" y="-168.8" font-family="Courier New" font-size="14.00" fill="#000000">column</text>
<text text-anchor="start" x="785" y="-168.8" font-family="Courier New" font-size="14.00" fill="#000000">type</text>
<text text-anchor="start" x="845.5" y="-168.8" font-family="Courier New" font-size="14.00" fill="#000000">nullable</text>
<text text-anchor="start" x="955.5" y="-168.8" font-family="Courier New" font-size="14.00" fill="#000000">PK</text>
<text text-anchor="start" x="1052.5" y="-168.8" font-family="Courier New" font-size="14.00" fill="#000000">FK</text>
<text text-anchor="start" x="708.5" y="-147.8" font-family="Courier New" font-size="14.00" fill="#000000">id</text>
<text text-anchor="start" x="785" y="-147.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="870.5" y="-147.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="918.5" y="-147.8" font-family="Courier New" font-size="14.00" fill="#000000">PRIMARY KEY</text>
<text text-anchor="start" x="675.5" y="-126.8" font-family="Courier New" font-size="14.00" fill="#000000">id_article</text>
<text text-anchor="start" x="785" y="-126.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="870.5" y="-126.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="1015.5" y="-126.8" font-family="Courier New" font-size="14.00" fill="#000000">FOREIGN KEY</text>
<text text-anchor="start" x="683.5" y="-105.8" font-family="Courier New" font-size="14.00" fill="#000000">id_price</text>
<text text-anchor="start" x="785" y="-105.8" font-family="Courier New" font-size="14.00" fill="#000000">uuid</text>
<text text-anchor="start" x="870.5" y="-105.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="1015.5" y="-105.8" font-family="Courier New" font-size="14.00" fill="#000000">FOREIGN KEY</text>
<text text-anchor="start" x="692" y="-84.8" font-family="Courier New" font-size="14.00" fill="#000000">amount</text>
<text text-anchor="start" x="785" y="-84.8" font-family="Courier New" font-size="14.00" fill="#000000">int4</text>
<text text-anchor="start" x="870.5" y="-84.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="688" y="-63.8" font-family="Courier New" font-size="14.00" fill="#000000">changes</text>
<text text-anchor="start" x="781" y="-63.8" font-family="Courier New" font-size="14.00" fill="#000000">jsonb</text>
<text text-anchor="start" x="866.5" y="-63.8" font-family="Courier New" font-size="14.00" fill="#000000">YES</text>
<text text-anchor="start" x="675.5" y="-42.8" font-family="Courier New" font-size="14.00" fill="#000000">created_at</text>
<text text-anchor="start" x="764.5" y="-42.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="870.5" y="-42.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<text text-anchor="start" x="675.5" y="-21.8" font-family="Courier New" font-size="14.00" fill="#000000">updated_at</text>
<text text-anchor="start" x="764.5" y="-21.8" font-family="Courier New" font-size="14.00" fill="#000000">timestamp</text>
<text text-anchor="start" x="870.5" y="-21.8" font-family="Courier New" font-size="14.00" fill="#000000">NO</text>
<polygon fill="none" stroke="#000000" points="671,-14.5 671,-205.5 1110,-205.5 1110,-14.5 671,-14.5"></polygon>
</g>
</g>
</svg>
</div>
<p>For the edges, the middle part must be extended with</p>
<pre><code>if (trim($9) == &quot;FOREIGN KEY&quot;) {
    edges[++edgeCounter] = trim($1) &quot; -&gt; &quot; trim($10) &quot;;&quot;
}</code></pre>
<p>This takes the current table name and point it to the target relation.</p>
<p>Some relations use a enum as a datatype. It would be nice, if this could be visible in the ERM.</p>
<pre><code>if (length(trim($5)) &gt; 0) {
    nodes[++nodeCounter] = trim($4) &quot;[shape=\&quot;box\&quot;, style=\&quot;rounded\&quot;, label=&lt;&lt;B&gt;&quot; trim($4) &quot; (enum)&lt;/B&gt;&lt;BR/&gt;&quot; trim($5) &quot;&gt;];&quot;
    edges[++edgeCounter] = trim($1) &quot;:f&quot; port &quot; -&gt; &quot; trim($4) &quot;;&quot;
}</code></pre>
<p>This adds new enum nodes to the graph and points it directly to the column used by the enum.</p>
<p>In the END part, the new nodes and edges must be added.</p>
<pre><code>for (node in nodes) {
    print(nodes[++i])
}
i = 0
for (edge in edges){
    print(edges[++i])
}</code></pre>
<p>Currently the enum values are comma separated. For the graph drawing it is easier, to have short lines.</p>
<p>A <code>sed 's/, /&lt;BR\/&gt;/g'</code> before script start will replace the commas with <code>&lt;BR/&gt;</code>.</p>
<h1 id="final">final</h1>
<p>The complete script glued together</p>
<pre><code>#!/bin/bash

psql -U postgres -c &quot;

SELECT c.table_name, 
	c.column_name, 
	c.data_type, 
	c.udt_name,
	(SELECT string_agg(e.enumlabel::TEXT, ', ')
		FROM pg_type t 
		   JOIN pg_enum e on t.oid = e.enumtypid  
		   JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace WHERE t.typname = c.udt_name) enum_values,
	c.is_nullable, 
	c.character_maximum_length,
	(SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
		JOIN information_schema.table_constraints tc 
			ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
		WHERE c.column_name = kcu.column_name 
			AND c.table_name = kcu.table_name 
			AND tc.constraint_type = 'PRIMARY KEY' LIMIT 1
	) primary_key,
	(SELECT tc.constraint_type FROM information_schema.key_column_usage kcu
		JOIN information_schema.table_constraints tc 
			ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
		WHERE c.column_name = kcu.column_name 
			AND c.table_name = kcu.table_name 
			AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
	) foreign_key,
	(SELECT ccu.table_name FROM information_schema.key_column_usage kcu
		JOIN information_schema.table_constraints tc 
			ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
		JOIN information_schema.constraint_column_usage ccu
			ON tc.constraint_name = ccu.constraint_name
		WHERE c.column_name = kcu.column_name 
			AND c.table_name = kcu.table_name 
			AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
	) reference_table,
	(SELECT ccu.column_name FROM information_schema.key_column_usage kcu
		JOIN information_schema.table_constraints tc 
			ON tc.table_name = c.table_name AND tc.constraint_name = kcu.constraint_name
		JOIN information_schema.constraint_column_usage ccu
			ON tc.constraint_name = ccu.constraint_name
		WHERE c.column_name = kcu.column_name 
			AND c.table_name = kcu.table_name 
			AND tc.constraint_type = 'FOREIGN KEY' LIMIT 1
	) reference_column
	
FROM information_schema.columns c 
	JOIN information_schema.tables t on c.table_name = t.table_name
WHERE c.table_schema = 'test' AND t.table_type = 'BASE TABLE'&quot; | sed 's/, /&lt;BR\/&gt;/g' | head -n -2 | tail -n+3 | awk -F&quot;|&quot; '
function ltrim(s) {
    sub(/^[ \t\r\n]+/, &quot;&quot;, s);
    return s
}

function rtrim(s) {
    sub(/[ \t\r\n]+$/, &quot;&quot;, s);
    return s
}

function trim(s) {
    return rtrim(ltrim(s));
}

BEGIN {
    print(&quot;digraph {&quot;)
    print(&quot;graph [overlap=false;splines=true;regular=true];&quot;)
    print(&quot;node [shape=Mrecord; fontname=\&quot;Courier New\&quot; style=\&quot;filled, bold\&quot; fillcolor=\&quot;white\&quot;, fontcolor=\&quot;black\&quot;];&quot;)
}

{
   if (length(currentTableName) &gt; 0 &amp;&amp; $1 != currentTableName) {
       print(&quot;&lt;/TABLE&gt;&gt;]&quot;)
   }
 
   if ($1 != currentTableName) {
        print(&quot;&quot;)
        print(trim($1) &quot; [shape=plaintext; label=&lt;&quot;)
        print(&quot;&lt;TABLE BORDER=\&quot;1\&quot; CELLBORDER=\&quot;0\&quot; CELLSPACING=\&quot;0\&quot; CELLPADDING=\&quot;3\&quot;&gt;&quot;)
        print(&quot;&lt;TR&gt;&quot;)
        print(&quot;&lt;TD COLSPAN=\&quot;5\&quot; BGCOLOR=\&quot;black\&quot;&gt;&lt;FONT color=\&quot;white\&quot;&gt;&lt;B&gt;&quot; trim($1) &quot;&lt;/B&gt;&lt;/FONT&gt;&lt;/TD&gt;&quot;)
        print(&quot;&lt;/TR&gt;&quot;)

        print(&quot;&lt;TR&gt;&quot;)
        print(&quot;&lt;TD&gt;column&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;type&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;nullable&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;PK&lt;/TD&gt;&quot;)
        print(&quot;&lt;TD&gt;FK&lt;/TD&gt;&quot;)
        print(&quot;&lt;/TR&gt;&quot;)
        port = 0
    }

    print(&quot;&lt;TR&gt;&quot;)
    print(&quot;&lt;TD port=\&quot;f&quot; ++port &quot;\&quot;&gt;&quot;trim($2)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($4)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($6)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($8)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;TD&gt;&quot;trim($9)&quot;&lt;/TD&gt;&quot;)
    print(&quot;&lt;/TR&gt;&quot;)

    if (trim($9) == &quot;FOREIGN KEY&quot;) {
        edges[++edgeCounter] = trim($1) &quot; -&gt; &quot; trim($10) &quot;;&quot;
    }

    if (length(trim($5)) &gt; 0) {
        nodes[++nodeCounter] = trim($4) &quot;[shape=\&quot;box\&quot;, style=\&quot;rounded\&quot;, label=&lt;&lt;B&gt;&quot; trim($4) &quot; (enum)&lt;/B&gt;&lt;BR/&gt;&quot; trim($5) &quot;&gt;];&quot;
        edges[++edgeCounter] = trim($1) &quot;:f&quot; port &quot; -&gt; &quot; trim($4) &quot;;&quot;
    }
   
    currentTableName = $1
}

END {
    print(&quot;&lt;/TABLE&gt;&gt;]&quot;)

    for (node in nodes) {
        print(nodes[++i])
    }
    i = 0
    for (edge in edges){
        print(edges[++i])
    }
    print(&quot;}&quot;)
}'</code></pre>
<p>I have put the result in a <a href="../images/schema.svg">external file</a> because the graph has become to big in size. Not so bad, I think.</p>
<p>Update 2017-10-12:</p>
<p>I added a <a href="https://github.com/enter-haken/scripts/blob/master/schema.sh">schema.sh</a> script to my <a href="https://github.com/enter-haken/scripts">script collection</a>.</p>

        </section>

        <section id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons Lizenzvertrag" style="border-width:0;vertical-align:middle;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
            </a>
        </section>
    </body>
</html>
