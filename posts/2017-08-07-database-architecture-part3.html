<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>enter_haken - A database gate keeper</title>
        <!--<link rel="stylesheet" type="text/css" href="/css/default.css" />-->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
        <link rel="stylesheet" type="text/css" href="../css/milligram.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
    </head>
    <body>
        <section id="navigation">
            <a href="../">enter_haken</a>
            <a href="../projects.html">projects</a>
            <a href="../cookbook.html">cookbook</a>
            <a href="../notes.html">notes</a>
            <a href="../read.html">read</a>
            <a href="../about.html">about</a>
        </section>

        <section id="content">
            <h1>A database gate keeper</h1>

<div class="info">
    
    Posted on August  7, 2017
    
        
</div>

<p>After <a href="../posts/2017-07-15-database-architecture-part2.html">working with some entities</a> it comes the question, how to get the data inside and outside the database. There is no need, that other parts of an application need to now, how the data is organized in relations. One possible way of hiding the inner database structure is to create a kind of transfer table.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="669pt" height="242pt" viewBox="0.00 0.00 669.00 242.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 238)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-238 665,-238 665,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="0,-59 0,-136 161,-136 161,-59 0,-59"></polygon>
<text text-anchor="middle" x="80.5" y="-120.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">some kind of middleware</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="181,-8 181,-226 653,-226 653,-8 181,-8"></polygon>
<text text-anchor="middle" x="417" y="-210.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">PostgreSQL</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="#ffffff" stroke="#ffffff" points="279,-16 279,-195 645,-195 645,-16 279,-16"></polygon>
<text text-anchor="middle" x="462" y="-179.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">relational</text>
<text text-anchor="middle" x="462" y="-164.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">data</text>
</g>
<!-- mwnode -->
<g id="node1" class="node">
<title>mwnode</title>
<path fill="#ffffff" stroke="#ffffff" d="M110,-105C110,-105 51,-105 51,-105 45,-105 39,-99 39,-93 39,-93 39,-79 39,-79 39,-73 45,-67 51,-67 51,-67 110,-67 110,-67 116,-67 122,-73 122,-79 122,-79 122,-93 122,-93 122,-99 116,-105 110,-105"></path>
<text text-anchor="middle" x="80.5" y="-89.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">middleware</text>
<text text-anchor="middle" x="80.5" y="-74.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">node</text>
</g>
<!-- transfer -->
<g id="node8" class="node">
<title>transfer</title>
<path fill="#ffffff" stroke="#ffffff" d="M239,-105C239,-105 201,-105 201,-105 195,-105 189,-99 189,-93 189,-93 189,-79 189,-79 189,-73 195,-67 201,-67 201,-67 239,-67 239,-67 245,-67 251,-73 251,-79 251,-79 251,-93 251,-93 251,-99 245,-105 239,-105"></path>
<text text-anchor="middle" x="220" y="-89.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">transfer</text>
<text text-anchor="middle" x="220" y="-74.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">table</text>
</g>
<!-- mwnode&#45;&gt;transfer -->
<g id="edge6" class="edge">
<title>mwnode-&gt;transfer</title>
<path fill="none" stroke="#000000" d="M122.3546,-86C140.2001,-86 160.9623,-86 178.7419,-86"></path>
<polygon fill="#000000" stroke="#000000" points="178.8211,-89.5001 188.821,-86 178.821,-82.5001 178.8211,-89.5001"></polygon>
</g>
<!-- customer -->
<g id="node2" class="node">
<title>customer</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M344,-104C344,-104 299,-104 299,-104 293,-104 287,-98 287,-92 287,-92 287,-80 287,-80 287,-74 293,-68 299,-68 299,-68 344,-68 344,-68 350,-68 356,-74 356,-80 356,-80 356,-92 356,-92 356,-98 350,-104 344,-104"></path>
<text text-anchor="middle" x="321.5" y="-82.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">customer</text>
</g>
<!-- person -->
<g id="node3" class="node">
<title>person</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M435,-104C435,-104 404,-104 404,-104 398,-104 392,-98 392,-92 392,-92 392,-80 392,-80 392,-74 398,-68 404,-68 404,-68 435,-68 435,-68 441,-68 447,-74 447,-80 447,-80 447,-92 447,-92 447,-98 441,-104 435,-104"></path>
<text text-anchor="middle" x="419.5" y="-82.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
</g>
<!-- customer&#45;&gt;person -->
<g id="edge1" class="edge">
<title>customer-&gt;person</title>
<path fill="none" stroke="#000000" d="M356.0511,-86C364.2655,-86 373.0749,-86 381.4365,-86"></path>
<polygon fill="#000000" stroke="#000000" points="381.71,-89.5001 391.7099,-86 381.7099,-82.5001 381.71,-89.5001"></polygon>
</g>
<!-- p2p -->
<g id="node4" class="node">
<title>p2p</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M528,-77.5C528,-77.5 497,-77.5 497,-77.5 491,-77.5 485,-71.5 485,-65.5 485,-65.5 485,-36.5 485,-36.5 485,-30.5 491,-24.5 497,-24.5 497,-24.5 528,-24.5 528,-24.5 534,-24.5 540,-30.5 540,-36.5 540,-36.5 540,-65.5 540,-65.5 540,-71.5 534,-77.5 528,-77.5"></path>
<text text-anchor="middle" x="512.5" y="-62.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
<text text-anchor="middle" x="512.5" y="-47.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">to</text>
<text text-anchor="middle" x="512.5" y="-32.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">phone</text>
</g>
<!-- person&#45;&gt;p2p -->
<g id="edge2" class="edge">
<title>person-&gt;p2p</title>
<path fill="none" stroke="#000000" d="M447.1513,-75.5936C455.9733,-72.2735 465.8848,-68.5433 475.2711,-65.0109"></path>
<polygon fill="#000000" stroke="#000000" points="476.6683,-68.2248 484.7947,-61.4267 474.2027,-61.6734 476.6683,-68.2248"></polygon>
</g>
<!-- p2a -->
<g id="node6" class="node">
<title>p2a</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M530,-148.5C530,-148.5 495,-148.5 495,-148.5 489,-148.5 483,-142.5 483,-136.5 483,-136.5 483,-107.5 483,-107.5 483,-101.5 489,-95.5 495,-95.5 495,-95.5 530,-95.5 530,-95.5 536,-95.5 542,-101.5 542,-107.5 542,-107.5 542,-136.5 542,-136.5 542,-142.5 536,-148.5 530,-148.5"></path>
<text text-anchor="middle" x="512.5" y="-133.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
<text text-anchor="middle" x="512.5" y="-118.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">to</text>
<text text-anchor="middle" x="512.5" y="-103.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">address</text>
</g>
<!-- person&#45;&gt;p2a -->
<g id="edge4" class="edge">
<title>person-&gt;p2a</title>
<path fill="none" stroke="#000000" d="M447.1513,-96.7037C455.4086,-99.9001 464.6204,-103.466 473.4626,-106.8887"></path>
<polygon fill="#000000" stroke="#000000" points="472.2603,-110.1764 482.8495,-110.5224 474.7873,-103.6484 472.2603,-110.1764"></polygon>
</g>
<!-- phone -->
<g id="node5" class="node">
<title>phone</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M622.5,-69C622.5,-69 592.5,-69 592.5,-69 586.5,-69 580.5,-63 580.5,-57 580.5,-57 580.5,-45 580.5,-45 580.5,-39 586.5,-33 592.5,-33 592.5,-33 622.5,-33 622.5,-33 628.5,-33 634.5,-39 634.5,-45 634.5,-45 634.5,-57 634.5,-57 634.5,-63 628.5,-69 622.5,-69"></path>
<text text-anchor="middle" x="607.5" y="-47.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">phone</text>
</g>
<!-- p2p&#45;&gt;phone -->
<g id="edge3" class="edge">
<title>p2p-&gt;phone</title>
<path fill="none" stroke="#000000" d="M540.2333,-51C549.5822,-51 560.1744,-51 570.1417,-51"></path>
<polygon fill="#000000" stroke="#000000" points="570.2242,-54.5001 580.2241,-51 570.2241,-47.5001 570.2242,-54.5001"></polygon>
</g>
<!-- address -->
<g id="node7" class="node">
<title>address</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M625,-140C625,-140 590,-140 590,-140 584,-140 578,-134 578,-128 578,-128 578,-116 578,-116 578,-110 584,-104 590,-104 590,-104 625,-104 625,-104 631,-104 637,-110 637,-116 637,-116 637,-128 637,-128 637,-134 631,-140 625,-140"></path>
<text text-anchor="middle" x="607.5" y="-118.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">address</text>
</g>
<!-- p2a&#45;&gt;address -->
<g id="edge5" class="edge">
<title>p2a-&gt;address</title>
<path fill="none" stroke="#000000" d="M542.0378,-122C550.1697,-122 559.1252,-122 567.7327,-122"></path>
<polygon fill="#000000" stroke="#000000" points="567.9805,-125.5001 577.9804,-122 567.9804,-118.5001 567.9805,-125.5001"></polygon>
</g>
<!-- transfer&#45;&gt;customer -->
<g id="edge7" class="edge">
<title>transfer-&gt;customer</title>
<path fill="none" stroke="#000000" d="M251.0049,-86C259.134,-86 268.0639,-86 276.7554,-86"></path>
<polygon fill="#000000" stroke="#000000" points="276.7869,-89.5001 286.7869,-86 276.7868,-82.5001 276.7869,-89.5001"></polygon>
</g>
</g>
</svg>
</div>
<p>This table is a kind of a gate keeper. Only this table should be used to communicate with he outside world. Maybe this sounds a little bit weird for a moment, but let me show you my idea.</p>
<!--more-->
<p>First we have to know, which entities can be used by the middleware.</p>
<pre><code>CREATE TYPE entity AS ENUM (
    'employee',
    'customer',
    'purchase_order',
    'article',
    'price'
);</code></pre>
<p>These are <a href="../posts/2017-07-15-database-architecture-part2.html">previously</a> used examples.</p>
<pre><code>CREATE TYPE transfer_status AS ENUM (
    'pending',
    'processing',
    'succeeded',
    'succeeded_with_warning',
    'error'
);</code></pre>
<p>The requested process can have a state.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="324pt" height="225pt" viewBox="0.00 0.00 324.00 225.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 221)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-221 320,-221 320,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="8,-62 8,-137 86,-137 86,-62 8,-62"></polygon>
<text text-anchor="middle" x="47" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">request</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="106,-62 106,-167 199,-167 199,-62 106,-62"></polygon>
<text text-anchor="middle" x="152.5" y="-151.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">server</text>
<text text-anchor="middle" x="152.5" y="-136.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">internal</text>
<text text-anchor="middle" x="152.5" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="219,-8 219,-209 308,-209 308,-8 219,-8"></polygon>
<text text-anchor="middle" x="263.5" y="-193.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">result</text>
</g>
<!-- pending -->
<g id="node1" class="node">
<title>pending</title>
<path fill="#ffffff" stroke="#ffffff" d="M66,-106C66,-106 28,-106 28,-106 22,-106 16,-100 16,-94 16,-94 16,-82 16,-82 16,-76 22,-70 28,-70 28,-70 66,-70 66,-70 72,-70 78,-76 78,-82 78,-82 78,-94 78,-94 78,-100 72,-106 66,-106"></path>
<text text-anchor="middle" x="47" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">pending</text>
</g>
<!-- processing -->
<g id="node2" class="node">
<title>processing</title>
<path fill="#ffffff" stroke="#ffffff" d="M179,-106C179,-106 126,-106 126,-106 120,-106 114,-100 114,-94 114,-94 114,-82 114,-82 114,-76 120,-70 126,-70 126,-70 179,-70 179,-70 185,-70 191,-76 191,-82 191,-82 191,-94 191,-94 191,-100 185,-106 179,-106"></path>
<text text-anchor="middle" x="152.5" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing</text>
</g>
<!-- pending&#45;&gt;processing -->
<g id="edge1" class="edge">
<title>pending-&gt;processing</title>
<path fill="none" stroke="#000000" d="M78.0829,-88C86.1212,-88 94.9719,-88 103.6791,-88"></path>
<polygon fill="#000000" stroke="#000000" points="103.7774,-91.5001 113.7774,-88 103.7773,-84.5001 103.7774,-91.5001"></polygon>
</g>
<!-- succeeded_with_warning -->
<g id="node3" class="node">
<title>succeeded_with_warning</title>
<path fill="#ffffff" stroke="#ffffff" d="M285,-177.5C285,-177.5 242,-177.5 242,-177.5 236,-177.5 230,-171.5 230,-165.5 230,-165.5 230,-136.5 230,-136.5 230,-130.5 236,-124.5 242,-124.5 242,-124.5 285,-124.5 285,-124.5 291,-124.5 297,-130.5 297,-136.5 297,-136.5 297,-165.5 297,-165.5 297,-171.5 291,-177.5 285,-177.5"></path>
<text text-anchor="middle" x="263.5" y="-162.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">succeded</text>
<text text-anchor="middle" x="263.5" y="-147.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">with</text>
<text text-anchor="middle" x="263.5" y="-132.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">warning</text>
</g>
<!-- processing&#45;&gt;succeeded_with_warning -->
<g id="edge2" class="edge">
<title>processing-&gt;succeeded_with_warning</title>
<path fill="none" stroke="#000000" d="M184.3081,-106.0533C195.6413,-112.4856 208.597,-119.8389 220.7011,-126.7087"></path>
<polygon fill="#000000" stroke="#000000" points="219.3256,-129.9525 229.7501,-131.8447 222.7809,-123.8647 219.3256,-129.9525"></polygon>
</g>
<!-- succeeded -->
<g id="node4" class="node">
<title>succeeded</title>
<path fill="#ffffff" stroke="#ffffff" d="M288,-106C288,-106 239,-106 239,-106 233,-106 227,-100 227,-94 227,-94 227,-82 227,-82 227,-76 233,-70 239,-70 239,-70 288,-70 288,-70 294,-70 300,-76 300,-82 300,-82 300,-94 300,-94 300,-100 294,-106 288,-106"></path>
<text text-anchor="middle" x="263.5" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">succeeded</text>
</g>
<!-- processing&#45;&gt;succeeded -->
<g id="edge3" class="edge">
<title>processing-&gt;succeeded</title>
<path fill="none" stroke="#000000" d="M191.0109,-88C199.2909,-88 208.1292,-88 216.6852,-88"></path>
<polygon fill="#000000" stroke="#000000" points="216.925,-91.5001 226.925,-88 216.925,-84.5001 216.925,-91.5001"></polygon>
</g>
<!-- error -->
<g id="node5" class="node">
<title>error</title>
<path fill="#ffffff" stroke="#ffffff" d="M278.5,-52C278.5,-52 248.5,-52 248.5,-52 242.5,-52 236.5,-46 236.5,-40 236.5,-40 236.5,-28 236.5,-28 236.5,-22 242.5,-16 248.5,-16 248.5,-16 278.5,-16 278.5,-16 284.5,-16 290.5,-22 290.5,-28 290.5,-28 290.5,-40 290.5,-40 290.5,-46 284.5,-52 278.5,-52"></path>
<text text-anchor="middle" x="263.5" y="-30.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">error</text>
</g>
<!-- processing&#45;&gt;error -->
<g id="edge4" class="edge">
<title>processing-&gt;error</title>
<path fill="none" stroke="#000000" d="M189.7702,-69.8686C201.7967,-64.0178 215.1081,-57.542 227.073,-51.7212"></path>
<polygon fill="#000000" stroke="#000000" points="228.8685,-54.74 236.3297,-47.218 225.8062,-48.4454 228.8685,-54.74"></polygon>
</g>
</g>
</svg>
</div>
<p>For the start, the transfer table has some kind of <code>request</code> and some kind of <code>response</code>.</p>
<pre><code>CREATE TABLE transfer (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    status transfer_status NOT NULL DEFAULT 'pending',
    request JSONB NOT NULL,
    result JSONB
);</code></pre>
<p>A simple insert like</p>
<pre><code>INSERT INTO transfer (request) 
    VALUES ('{&quot;some_data&quot; : &quot;values&quot;}'::JSONB);</code></pre>
<p>should be enough, to communicate with the database.</p>
<p>Now it is time to fill this <code>request</code> object with life. First we define some keys, which are mandatory for every request.</p>
<ul>
<li>The <code>entity</code> key defines the entity known to the database. (e.g. <code>customer</code> or <code>purchase_order</code>)</li>
<li>The <code>payload</code> is the actual data</li>
<li>The <code>action</code> key tells the database, what to do with the <code>payload</code>. Valid actions for now are <code>select</code>, <code>upsert</code> and <code>delete</code></li>
</ul>
<p>The trigger function is the entry point for every data access.</p>
<pre><code>CREATE FUNCTION transfer_trigger_function() RETURNS TRIGGER AS $$
DECLARE
BEGIN
    CASE NEW.request-&gt;&gt;'entity'
        WHEN 'customer' THEN
            SELECT customer_manager(NEW.id, NEW.request) INTO NEW.response;
        ELSE
            RAISE EXCEPTION 'not a valid entity';
    END CASE;
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER transfer_after_trigger BEFORE INSERT ON transfer
    FOR EACH ROW EXECUTE PROCEDURE transfer_trigger_function();</code></pre>
<p>As you can see, you can access the <code>request</code> data from within the trigger function via <a href="https://www.postgresql.org/docs/current/static/functions-json.html">build in json functions</a>.</p>
<p>There shouldn’t be much logic in the transfer trigger. The entity managers should do the “hard work”.</p>
<p>Due to this is a trigger function, you should be aware of nesting functions too much. You should not update the <code>transfer</code> table out of the trigger function it self. This can lead to infinite loops.</p>
<h1 id="customer-entity-manager">customer entity manager</h1>
<p>Every entity manager should perform the <code>select</code>, <code>upsert</code> and <code>delete</code> tasks. Let’s take the <code>customer</code> as an example.</p>
<h2 id="select">select</h2>
<p>When every root entity like the <code>customer</code> relation has a <code>json_view</code> column, this should be the result for a select operation. In the first step, the request can look like</p>
<pre><code>{
    &quot;entity&quot; : &quot;customer&quot;,
    &quot;action&quot; : &quot;select&quot;,
    &quot;payload&quot; : { 
        &quot;id&quot; : &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot; 
    }
}</code></pre>
<p>The <code>customer_manager</code> checks if the action is valid and calls the assigned function.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
        WHEN 'select' THEN
            SELECT customer_manager_select(request-&gt;'payload') INTO raw_response;
        ELSE
            RAISE EXCEPTION 'not a valid action';
    END CASE;
    
    RETURN raw_response;
END
$$ LANGUAGE plpgsql; </code></pre>
<p>The <code>customer_manager_select</code> function takes the payload and returns the <code>json_view</code> of the customer as a response.</p>
<pre><code>CREATE FUNCTION customer_manager_select(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE 
    raw_result JSONB;
BEGIN
    SELECT json_view FROM customer WHERE id = (raw_payload-&gt;&gt;'id')::UUID INTO raw_result;

    raw_result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }' || jsonb_build_object('data', raw_result);

    RETURN raw_result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>An</p>
<pre><code>INSERT INTO transfer (request) 
    VALUES ('{ &quot;entity&quot; : &quot;customer&quot;, &quot;action&quot; : &quot;select&quot;, &quot;payload&quot; : { &quot;id&quot; : &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot; } }'::JSONB);</code></pre>
<p>will result into the following row.</p>
<pre><code>                  id                  | status  |                                                request                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  response                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         created_at         |         updated_at         
--------------------------------------+---------+-------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------
 874c1126-8ea6-4609-9c6d-ed52fc8bb682 | pending | {&quot;action&quot;: &quot;select&quot;, &quot;entity&quot;: &quot;customer&quot;, &quot;payload&quot;: {&quot;id&quot;: &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot;}} | {&quot;data&quot;: {&quot;id&quot;: &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot;, &quot;person&quot;: {&quot;id&quot;: &quot;0ec888ea-b84b-4dab-97fc-c1a6fb8ff313&quot;, &quot;notes&quot;: null, &quot;website&quot;: null, &quot;addresses&quot;: [{&quot;id&quot;: &quot;06690a9c-92ea-4791-8922-e4e2da7f8991&quot;, &quot;city&quot;: &quot;Dortmund&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44339&quot;, &quot;address_type&quot;: &quot;private&quot;, &quot;house_number&quot;: &quot;123&quot;}, {&quot;id&quot;: &quot;e81b9449-7c0e-4d39-993e-e483064dd6c9&quot;, &quot;city&quot;: &quot;Bochum&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44866&quot;, &quot;address_type&quot;: &quot;work&quot;, &quot;house_number&quot;: &quot;321&quot;}], &quot;last_name&quot;: &quot;Hake&quot;, &quot;birth_date&quot;: null, &quot;first_name&quot;: &quot;Jan Frederik&quot;, &quot;phone_numbers&quot;: [{&quot;id&quot;: &quot;6c09f794-45f4-4746-ba0b-2a6ae9f8dd97&quot;, &quot;phone_number&quot;: &quot;+49123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;landline&quot;, &quot;is_primary_phone_number&quot;: true}, {&quot;id&quot;: &quot;5e08670f-0cf7-46b4-9c0b-40b87a727607&quot;, &quot;phone_number&quot;: &quot;+49151123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;cellular_network&quot;, &quot;is_primary_phone_number&quot;: false}], &quot;email_addresses&quot;: [{&quot;id&quot;: &quot;815fe354-b157-422e-b3c3-6686fead0152&quot;, &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;is_primary_email_address&quot;: false}]}, &quot;customer_number&quot;: &quot;AB123456&quot;}, &quot;status&quot;: &quot;ok&quot;, &quot;error_code&quot;: 0} | 2017-07-31 10:13:46.250357 | 2017-07-31 10:13:46.250357</code></pre>
<p>This is a fist shoot. The <code>response</code> can be quite big, so this should be refactored later. You might also want to build a <code>WHERE</code> clause out of the <code>payload</code> (e.g. Give me all customers living in Hamburg)</p>
<h2 id="delete">delete</h2>
<p>The <code>delete</code> action works with the root <code>id</code>.</p>
<pre><code>{
    &quot;entity&quot; : &quot;customer&quot;,
    &quot;action&quot; : &quot;delete&quot;,
    &quot;payload&quot; : { 
        &quot;id&quot; : &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot; 
    }
}</code></pre>
<p>The <code>customer_manager</code> must be extended for the <code>delete</code> action.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
        WHEN 'select' THEN
            SELECT customer_manager_select(request-&gt;'payload') INTO raw_response;
        WHEN 'delete' THEN
            SELECT customer_manager_delete(request-&gt;'payload') INTO raw_response;
        ELSE
            RAISE EXCEPTION 'not a valid action';
    END CASE;
    
    RETURN raw_response;
END
$$ LANGUAGE plpgsql; </code></pre>
<p>The simplest approach would be</p>
<pre><code>CREATE FUNCTION customer_manager_delete(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE 
    raw_result JSONB;
BEGIN
    DELETE FROM customer WHERE id = (raw_payload-&gt;&gt;'id')::UUID;

    raw_result := ('{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0, &quot;data&quot; : { &quot;id&quot; : &quot;' || (raw_payload-&gt;&gt;'id') || '&quot;}}')::JSONB;

    RETURN raw_result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This will work, if the <code>customer</code> has no reference to other tables. After a first <code>purchase_order</code> is created, deletion won’t work any more, due to referential integrity constraints. This is an issue, to think about. In Germany for example, you have to store invoices for several years. This means, customers won’t be deleted, until there last invoice is deleted. There is one approach, to set a own <code>deleted</code> property for a <code>customer</code>. This property is very handy, so it can be included into the post <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> script.</p>
<pre><code>CREATE FUNCTION add_metadata_to_every_table() RETURNS VOID AS $$
DECLARE 
    row record;
BEGIN
    FOR row IN SELECT tablename FROM pg_tables WHERE schemaname = 'test' LOOP

        -- ...   
        EXECUTE 'ALTER TABLE ' || row.tablename || 
            ' ADD COLUMN deleted boolean NOT NULL DEFAULT false';
        -- ...

    END LOOP;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>Now every table has a <code>deleted</code> column.</p>
<p>Now the <code>customer_manager_select</code> looks like</p>
<pre><code>CREATE FUNCTION customer_manager_delete(raw_payload JSONB) RETURNS JSONB AS $$
BEGIN
    UPDATE customer SET deleted = true WHERE id = (raw_payload-&gt;&gt;'id')::UUID;

    RETURN ('{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0, &quot;data&quot; : { &quot;id&quot; : &quot;' || (raw_payload-&gt;&gt;'id') || '&quot;}}')::JSONB;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>It might be handy, if a <code>deleted</code> record can’t be updated any more. The <code>metadata_trigger</code> is a good place for checking for the <code>deleted</code> column.</p>
<pre><code>CREATE FUNCTION metadata_trigger() RETURNS TRIGGER AS $$
BEGIN
    IF NEW.deleted = true THEN
        RAISE EXCEPTION 'can not update the deleted record %', NEW.id::text;
    END IF;

    NEW.updated_at := now();
    RETURN NEW;
END
$$ LANGUAGE plpgsql;</code></pre>
<h2 id="upsert">upsert</h2>
<p>Let’s start with a <a href="../posts/2017-07-15-database-architecture-part2.html#customer">known customer</a>.</p>
<pre><code>    &quot;person&quot;: {
        &quot;addresses&quot;: [{
            &quot;city&quot;: &quot;Dortmund&quot;,
            &quot;street&quot;: &quot;Fakestreet&quot;,
            &quot;postal_code&quot;: &quot;44339&quot;,
            &quot;address_type&quot;: &quot;private&quot;,
            &quot;house_number&quot;: &quot;123&quot;
        }, {
            &quot;city&quot;: &quot;Bochum&quot;,
            &quot;street&quot;: &quot;Fakestreet&quot;,
            &quot;postal_code&quot;: &quot;44866&quot;,
            &quot;address_type&quot;: &quot;work&quot;,
            &quot;house_number&quot;: &quot;321&quot;
        }],
        &quot;last_name&quot;: &quot;Hake&quot;,
        &quot;first_name&quot;: &quot;Jan Frederik&quot;,
        &quot;phone_numbers&quot;: [{
            &quot;phone_number&quot;: &quot;+49123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;landline&quot;
        }, {
            &quot;phone_number&quot;: &quot;+49151123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;cellular_network&quot;
        }],
        &quot;email_addresses&quot;: [{
            &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;,
            &quot;communication_type&quot;: &quot;private&quot;
        }]
    }
}</code></pre>
<p>As you can see, there are no <code>id</code>s or <code>customer_numbers</code> present in the whole entity. For this example, a new customer is assumed. Imagine, you have a web form, where you enter your data. When you’re ready with editing, this might be a result for a customer.</p>
<p>So we first take a look at a possible insert function.</p>
<p>For now, we use a simple customer number generator.</p>
<pre><code>CREATE FUNCTION customer_number() RETURNS text AS $$
    from random import randint
    return &quot;AB%05d&quot; % randint(0,99999)
$$ LANGUAGE plpython3u;</code></pre>
<p>The default value of the <code>customer_number</code> must be changed to</p>
<pre><code>ALTER TABLE customer ALTER COLUMN customer_number SET DEFAULT customer_number();</code></pre>
<p>For a new <code>customer</code>, only <code>person</code> data is needed. The <code>customer_manager</code> has to be extended.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
       -- ...
       WHEN 'upsert' THEN
            SELECT customer_manager_upsert(request-&gt;'payload') INTO raw_response;
       -- ...  
    END CASE; 
$$ LANGUAGE plpgsql; </code></pre>
<p>We insert this new <code>customer</code>.</p>
<pre><code>CREATE FUNCTION customer_manager_upsert(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE
    person_id UUID;
    customer_id UUID;
    result JSONB;
BEGIN
    INSERT INTO person (first_name, last_name, birth_date, notes, website)
         VALUES (raw_payload#&gt;&gt;'{person,first_name}', 
             raw_payload#&gt;&gt;'{person,last_name}',
             (raw_payload#&gt;&gt;'{person,birth_date}')::DATE,
             raw_payload#&gt;&gt;'{person,notes}',
             raw_payload#&gt;&gt;'{person,website}') RETURNING id INTO person_id;
   
    INSERT INTO customer (id_person) VALUES (person_id) RETURNING id INTO customer_id;

    PERFORM update_json_view_customer(customer_id);

    SELECT json_view FROM customer WHERE id = customer_id INTO result;

    result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }'::JSONB || jsonb_build_object('data', result);

    RETURN result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This creates a new <code>customer</code> with a new <code>person</code>. The <code>update_json_view_customer</code> <a href="../posts/2017-07-15-database-architecture-part2.html#customer">function</a> will update the <code>json_view</code> of the <code>customer</code>.</p>
<pre><code>{
    &quot;id&quot;: &quot;46624c40-c50a-478e-83e9-9117d7b87f39&quot;,
    &quot;person&quot;: {
        &quot;id&quot;: &quot;81b46e11-cdef-4a71-b850-68882b474c90&quot;,
        &quot;notes&quot;: null,
        &quot;website&quot;: null,
        &quot;addresses&quot;: null,
        &quot;last_name&quot;: &quot;Hake&quot;,
        &quot;birth_date&quot;: null,
        &quot;first_name&quot;: &quot;Jan Frederik&quot;,
        &quot;phone_numbers&quot;: null,
        &quot;email_addresses&quot;: null
    },
    &quot;customer_number&quot;: &quot;AB19856&quot;
}</code></pre>
<p>For the addresses, we have to loop through the nested json array</p>
<pre><code>IF raw_payload#&gt;'{person}' ? 'addresses' THEN
    FOR address in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,addresses}') 
    LOOP
        INSERT INTO address (street, house_number, postal_code, city)
            VALUES (address-&gt;&gt;'street', 
                address-&gt;&gt;'house_number', 
                address-&gt;&gt;'postal_code', 
                address-&gt;&gt;'city')
            RETURNING id INTO address_id;

        INSERT INTO person_to_address (id_person, id_address)
            VALUES (person_id, address_id);
    END LOOP;
END IF;</code></pre>
<p>The phone numbers can be added with the following loop.</p>
<pre><code>IF raw_payload#&gt;'{person}' ? 'phone_numbers' THEN
    FOR phone in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,phone_numbers}') 
    LOOP
        INSERT INTO phone (phone_number, communication_network)
            VALUES (phone-&gt;&gt;'phone_number', 
                (phone-&gt;&gt;'communication_network')::communication_network)
            RETURNING id INTO phone_id;

        INSERT INTO person_to_phone (id_person, id_phone, communication_type)
            VALUES (person_id,  phone_id, (phone-&gt;&gt;'communication_type')::communication_type);
    END LOOP;
END IF;</code></pre>
<p>As you can see, the <code>communication_network</code> and <code>communication_type</code> have to be casted. This is good. Cast errors will cause an exception. This kind of type safety will help during more complex events.</p>
<p>Together we have</p>
<pre><code>CREATE FUNCTION customer_manager_upsert(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE
    person_id UUID;
    customer_id UUID; 
    address_id UUID;
    phone_id UUID;
    email_id UUID;
    address JSONB;
    phone JSONB;
    email JSONB;
    result JSONB;
BEGIN
    INSERT INTO person (first_name, last_name, birth_date, notes, website)
         VALUES (raw_payload#&gt;&gt;'{person,first_name}', 
             raw_payload#&gt;&gt;'{person,last_name}',
             (raw_payload#&gt;&gt;'{person,birth_date}')::DATE,
             raw_payload#&gt;&gt;'{person,notes}',
             raw_payload#&gt;&gt;'{person,website}') RETURNING id INTO person_id;

    IF raw_payload#&gt;'{person}' ? 'addresses' THEN
        FOR address in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,addresses}') 
        LOOP
            INSERT INTO address (street, house_number, postal_code, city)
                VALUES (address-&gt;&gt;'street', 
                    address-&gt;&gt;'house_number', 
                    address-&gt;&gt;'postal_code', 
                    address-&gt;&gt;'city')
                RETURNING id INTO address_id;

            INSERT INTO person_to_address (id_person, id_address)
                VALUES (person_id, address_id);
        END LOOP;
    END IF;

    IF raw_payload#&gt;'{person}' ? 'phone_numbers' THEN
        FOR phone in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,phone_numbers}') 
        LOOP
            INSERT INTO phone (phone_number, communication_network)
                VALUES (phone-&gt;&gt;'phone_number', 
                    (phone-&gt;&gt;'communication_network')::communication_network)
                RETURNING id INTO phone_id;

            INSERT INTO person_to_phone (id_person, id_phone, communication_type)
                VALUES (person_id,  phone_id, (phone-&gt;&gt;'communication_type')::communication_type);
        END LOOP;
    END IF;

    IF raw_payload#&gt;'{person}' ? 'email_addresses' THEN
        FOR email in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,email_addresses}') 
        LOOP
            INSERT INTO email (email_address)
                VALUES (email-&gt;&gt;'email_address') 
                RETURNING id INTO email_id;

            INSERT INTO person_to_email (id_person, id_email, communication_type)
                VALUES (person_id, email_id, (email-&gt;&gt;'communication_type')::communication_type);
        END LOOP;
    END IF;
    
    INSERT INTO customer (id_person) VALUES (person_id) RETURNING id INTO customer_id;

    PERFORM update_json_view_customer(customer_id);

    SELECT json_view FROM customer WHERE id = customer_id INTO result;

    result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }'::JSONB || jsonb_build_object('data', result);

    RETURN result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This is a best case scenario. There are no duplicate checks for example. Maybe, the upsert function needs some rewrite in a more compact language like <a href="https://www.postgresql.org/docs/current/static/plpython.html">PL/Python</a>.</p>

        </section>

        <section id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons Lizenzvertrag" style="border-width:0;vertical-align:middle;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
            </a>
        </section>
    </body>
</html>
