<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>enter_haken - A database gate keeper</title>
        <!--<link rel="stylesheet" type="text/css" href="/css/default.css" />-->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
        <link rel="stylesheet" type="text/css" href="../css/milligram.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
        <script src="js/vis.min.js"></script>
    </head>
    <body>
        <section id="navigation">
            <a href="../">enter_haken</a>
            <a href="../projects.html">projects</a>
            <a href="../cookbook.html">cookbook</a>
            <a href="../notes.html">notes</a>
            <a href="../read.html">read</a>
            <a href="../about.html">about</a>
        </section>

        <section id="content">
            <h1>A database gate keeper</h1>

<div class="info">
    
    Posted on August  7, 2017
    
        
</div>

<p>After <a href="../posts/2017-07-15-database-architecture-part2.html">working with some entities</a> it comes the question, how to get the data inside and outside the database. There is no need, that other parts of an application need to now, how the data is organized in relations. One possible way of hiding the inner database structure is to create a kind of transfer table.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="694pt" height="242pt" viewBox="0.00 0.00 694.00 242.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 238)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-238 690,-238 690,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="0,-59 0,-136 167,-136 167,-59 0,-59"></polygon>
<text text-anchor="middle" x="83.5" y="-120.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">some kind of middleware</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="187,-8 187,-226 678,-226 678,-8 187,-8"></polygon>
<text text-anchor="middle" x="432.5" y="-210.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">PostgreSQL</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="#ffffff" stroke="#ffffff" points="285,-16 285,-195 670,-195 670,-16 285,-16"></polygon>
<text text-anchor="middle" x="477.5" y="-179.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">relational</text>
<text text-anchor="middle" x="477.5" y="-164.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">data</text>
</g>
<!-- mwnode -->
<g id="node1" class="node">
<title>mwnode</title>
<path fill="#ffffff" stroke="#ffffff" d="M114,-105C114,-105 52,-105 52,-105 46,-105 40,-99 40,-93 40,-93 40,-79 40,-79 40,-73 46,-67 52,-67 52,-67 114,-67 114,-67 120,-67 126,-73 126,-79 126,-79 126,-93 126,-93 126,-99 120,-105 114,-105"></path>
<text text-anchor="middle" x="83" y="-89.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">middleware</text>
<text text-anchor="middle" x="83" y="-74.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">node</text>
</g>
<!-- transfer -->
<g id="node8" class="node">
<title>transfer</title>
<path fill="#ffffff" stroke="#ffffff" d="M245,-105C245,-105 207,-105 207,-105 201,-105 195,-99 195,-93 195,-93 195,-79 195,-79 195,-73 201,-67 207,-67 207,-67 245,-67 245,-67 251,-67 257,-73 257,-79 257,-79 257,-93 257,-93 257,-99 251,-105 245,-105"></path>
<text text-anchor="middle" x="226" y="-89.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">transfer</text>
<text text-anchor="middle" x="226" y="-74.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">table</text>
</g>
<!-- mwnode&#45;&gt;transfer -->
<g id="edge6" class="edge">
<title>mwnode-&gt;transfer</title>
<path fill="none" stroke="#000000" d="M126.2928,-86C144.7952,-86 166.2988,-86 184.5893,-86"></path>
<polygon fill="#000000" stroke="#000000" points="184.6595,-89.5001 194.6595,-86 184.6595,-82.5001 184.6595,-89.5001"></polygon>
</g>
<!-- customer -->
<g id="node2" class="node">
<title>customer</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M354,-104C354,-104 305,-104 305,-104 299,-104 293,-98 293,-92 293,-92 293,-80 293,-80 293,-74 299,-68 305,-68 305,-68 354,-68 354,-68 360,-68 366,-74 366,-80 366,-80 366,-92 366,-92 366,-98 360,-104 354,-104"></path>
<text text-anchor="middle" x="329.5" y="-82.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">customer</text>
</g>
<!-- person -->
<g id="node3" class="node">
<title>person</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M448,-104C448,-104 414,-104 414,-104 408,-104 402,-98 402,-92 402,-92 402,-80 402,-80 402,-74 408,-68 414,-68 414,-68 448,-68 448,-68 454,-68 460,-74 460,-80 460,-80 460,-92 460,-92 460,-98 454,-104 448,-104"></path>
<text text-anchor="middle" x="431" y="-82.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
</g>
<!-- customer&#45;&gt;person -->
<g id="edge1" class="edge">
<title>customer-&gt;person</title>
<path fill="none" stroke="#000000" d="M366.1438,-86C374.3687,-86 383.1304,-86 391.4671,-86"></path>
<polygon fill="#000000" stroke="#000000" points="391.7272,-89.5001 401.7271,-86 391.7271,-82.5001 391.7272,-89.5001"></polygon>
</g>
<!-- p2p -->
<g id="node4" class="node">
<title>p2p</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M545.5,-77.5C545.5,-77.5 511.5,-77.5 511.5,-77.5 505.5,-77.5 499.5,-71.5 499.5,-65.5 499.5,-65.5 499.5,-36.5 499.5,-36.5 499.5,-30.5 505.5,-24.5 511.5,-24.5 511.5,-24.5 545.5,-24.5 545.5,-24.5 551.5,-24.5 557.5,-30.5 557.5,-36.5 557.5,-36.5 557.5,-65.5 557.5,-65.5 557.5,-71.5 551.5,-77.5 545.5,-77.5"></path>
<text text-anchor="middle" x="528.5" y="-62.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
<text text-anchor="middle" x="528.5" y="-47.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">to</text>
<text text-anchor="middle" x="528.5" y="-32.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">phone</text>
</g>
<!-- person&#45;&gt;p2p -->
<g id="edge2" class="edge">
<title>person-&gt;p2p</title>
<path fill="none" stroke="#000000" d="M460.2532,-75.4988C469.5084,-72.1765 479.8862,-68.4511 489.7017,-64.9276"></path>
<polygon fill="#000000" stroke="#000000" points="491.038,-68.1666 499.2674,-61.4937 488.6729,-61.5783 491.038,-68.1666"></polygon>
</g>
<!-- p2a -->
<g id="node6" class="node">
<title>p2a</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M549,-148.5C549,-148.5 508,-148.5 508,-148.5 502,-148.5 496,-142.5 496,-136.5 496,-136.5 496,-107.5 496,-107.5 496,-101.5 502,-95.5 508,-95.5 508,-95.5 549,-95.5 549,-95.5 555,-95.5 561,-101.5 561,-107.5 561,-107.5 561,-136.5 561,-136.5 561,-142.5 555,-148.5 549,-148.5"></path>
<text text-anchor="middle" x="528.5" y="-133.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">person</text>
<text text-anchor="middle" x="528.5" y="-118.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">to</text>
<text text-anchor="middle" x="528.5" y="-103.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">address</text>
</g>
<!-- person&#45;&gt;p2a -->
<g id="edge4" class="edge">
<title>person-&gt;p2a</title>
<path fill="none" stroke="#000000" d="M460.2532,-96.8012C468.4918,-99.8431 477.6197,-103.2134 486.4489,-106.4734"></path>
<polygon fill="#000000" stroke="#000000" points="485.2627,-109.7664 495.856,-109.9468 487.6873,-103.1997 485.2627,-109.7664"></polygon>
</g>
<!-- phone -->
<g id="node5" class="node">
<title>phone</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M644.5,-69C644.5,-69 614.5,-69 614.5,-69 608.5,-69 602.5,-63 602.5,-57 602.5,-57 602.5,-45 602.5,-45 602.5,-39 608.5,-33 614.5,-33 614.5,-33 644.5,-33 644.5,-33 650.5,-33 656.5,-39 656.5,-45 656.5,-45 656.5,-57 656.5,-57 656.5,-63 650.5,-69 644.5,-69"></path>
<text text-anchor="middle" x="629.5" y="-47.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">phone</text>
</g>
<!-- p2p&#45;&gt;phone -->
<g id="edge3" class="edge">
<title>p2p-&gt;phone</title>
<path fill="none" stroke="#000000" d="M557.7134,-51C568.5079,-51 580.8906,-51 592.2986,-51"></path>
<polygon fill="#000000" stroke="#000000" points="592.4277,-54.5001 602.4276,-51 592.4276,-47.5001 592.4277,-54.5001"></polygon>
</g>
<!-- address -->
<g id="node7" class="node">
<title>address</title>
<path fill="#d3d3d3" stroke="#d3d3d3" d="M650,-140C650,-140 609,-140 609,-140 603,-140 597,-134 597,-128 597,-128 597,-116 597,-116 597,-110 603,-104 609,-104 609,-104 650,-104 650,-104 656,-104 662,-110 662,-116 662,-116 662,-128 662,-128 662,-134 656,-140 650,-140"></path>
<text text-anchor="middle" x="629.5" y="-118.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">address</text>
</g>
<!-- p2a&#45;&gt;address -->
<g id="edge5" class="edge">
<title>p2a-&gt;address</title>
<path fill="none" stroke="#000000" d="M561.013,-122C569.1305,-122 577.9613,-122 586.4996,-122"></path>
<polygon fill="#000000" stroke="#000000" points="586.7017,-125.5001 596.7017,-122 586.7016,-118.5001 586.7017,-125.5001"></polygon>
</g>
<!-- transfer&#45;&gt;customer -->
<g id="edge7" class="edge">
<title>transfer-&gt;customer</title>
<path fill="none" stroke="#000000" d="M257.0534,-86C265.0993,-86 273.9443,-86 282.6063,-86"></path>
<polygon fill="#000000" stroke="#000000" points="282.6318,-89.5001 292.6317,-86 282.6317,-82.5001 282.6318,-89.5001"></polygon>
</g>
</g>
</svg>
</div>
<p>This table is a kind of a gate keeper. Only this table should be used to communicate with he outside world. Maybe this sounds a little bit weird for a moment, but let me show you my idea.</p>
<!--more-->
<p>First we have to know, which entities can be used by the middleware.</p>
<pre><code>CREATE TYPE entity AS ENUM (
    'employee',
    'customer',
    'purchase_order',
    'article',
    'price'
);</code></pre>
<p>These are <a href="../posts/2017-07-15-database-architecture-part2.html">previously</a> used examples.</p>
<pre><code>CREATE TYPE transfer_status AS ENUM (
    'pending',
    'processing',
    'succeeded',
    'succeeded_with_warning',
    'error'
);</code></pre>
<p>The requested process can have a state.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="341pt" height="225pt" viewBox="0.00 0.00 341.00 225.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 221)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-221 337,-221 337,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="8,-62 8,-137 89,-137 89,-62 8,-62"></polygon>
<text text-anchor="middle" x="48.5" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">request</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="109,-62 109,-167 207,-167 207,-62 109,-62"></polygon>
<text text-anchor="middle" x="158" y="-151.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">server</text>
<text text-anchor="middle" x="158" y="-136.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">internal</text>
<text text-anchor="middle" x="158" y="-121.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="#d3d3d3" stroke="#d3d3d3" points="227,-8 227,-209 325,-209 325,-8 227,-8"></polygon>
<text text-anchor="middle" x="276" y="-193.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">result</text>
</g>
<!-- pending -->
<g id="node1" class="node">
<title>pending</title>
<path fill="#ffffff" stroke="#ffffff" d="M69,-106C69,-106 28,-106 28,-106 22,-106 16,-100 16,-94 16,-94 16,-82 16,-82 16,-76 22,-70 28,-70 28,-70 69,-70 69,-70 75,-70 81,-76 81,-82 81,-82 81,-94 81,-94 81,-100 75,-106 69,-106"></path>
<text text-anchor="middle" x="48.5" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">pending</text>
</g>
<!-- processing -->
<g id="node2" class="node">
<title>processing</title>
<path fill="#ffffff" stroke="#ffffff" d="M187,-106C187,-106 129,-106 129,-106 123,-106 117,-100 117,-94 117,-94 117,-82 117,-82 117,-76 123,-70 129,-70 129,-70 187,-70 187,-70 193,-70 199,-76 199,-82 199,-82 199,-94 199,-94 199,-100 193,-106 187,-106"></path>
<text text-anchor="middle" x="158" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">processing</text>
</g>
<!-- pending&#45;&gt;processing -->
<g id="edge1" class="edge">
<title>pending-&gt;processing</title>
<path fill="none" stroke="#000000" d="M81.0571,-88C89.1226,-88 97.9615,-88 106.6838,-88"></path>
<polygon fill="#000000" stroke="#000000" points="106.8161,-91.5001 116.816,-88 106.816,-84.5001 106.8161,-91.5001"></polygon>
</g>
<!-- succeeded_with_warning -->
<g id="node3" class="node">
<title>succeeded_with_warning</title>
<path fill="#ffffff" stroke="#ffffff" d="M301,-177.5C301,-177.5 251,-177.5 251,-177.5 245,-177.5 239,-171.5 239,-165.5 239,-165.5 239,-136.5 239,-136.5 239,-130.5 245,-124.5 251,-124.5 251,-124.5 301,-124.5 301,-124.5 307,-124.5 313,-130.5 313,-136.5 313,-136.5 313,-165.5 313,-165.5 313,-171.5 307,-177.5 301,-177.5"></path>
<text text-anchor="middle" x="276" y="-162.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">succeded</text>
<text text-anchor="middle" x="276" y="-147.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">with</text>
<text text-anchor="middle" x="276" y="-132.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">warning</text>
</g>
<!-- processing&#45;&gt;succeeded_with_warning -->
<g id="edge2" class="edge">
<title>processing-&gt;succeeded_with_warning</title>
<path fill="none" stroke="#000000" d="M191.8141,-106.0533C203.6512,-112.3731 217.1535,-119.582 229.8262,-126.3479"></path>
<polygon fill="#000000" stroke="#000000" points="228.4016,-129.5549 238.8715,-131.1772 231.6985,-123.3799 228.4016,-129.5549"></polygon>
</g>
<!-- succeeded -->
<g id="node4" class="node">
<title>succeeded</title>
<path fill="#ffffff" stroke="#ffffff" d="M305,-106C305,-106 247,-106 247,-106 241,-106 235,-100 235,-94 235,-94 235,-82 235,-82 235,-76 241,-70 247,-70 247,-70 305,-70 305,-70 311,-70 317,-76 317,-82 317,-82 317,-94 317,-94 317,-100 311,-106 305,-106"></path>
<text text-anchor="middle" x="276" y="-84.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">succeeded</text>
</g>
<!-- processing&#45;&gt;succeeded -->
<g id="edge3" class="edge">
<title>processing-&gt;succeeded</title>
<path fill="none" stroke="#000000" d="M199.2707,-88C207.492,-88 216.2197,-88 224.7292,-88"></path>
<polygon fill="#000000" stroke="#000000" points="224.9519,-91.5001 234.9519,-88 224.9519,-84.5001 224.9519,-91.5001"></polygon>
</g>
<!-- error -->
<g id="node5" class="node">
<title>error</title>
<path fill="#ffffff" stroke="#ffffff" d="M291,-52C291,-52 261,-52 261,-52 255,-52 249,-46 249,-40 249,-40 249,-28 249,-28 249,-22 255,-16 261,-16 261,-16 291,-16 291,-16 297,-16 303,-22 303,-28 303,-28 303,-40 303,-40 303,-46 297,-52 291,-52"></path>
<text text-anchor="middle" x="276" y="-30.3" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">error</text>
</g>
<!-- processing&#45;&gt;error -->
<g id="edge4" class="edge">
<title>processing-&gt;error</title>
<path fill="none" stroke="#000000" d="M197.6206,-69.8686C211.1975,-63.6554 226.3146,-56.7374 239.6223,-50.6474"></path>
<polygon fill="#000000" stroke="#000000" points="241.308,-53.7252 248.9446,-46.3813 238.3951,-47.36 241.308,-53.7252"></polygon>
</g>
</g>
</svg>
</div>
<p>For the start, the transfer table has some kind of <code>request</code> and some kind of <code>response</code>.</p>
<pre><code>CREATE TABLE transfer (
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    status transfer_status NOT NULL DEFAULT 'pending',
    request JSONB NOT NULL,
    result JSONB
);</code></pre>
<p>A simple insert like</p>
<pre><code>INSERT INTO transfer (request) 
    VALUES ('{&quot;some_data&quot; : &quot;values&quot;}'::JSONB);</code></pre>
<p>should be enough, to communicate with the database.</p>
<p>Now it is time to fill this <code>request</code> object with life. First we define some keys, which are mandatory for every request.</p>
<ul>
<li>The <code>entity</code> key defines the entity known to the database. (e.g. <code>customer</code> or <code>purchase_order</code>)</li>
<li>The <code>payload</code> is the actual data</li>
<li>The <code>action</code> key tells the database, what to do with the <code>payload</code>. Valid actions for now are <code>select</code>, <code>upsert</code> and <code>delete</code></li>
</ul>
<p>The trigger function is the entry point for every data access.</p>
<pre><code>CREATE FUNCTION transfer_trigger_function() RETURNS TRIGGER AS $$
DECLARE
BEGIN
    CASE NEW.request-&gt;&gt;'entity'
        WHEN 'customer' THEN
            SELECT customer_manager(NEW.id, NEW.request) INTO NEW.response;
        ELSE
            RAISE EXCEPTION 'not a valid entity';
    END CASE;
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER transfer_after_trigger BEFORE INSERT ON transfer
    FOR EACH ROW EXECUTE PROCEDURE transfer_trigger_function();</code></pre>
<p>As you can see, you can access the <code>request</code> data from within the trigger function via <a href="https://www.postgresql.org/docs/current/static/functions-json.html">build in json functions</a>.</p>
<p>There shouldn’t be much logic in the transfer trigger. The entity managers should do the “hard work”.</p>
<p>Due to this is a trigger function, you should be aware of nesting functions too much. You should not update the <code>transfer</code> table out of the trigger function it self. This can lead to infinite loops.</p>
<h1 id="customer-entity-manager">customer entity manager</h1>
<p>Every entity manager should perform the <code>select</code>, <code>upsert</code> and <code>delete</code> tasks. Let’s take the <code>customer</code> as an example.</p>
<h2 id="select">select</h2>
<p>When every root entity like the <code>customer</code> relation has a <code>json_view</code> column, this should be the result for a select operation. In the first step, the request can look like</p>
<pre><code>{
    &quot;entity&quot; : &quot;customer&quot;,
    &quot;action&quot; : &quot;select&quot;,
    &quot;payload&quot; : { 
        &quot;id&quot; : &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot; 
    }
}</code></pre>
<p>The <code>customer_manager</code> checks if the action is valid and calls the assigned function.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
        WHEN 'select' THEN
            SELECT customer_manager_select(request-&gt;'payload') INTO raw_response;
        ELSE
            RAISE EXCEPTION 'not a valid action';
    END CASE;
    
    RETURN raw_response;
END
$$ LANGUAGE plpgsql; </code></pre>
<p>The <code>customer_manager_select</code> function takes the payload and returns the <code>json_view</code> of the customer as a response.</p>
<pre><code>CREATE FUNCTION customer_manager_select(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE 
    raw_result JSONB;
BEGIN
    SELECT json_view FROM customer WHERE id = (raw_payload-&gt;&gt;'id')::UUID INTO raw_result;

    raw_result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }' || jsonb_build_object('data', raw_result);

    RETURN raw_result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>An</p>
<pre><code>INSERT INTO transfer (request) 
    VALUES ('{ &quot;entity&quot; : &quot;customer&quot;, &quot;action&quot; : &quot;select&quot;, &quot;payload&quot; : { &quot;id&quot; : &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot; } }'::JSONB);</code></pre>
<p>will result into the following row.</p>
<pre><code>                  id                  | status  |                                                request                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  response                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |         created_at         |         updated_at         
--------------------------------------+---------+-------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------
 874c1126-8ea6-4609-9c6d-ed52fc8bb682 | pending | {&quot;action&quot;: &quot;select&quot;, &quot;entity&quot;: &quot;customer&quot;, &quot;payload&quot;: {&quot;id&quot;: &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot;}} | {&quot;data&quot;: {&quot;id&quot;: &quot;162a5041-14ba-442e-bc1b-a062b9926d49&quot;, &quot;person&quot;: {&quot;id&quot;: &quot;0ec888ea-b84b-4dab-97fc-c1a6fb8ff313&quot;, &quot;notes&quot;: null, &quot;website&quot;: null, &quot;addresses&quot;: [{&quot;id&quot;: &quot;06690a9c-92ea-4791-8922-e4e2da7f8991&quot;, &quot;city&quot;: &quot;Dortmund&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44339&quot;, &quot;address_type&quot;: &quot;private&quot;, &quot;house_number&quot;: &quot;123&quot;}, {&quot;id&quot;: &quot;e81b9449-7c0e-4d39-993e-e483064dd6c9&quot;, &quot;city&quot;: &quot;Bochum&quot;, &quot;street&quot;: &quot;Fakestreet&quot;, &quot;postal_code&quot;: &quot;44866&quot;, &quot;address_type&quot;: &quot;work&quot;, &quot;house_number&quot;: &quot;321&quot;}], &quot;last_name&quot;: &quot;Hake&quot;, &quot;birth_date&quot;: null, &quot;first_name&quot;: &quot;Jan Frederik&quot;, &quot;phone_numbers&quot;: [{&quot;id&quot;: &quot;6c09f794-45f4-4746-ba0b-2a6ae9f8dd97&quot;, &quot;phone_number&quot;: &quot;+49123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;landline&quot;, &quot;is_primary_phone_number&quot;: true}, {&quot;id&quot;: &quot;5e08670f-0cf7-46b4-9c0b-40b87a727607&quot;, &quot;phone_number&quot;: &quot;+49151123456789&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;communication_network&quot;: &quot;cellular_network&quot;, &quot;is_primary_phone_number&quot;: false}], &quot;email_addresses&quot;: [{&quot;id&quot;: &quot;815fe354-b157-422e-b3c3-6686fead0152&quot;, &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;, &quot;communication_type&quot;: &quot;private&quot;, &quot;is_primary_email_address&quot;: false}]}, &quot;customer_number&quot;: &quot;AB123456&quot;}, &quot;status&quot;: &quot;ok&quot;, &quot;error_code&quot;: 0} | 2017-07-31 10:13:46.250357 | 2017-07-31 10:13:46.250357</code></pre>
<p>This is a fist shoot. The <code>response</code> can be quite big, so this should be refactored later. You might also want to build a <code>WHERE</code> clause out of the <code>payload</code> (e.g. Give me all customers living in Hamburg)</p>
<h2 id="delete">delete</h2>
<p>The <code>delete</code> action works with the root <code>id</code>.</p>
<pre><code>{
    &quot;entity&quot; : &quot;customer&quot;,
    &quot;action&quot; : &quot;delete&quot;,
    &quot;payload&quot; : { 
        &quot;id&quot; : &quot;29e2fa06-edfc-49ed-878b-49e8ded9bb89&quot; 
    }
}</code></pre>
<p>The <code>customer_manager</code> must be extended for the <code>delete</code> action.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
        WHEN 'select' THEN
            SELECT customer_manager_select(request-&gt;'payload') INTO raw_response;
        WHEN 'delete' THEN
            SELECT customer_manager_delete(request-&gt;'payload') INTO raw_response;
        ELSE
            RAISE EXCEPTION 'not a valid action';
    END CASE;
    
    RETURN raw_response;
END
$$ LANGUAGE plpgsql; </code></pre>
<p>The simplest approach would be</p>
<pre><code>CREATE FUNCTION customer_manager_delete(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE 
    raw_result JSONB;
BEGIN
    DELETE FROM customer WHERE id = (raw_payload-&gt;&gt;'id')::UUID;

    raw_result := ('{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0, &quot;data&quot; : { &quot;id&quot; : &quot;' || (raw_payload-&gt;&gt;'id') || '&quot;}}')::JSONB;

    RETURN raw_result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This will work, if the <code>customer</code> has no reference to other tables. After a first <code>purchase_order</code> is created, deletion won’t work any more, due to referential integrity constraints. This is an issue, to think about. In Germany for example, you have to store invoices for several years. This means, customers won’t be deleted, until there last invoice is deleted. There is one approach, to set a own <code>deleted</code> property for a <code>customer</code>. This property is very handy, so it can be included into the post <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> script.</p>
<pre><code>CREATE FUNCTION add_metadata_to_every_table() RETURNS VOID AS $$
DECLARE 
    row record;
BEGIN
    FOR row IN SELECT tablename FROM pg_tables WHERE schemaname = 'test' LOOP

        -- ...   
        EXECUTE 'ALTER TABLE ' || row.tablename || 
            ' ADD COLUMN deleted boolean NOT NULL DEFAULT false';
        -- ...

    END LOOP;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>Now every table has a <code>deleted</code> column.</p>
<p>Now the <code>customer_manager_select</code> looks like</p>
<pre><code>CREATE FUNCTION customer_manager_delete(raw_payload JSONB) RETURNS JSONB AS $$
BEGIN
    UPDATE customer SET deleted = true WHERE id = (raw_payload-&gt;&gt;'id')::UUID;

    RETURN ('{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0, &quot;data&quot; : { &quot;id&quot; : &quot;' || (raw_payload-&gt;&gt;'id') || '&quot;}}')::JSONB;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>It might be handy, if a <code>deleted</code> record can’t be updated any more. The <code>metadata_trigger</code> is a good place for checking for the <code>deleted</code> column.</p>
<pre><code>CREATE FUNCTION metadata_trigger() RETURNS TRIGGER AS $$
BEGIN
    IF NEW.deleted = true THEN
        RAISE EXCEPTION 'can not update the deleted record %', NEW.id::text;
    END IF;

    NEW.updated_at := now();
    RETURN NEW;
END
$$ LANGUAGE plpgsql;</code></pre>
<h2 id="upsert">upsert</h2>
<p>Let’s start with a <a href="../posts/2017-07-15-database-architecture-part2.html#customer">known customer</a>.</p>
<pre><code>    &quot;person&quot;: {
        &quot;addresses&quot;: [{
            &quot;city&quot;: &quot;Dortmund&quot;,
            &quot;street&quot;: &quot;Fakestreet&quot;,
            &quot;postal_code&quot;: &quot;44339&quot;,
            &quot;address_type&quot;: &quot;private&quot;,
            &quot;house_number&quot;: &quot;123&quot;
        }, {
            &quot;city&quot;: &quot;Bochum&quot;,
            &quot;street&quot;: &quot;Fakestreet&quot;,
            &quot;postal_code&quot;: &quot;44866&quot;,
            &quot;address_type&quot;: &quot;work&quot;,
            &quot;house_number&quot;: &quot;321&quot;
        }],
        &quot;last_name&quot;: &quot;Hake&quot;,
        &quot;first_name&quot;: &quot;Jan Frederik&quot;,
        &quot;phone_numbers&quot;: [{
            &quot;phone_number&quot;: &quot;+49123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;landline&quot;
        }, {
            &quot;phone_number&quot;: &quot;+49151123456789&quot;,
            &quot;communication_type&quot;: &quot;private&quot;,
            &quot;communication_network&quot;: &quot;cellular_network&quot;
        }],
        &quot;email_addresses&quot;: [{
            &quot;email_address&quot;: &quot;jan_hake@fake.de&quot;,
            &quot;communication_type&quot;: &quot;private&quot;
        }]
    }
}</code></pre>
<p>As you can see, there are no <code>id</code>s or <code>customer_numbers</code> present in the whole entity. For this example, a new customer is assumed. Imagine, you have a web form, where you enter your data. When you’re ready with editing, this might be a result for a customer.</p>
<p>So we first take a look at a possible insert function.</p>
<p>For now, we use a simple customer number generator.</p>
<pre><code>CREATE FUNCTION customer_number() RETURNS text AS $$
    from random import randint
    return &quot;AB%05d&quot; % randint(0,99999)
$$ LANGUAGE plpython3u;</code></pre>
<p>The default value of the <code>customer_number</code> must be changed to</p>
<pre><code>ALTER TABLE customer ALTER COLUMN customer_number SET DEFAULT customer_number();</code></pre>
<p>For a new <code>customer</code>, only <code>person</code> data is needed. The <code>customer_manager</code> has to be extended.</p>
<pre><code>CREATE FUNCTION customer_manager(request JSONB) RETURNS JSONB AS $$
DECLARE
    raw_response JSON;
BEGIN
    CASE request-&gt;&gt;'action'
       -- ...
       WHEN 'upsert' THEN
            SELECT customer_manager_upsert(request-&gt;'payload') INTO raw_response;
       -- ...  
    END CASE; 
$$ LANGUAGE plpgsql; </code></pre>
<p>We insert this new <code>customer</code>.</p>
<pre><code>CREATE FUNCTION customer_manager_upsert(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE
    person_id UUID;
    customer_id UUID;
    result JSONB;
BEGIN
    INSERT INTO person (first_name, last_name, birth_date, notes, website)
         VALUES (raw_payload#&gt;&gt;'{person,first_name}', 
             raw_payload#&gt;&gt;'{person,last_name}',
             (raw_payload#&gt;&gt;'{person,birth_date}')::DATE,
             raw_payload#&gt;&gt;'{person,notes}',
             raw_payload#&gt;&gt;'{person,website}') RETURNING id INTO person_id;
   
    INSERT INTO customer (id_person) VALUES (person_id) RETURNING id INTO customer_id;

    PERFORM update_json_view_customer(customer_id);

    SELECT json_view FROM customer WHERE id = customer_id INTO result;

    result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }'::JSONB || jsonb_build_object('data', result);

    RETURN result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This creates a new <code>customer</code> with a new <code>person</code>. The <code>update_json_view_customer</code> <a href="../posts/2017-07-15-database-architecture-part2.html#customer">function</a> will update the <code>json_view</code> of the <code>customer</code>.</p>
<pre><code>{
    &quot;id&quot;: &quot;46624c40-c50a-478e-83e9-9117d7b87f39&quot;,
    &quot;person&quot;: {
        &quot;id&quot;: &quot;81b46e11-cdef-4a71-b850-68882b474c90&quot;,
        &quot;notes&quot;: null,
        &quot;website&quot;: null,
        &quot;addresses&quot;: null,
        &quot;last_name&quot;: &quot;Hake&quot;,
        &quot;birth_date&quot;: null,
        &quot;first_name&quot;: &quot;Jan Frederik&quot;,
        &quot;phone_numbers&quot;: null,
        &quot;email_addresses&quot;: null
    },
    &quot;customer_number&quot;: &quot;AB19856&quot;
}</code></pre>
<p>For the addresses, we have to loop through the nested json array</p>
<pre><code>IF raw_payload#&gt;'{person}' ? 'addresses' THEN
    FOR address in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,addresses}') 
    LOOP
        INSERT INTO address (street, house_number, postal_code, city)
            VALUES (address-&gt;&gt;'street', 
                address-&gt;&gt;'house_number', 
                address-&gt;&gt;'postal_code', 
                address-&gt;&gt;'city')
            RETURNING id INTO address_id;

        INSERT INTO person_to_address (id_person, id_address)
            VALUES (person_id, address_id);
    END LOOP;
END IF;</code></pre>
<p>The phone numbers can be added with the following loop.</p>
<pre><code>IF raw_payload#&gt;'{person}' ? 'phone_numbers' THEN
    FOR phone in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,phone_numbers}') 
    LOOP
        INSERT INTO phone (phone_number, communication_network)
            VALUES (phone-&gt;&gt;'phone_number', 
                (phone-&gt;&gt;'communication_network')::communication_network)
            RETURNING id INTO phone_id;

        INSERT INTO person_to_phone (id_person, id_phone, communication_type)
            VALUES (person_id,  phone_id, (phone-&gt;&gt;'communication_type')::communication_type);
    END LOOP;
END IF;</code></pre>
<p>As you can see, the <code>communication_network</code> and <code>communication_type</code> have to be casted. This is good. Cast errors will cause an exception. This kind of type safety will help during more complex events.</p>
<p>Together we have</p>
<pre><code>CREATE FUNCTION customer_manager_upsert(raw_payload JSONB) RETURNS JSONB AS $$
DECLARE
    person_id UUID;
    customer_id UUID; 
    address_id UUID;
    phone_id UUID;
    email_id UUID;
    address JSONB;
    phone JSONB;
    email JSONB;
    result JSONB;
BEGIN
    INSERT INTO person (first_name, last_name, birth_date, notes, website)
         VALUES (raw_payload#&gt;&gt;'{person,first_name}', 
             raw_payload#&gt;&gt;'{person,last_name}',
             (raw_payload#&gt;&gt;'{person,birth_date}')::DATE,
             raw_payload#&gt;&gt;'{person,notes}',
             raw_payload#&gt;&gt;'{person,website}') RETURNING id INTO person_id;

    IF raw_payload#&gt;'{person}' ? 'addresses' THEN
        FOR address in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,addresses}') 
        LOOP
            INSERT INTO address (street, house_number, postal_code, city)
                VALUES (address-&gt;&gt;'street', 
                    address-&gt;&gt;'house_number', 
                    address-&gt;&gt;'postal_code', 
                    address-&gt;&gt;'city')
                RETURNING id INTO address_id;

            INSERT INTO person_to_address (id_person, id_address)
                VALUES (person_id, address_id);
        END LOOP;
    END IF;

    IF raw_payload#&gt;'{person}' ? 'phone_numbers' THEN
        FOR phone in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,phone_numbers}') 
        LOOP
            INSERT INTO phone (phone_number, communication_network)
                VALUES (phone-&gt;&gt;'phone_number', 
                    (phone-&gt;&gt;'communication_network')::communication_network)
                RETURNING id INTO phone_id;

            INSERT INTO person_to_phone (id_person, id_phone, communication_type)
                VALUES (person_id,  phone_id, (phone-&gt;&gt;'communication_type')::communication_type);
        END LOOP;
    END IF;

    IF raw_payload#&gt;'{person}' ? 'email_addresses' THEN
        FOR email in SELECT * FROM jsonb_array_elements(raw_payload#&gt;'{person,email_addresses}') 
        LOOP
            INSERT INTO email (email_address)
                VALUES (email-&gt;&gt;'email_address') 
                RETURNING id INTO email_id;

            INSERT INTO person_to_email (id_person, id_email, communication_type)
                VALUES (person_id, email_id, (email-&gt;&gt;'communication_type')::communication_type);
        END LOOP;
    END IF;
    
    INSERT INTO customer (id_person) VALUES (person_id) RETURNING id INTO customer_id;

    PERFORM update_json_view_customer(customer_id);

    SELECT json_view FROM customer WHERE id = customer_id INTO result;

    result = '{ &quot;status&quot; : &quot;ok&quot;, &quot;error_code&quot;: 0 }'::JSONB || jsonb_build_object('data', result);

    RETURN result;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>This is a best case scenario. There are no duplicate checks for example. Maybe, the upsert function needs some rewrite in a more compact language like <a href="https://www.postgresql.org/docs/current/static/plpython.html">PL/Python</a>.</p>

        </section>

        <section id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons Lizenzvertrag" style="border-width:0;vertical-align:middle;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
            </a>
        </section>
    </body>
</html>
