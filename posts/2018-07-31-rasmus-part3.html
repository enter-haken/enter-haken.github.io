<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>enter_haken - first steps with rasmus</title>
        <!--<link rel="stylesheet" type="text/css" href="/css/default.css" />-->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
        <link rel="stylesheet" type="text/css" href="../css/milligram.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <script src="js/vis.min.js"></script>
    </head>
    <body>
        <section id="navigation">
            <a href="../">enter_haken</a>
            <a href="../projects.html">projects</a>
            <a href="../cookbook.html">cookbook</a>
            <a href="../notes.html">notes</a>
            <a href="../read.html">read</a>
            <a href="../about.html">about</a>
        </section>

        <section id="content">
            <h1>first steps with rasmus</h1>

<div class="info">
    
    Posted on July 31, 2018
    
        
</div>

<p>Having the first parts of <code>rasmus</code> <a href="../posts/2018-07-23-rasmus-part2.html">in motion</a>, I started my first tests. There is no user management yet and the frontend is somehow static. So the first inserts will be made via <code>curl</code>.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.42.3 (20191010.1750)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="375pt" height="638pt" viewBox="0.00 0.00 375.00 638.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 634)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-634 371,-634 371,4 -4,4"></polygon>
<!-- curl -->
<g id="node1" class="node">
<title>curl</title>
<path fill="white" stroke="white" d="M286,-630C286,-630 230,-630 230,-630 224,-630 218,-624 218,-618 218,-618 218,-606 218,-606 218,-600 224,-594 230,-594 230,-594 286,-594 286,-594 292,-594 298,-600 298,-606 298,-606 298,-618 298,-618 298,-624 292,-630 286,-630"></path>
<text text-anchor="start" x="243.5" y="-615.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="247.5" y="-615.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">curl</text>
<text text-anchor="start" x="226" y="-601.8" font-family="Helvetica,sans-Serif" font-size="14.00">web client </text>
</g>
<!-- router -->
<g id="node2" class="node">
<title>router</title>
<path fill="white" stroke="white" d="M288,-547C288,-547 228,-547 228,-547 222,-547 216,-541 216,-535 216,-535 216,-509 216,-509 216,-503 222,-497 228,-497 228,-497 288,-497 288,-497 294,-497 300,-503 300,-509 300,-509 300,-535 300,-535 300,-541 294,-547 288,-547"></path>
<text text-anchor="start" x="236" y="-532.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="240" y="-532.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">router</text>
<text text-anchor="start" x="227.5" y="-518.8" font-family="Helvetica,sans-Serif" font-size="14.00">managing</text>
<text text-anchor="start" x="224" y="-504.8" font-family="Helvetica,sans-Serif" font-size="14.00">http routes </text>
</g>
<!-- curl&#45;&gt;router -->
<g id="edge1" class="edge">
<title>curl-&gt;router</title>
<path fill="none" stroke="black" d="M258,-593.61C258,-583.2 258,-569.61 258,-557.14"></path>
<polygon fill="black" stroke="black" points="261.5,-557.01 258,-547.01 254.5,-557.01 261.5,-557.01"></polygon>
<text text-anchor="start" x="258" y="-569" font-family="Helvetica,sans-Serif" font-size="10.00"> </text>
<text text-anchor="start" x="262" y="-569" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00">POST</text>
<text text-anchor="start" x="290" y="-569" font-family="Helvetica,sans-Serif" font-size="10.00"> request </text>
</g>
<!-- inbound -->
<g id="node3" class="node">
<title>inbound</title>
<path fill="white" stroke="white" d="M264,-450C264,-450 154,-450 154,-450 148,-450 142,-444 142,-438 142,-438 142,-412 142,-412 142,-406 148,-400 154,-400 154,-400 264,-400 264,-400 270,-400 276,-406 276,-412 276,-412 276,-438 276,-438 276,-444 270,-450 264,-450"></path>
<text text-anchor="start" x="180" y="-435.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="184" y="-435.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">inbound</text>
<text text-anchor="start" x="150" y="-421.8" font-family="Helvetica,sans-Serif" font-size="14.00">add entities into the</text>
<text text-anchor="start" x="167.5" y="-407.8" font-family="Helvetica,sans-Serif" font-size="14.00">transfer table </text>
</g>
<!-- router&#45;&gt;inbound -->
<g id="edge2" class="edge">
<title>router-&gt;inbound</title>
<path fill="none" stroke="black" d="M245.38,-496.54C239.51,-485.14 232.43,-471.42 226.08,-459.12"></path>
<polygon fill="black" stroke="black" points="229.1,-457.34 221.41,-450.05 222.88,-460.54 229.1,-457.34"></polygon>
<text text-anchor="start" x="235" y="-471" font-family="Helvetica,sans-Serif" font-size="10.00"> validation </text>
</g>
<!-- transfer -->
<g id="node5" class="node">
<title>transfer</title>
<path fill="white" stroke="white" d="M248.5,-342C248.5,-342 125.5,-342 125.5,-342 119.5,-342 113.5,-336 113.5,-330 113.5,-330 113.5,-318 113.5,-318 113.5,-312 119.5,-306 125.5,-306 125.5,-306 248.5,-306 248.5,-306 254.5,-306 260.5,-312 260.5,-318 260.5,-318 260.5,-330 260.5,-330 260.5,-336 254.5,-342 248.5,-342"></path>
<text text-anchor="start" x="159.5" y="-327.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="163.5" y="-327.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">transfer</text>
<text text-anchor="start" x="121.5" y="-313.8" font-family="Helvetica,sans-Serif" font-size="14.00">database gatekeeper </text>
</g>
<!-- inbound&#45;&gt;transfer -->
<g id="edge4" class="edge">
<title>inbound-&gt;transfer</title>
<path fill="none" stroke="black" d="M203.62,-399.78C200.42,-385.41 196.37,-367.15 193.06,-352.27"></path>
<polygon fill="black" stroke="black" points="196.4,-351.14 190.81,-342.14 189.56,-352.66 196.4,-351.14"></polygon>
<text text-anchor="start" x="200" y="-374" font-family="Helvetica,sans-Serif" font-size="10.00"> insert into</text>
<text text-anchor="start" x="201.5" y="-363" font-family="Helvetica,sans-Serif" font-size="10.00">database </text>
</g>
<!-- socket -->
<g id="node4" class="node">
<title>socket</title>
<path fill="white" stroke="white" d="M312.5,-36C312.5,-36 215.5,-36 215.5,-36 209.5,-36 203.5,-30 203.5,-24 203.5,-24 203.5,-12 203.5,-12 203.5,-6 209.5,0 215.5,0 215.5,0 312.5,0 312.5,0 318.5,0 324.5,-6 324.5,-12 324.5,-12 324.5,-24 324.5,-24 324.5,-30 318.5,-36 312.5,-36"></path>
<text text-anchor="start" x="227" y="-21.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="231" y="-21.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">websocket</text>
<text text-anchor="start" x="211.5" y="-7.8" font-family="Helvetica,sans-Serif" font-size="14.00">client connection </text>
</g>
<!-- socket&#45;&gt;router -->
<g id="edge3" class="edge">
<title>socket-&gt;router</title>
<path fill="none" stroke="black" d="M280.25,-36.09C284.63,-41.48 288.99,-47.68 292,-54 304.53,-80.28 306,-88.88 306,-118 306,-426 306,-426 306,-426 306,-448.34 295.29,-470.78 283.99,-488.23"></path>
<polygon fill="black" stroke="black" points="280.83,-486.64 278.08,-496.87 286.61,-490.59 280.83,-486.64"></polygon>
<text text-anchor="start" x="306" y="-275.5" font-family="Helvetica,sans-Serif" font-size="10.00"> backchannel </text>
</g>
<!-- counter -->
<g id="node6" class="node">
<title>counter</title>
<path fill="white" stroke="white" d="M199,-250C199,-250 85,-250 85,-250 79,-250 73,-244 73,-238 73,-238 73,-212 73,-212 73,-206 79,-200 85,-200 85,-200 199,-200 199,-200 205,-200 211,-206 211,-212 211,-212 211,-238 211,-238 211,-244 205,-250 199,-250"></path>
<text text-anchor="start" x="115" y="-235.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="119" y="-235.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">counter</text>
<text text-anchor="start" x="81" y="-221.8" font-family="Helvetica,sans-Serif" font-size="14.00">Postgres notification</text>
<text text-anchor="start" x="118" y="-207.8" font-family="Helvetica,sans-Serif" font-size="14.00">listener </text>
</g>
<!-- transfer&#45;&gt;counter -->
<g id="edge5" class="edge">
<title>transfer-&gt;counter</title>
<path fill="none" stroke="black" d="M178.95,-305.66C173.01,-292.84 164.73,-274.99 157.51,-259.44"></path>
<polygon fill="black" stroke="black" points="160.57,-257.71 153.19,-250.11 154.22,-260.66 160.57,-257.71"></polygon>
<text text-anchor="start" x="171.5" y="-281" font-family="Helvetica,sans-Serif" font-size="10.00"> send a</text>
<text text-anchor="start" x="170" y="-271" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00">receipt</text>
<text text-anchor="start" x="202" y="-271" font-family="Helvetica,sans-Serif" font-size="10.00"> </text>
</g>
<!-- manager -->
<g id="node7" class="node">
<title>manager</title>
<path fill="white" stroke="white" d="M122,-144C122,-144 12,-144 12,-144 6,-144 0,-138 0,-132 0,-132 0,-106 0,-106 0,-100 6,-94 12,-94 12,-94 122,-94 122,-94 128,-94 134,-100 134,-106 134,-106 134,-132 134,-132 134,-138 128,-144 122,-144"></path>
<text text-anchor="start" x="36" y="-129.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="40" y="-129.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">manager</text>
<text text-anchor="start" x="34" y="-115.8" font-family="Helvetica,sans-Serif" font-size="14.00">executes a</text>
<text text-anchor="start" x="8" y="-101.8" font-family="Helvetica,sans-Serif" font-size="14.00">database manager </text>
</g>
<!-- counter&#45;&gt;manager -->
<g id="edge6" class="edge">
<title>counter-&gt;manager</title>
<path fill="none" stroke="black" d="M72.66,-202.75C64.08,-197.31 56.44,-190.5 51,-182 45.56,-173.5 45.99,-163.24 48.81,-153.53"></path>
<polygon fill="black" stroke="black" points="52.11,-154.68 52.3,-144.09 45.55,-152.26 52.11,-154.68"></polygon>
<text text-anchor="start" x="51" y="-175" font-family="Helvetica,sans-Serif" font-size="10.00"> executes the</text>
<text text-anchor="start" x="58.5" y="-165" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00">manager</text>
<text text-anchor="start" x="99.5" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00"> </text>
</g>
<!-- graph_elixir -->
<g id="node8" class="node">
<title>graph_elixir</title>
<path fill="white" stroke="white" d="M266,-137C266,-137 180,-137 180,-137 174,-137 168,-131 168,-125 168,-125 168,-113 168,-113 168,-107 174,-101 180,-101 180,-101 266,-101 266,-101 272,-101 278,-107 278,-113 278,-113 278,-125 278,-125 278,-131 272,-137 266,-137"></path>
<text text-anchor="start" x="202" y="-122.8" font-family="Helvetica,sans-Serif" font-size="14.00"> </text>
<text text-anchor="start" x="206" y="-122.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00">graph</text>
<text text-anchor="start" x="176" y="-108.8" font-family="Helvetica,sans-Serif" font-size="14.00">entity manager </text>
</g>
<!-- counter&#45;&gt;graph_elixir -->
<g id="edge8" class="edge">
<title>counter-&gt;graph_elixir</title>
<path fill="none" stroke="black" d="M179.34,-199.78C185.78,-194.46 192,-188.46 197,-182 205.06,-171.57 211.07,-158.28 215.27,-146.68"></path>
<polygon fill="black" stroke="black" points="218.64,-147.63 218.5,-137.03 212,-145.41 218.64,-147.63"></polygon>
<text text-anchor="start" x="209" y="-175" font-family="Helvetica,sans-Serif" font-size="10.00"> load the result</text>
<text text-anchor="start" x="210" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00">from </text>
<text text-anchor="start" x="233" y="-165" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00">transfer</text>
<text text-anchor="start" x="269" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00"> </text>
</g>
<!-- manager&#45;&gt;counter -->
<g id="edge7" class="edge">
<title>manager-&gt;counter</title>
<path fill="none" stroke="black" d="M95.52,-144.42C101.03,-149.89 106.48,-155.88 111,-162 117.43,-170.71 123.18,-180.96 127.92,-190.59"></path>
<polygon fill="black" stroke="black" points="124.89,-192.37 132.31,-199.93 131.22,-189.39 124.89,-192.37"></polygon>
<text text-anchor="start" x="124" y="-169.5" font-family="Helvetica,sans-Serif" font-size="10.00"> gets the result </text>
</g>
<!-- graph_elixir&#45;&gt;socket -->
<g id="edge9" class="edge">
<title>graph_elixir-&gt;socket</title>
<path fill="none" stroke="black" d="M228.46,-100.92C232.79,-87.89 239.22,-69.59 246,-54 247.24,-51.15 248.61,-48.2 250.02,-45.29"></path>
<polygon fill="black" stroke="black" points="253.21,-46.74 254.57,-36.23 246.95,-43.59 253.21,-46.74"></polygon>
<text text-anchor="start" x="246" y="-68" font-family="Helvetica,sans-Serif" font-size="10.00">update the</text>
<text text-anchor="start" x="257" y="-57" font-family="Helvetica,sans-Serif" font-size="10.00">client</text>
</g>
</g>
</svg>
</div>
<p>The <code>backchannel</code> isn’t in place yet.</p>
<p>Currently you can see the result in the <code>rasmus</code> log. Let’s demonstrate this workflow with an example.</p>
<!--more-->
<h1 id="router">router</h1>
<p>At first a <code>user</code> must be inserted into the database.</p>
<pre><code>API_URL=&quot;http://localhost:8080/api&quot;

curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
   &quot;entity&quot;: &quot;user&quot;,
   &quot;data&quot;: {
     &quot;first_name&quot;: &quot;Jan Frederik&quot;,
     &quot;last_name&quot;: &quot;Hake&quot;,
     &quot;email_address&quot;: &quot;jan_hake@gmx.de&quot;,
     &quot;login&quot;: &quot;jan_hake&quot;
   }
}
BODY</code></pre>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex">router</a> make some simple checks on the posted json data.</p>
<pre><code>post &quot;/api&quot; do
    with {:ok, action} &lt;- get_action_from(conn.body_params),
         {:ok, entity}  &lt;- get_entity_from(conn.body_params),
         {:ok, data } &lt;- get_data_from(conn.body_params)
    do
      Logger.info(&quot;Got #{action} for #{entity} with #{inspect(data)}&quot;)

      Core.Inbound.add(conn.body_params)

      conn
      |&gt; send_resp(200, get_succeeded_response())
    else
      {:error, message} -&gt;
        Logger.warn(&quot;Got malformed request: #{message}&quot;)

        conn
        |&gt; send_resp(422, get_error_response(message))
    end
end</code></pre>
<p>Only the <code>actions</code> in</p>
<pre><code>@actions [&quot;add&quot;,&quot;update&quot;,&quot;get&quot;,&quot;delete&quot;]</code></pre>
<p>will be valid <code>actions</code>.</p>
<pre><code>defp get_action_from(%{ &quot;action&quot; =&gt;  action } = _body_params) do
    case Enum.member?(@actions, action) do
      true -&gt; {:ok, action }
      _ -&gt; { :error, &quot;Action '#{action}' is not valid. Valid actions are #{get_quoted(@actions)}&quot;}
    end
  end

defp get_action_from(_body_params), do: { :error, &quot;action is missing. Valid actions are #{get_quoted(@actions)}&quot; }</code></pre>
<p>Otherwise you get into the <code>error</code> path.</p>
<p>The similar things will be checked for valid <code>entities</code>.</p>
<pre><code>@entities [&quot;user&quot;,&quot;privilege&quot;,&quot;role&quot;,&quot;link&quot;,&quot;appointment&quot;,&quot;list&quot;,&quot;graph&quot;]

defp get_entity_from(%{ &quot;entity&quot; =&gt; entity } = _body_params) do
  case Enum.member?(@entities, entity) do
    true -&gt; {:ok, entity }
    _ -&gt; { :error, &quot;Entity '#{entity}' is not valid. Valid entities are #{get_quoted(@entities)}&quot; }
  end
end

defp get_entity_from(_body_params), do: { :error, &quot;entity is missing. Valid entities are #{get_quoted(@entities)}&quot; }</code></pre>
<p>A helper function will make some pretty stuff with the error message.</p>
<pre><code># get_quoted([&quot;a&quot;,&quot;b&quot;]) -&gt; 'a', 'b'
defp get_quoted(strings) do
  strings
  |&gt; Enum.map(fn(x) -&gt; &quot;\'#{x}\'&quot; end)
  |&gt; Enum.join(&quot;, &quot;)
end</code></pre>
<p>If everything has worked as expected,</p>
<pre><code> Core.Inbound.add(conn.body_params)</code></pre>
<p>will add the <code>entity</code> into the database.</p>
<h1 id="inbound">Inbound</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex">inbound</a> <code>GenServer</code> has the task, to insert <code>entities</code> into the database.</p>
<pre><code>def handle_cast({:add, payload}, state) do
  case Postgrex.query(state, &quot;INSERT INTO rasmus.transfer (request) VALUES ($1)&quot;, [payload]) do
    {:ok, result} -&gt; Logger.debug(&quot;added into transfer: #{inspect(result)}&quot;)
    {:error, error} -&gt; Logger.error(&quot;adding into transfer failed: #{inspect(error)}. Tried to add #{inspect(payload)}&quot;)
  end
  {:noreply, state }
end</code></pre>
<p>The <code>client</code> function</p>
<pre><code>def add(entity) do
  GenServer.cast(:inbound_worker, {:add, entity})
end</code></pre>
<p>is called from the <code>router</code>.</p>
<h1 id="transfer">transfer</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql#L35">transfer</a> table it self is quiet simple</p>
<pre><code>CREATE TABLE transfer(
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    state transfer_state NOT NULL DEFAULT 'pending',
    request JSONB NOT NULL,
    response JSONB
);</code></pre>
<p>When a <code>request</code> is inserted, a <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/notifications.sql">notification</a> will be send to the backend.</p>
<pre><code>CREATE FUNCTION send_message(id UUID, state transfer_state, request JSONB, response JSONB) RETURNS VOID AS $$
DECLARE
    message_response JSONB;
BEGIN
    message_response := '[]' || (
        jsonb_build_object('id', id) ||
        jsonb_build_object('state', state) ||
        jsonb_build_object('action', request-&gt;&gt;'action') ||
        jsonb_build_object('entity', request-&gt;&gt;'entity')
    );

    PERFORM pg_notify('rasmus', message_response-&gt;&gt;0);
END
$$ LANGUAGE plpgsql;

CREATE FUNCTION send_transfer_message() RETURNS TRIGGER AS $$
BEGIN 
    PERFORM rasmus.send_message(NEW.id, NEW.state, NEW.request, NEW.response);
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER send_receipt_trigger BEFORE INSERT ON transfer
FOR EACH ROW EXECUTE PROCEDURE send_transfer_message();</code></pre>
<p>At this point, it does not happen very much. This approach will reduce the inbound message queue from the <code>inbound</code> <code>GenServer</code>. Inserting a <code>request</code> should be as fast as possible.</p>
<h1 id="counter">counter</h1>
<p>The <code>counter</code> listens to Postgres notifications,</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
    case Jason.decode(payload) do

      {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; &quot;pending&quot;, }} -&gt; Core.Manager.perform(id)

      #
      # ...
      #

      _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
    end
    {:noreply, {pid, ref}}
end</code></pre>
<p>and calls the corresponding <code>manager</code> within the database.</p>
<h1 id="manager">manager</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex">manager</a> performs the CRUD tasks for every entity.</p>
<p>As you can see in the shortened version,</p>
<pre><code>def handle_cast(transfer_id, state) do
  case Postgrex.query(state, &quot;SELECT rasmus.transfer_manager($1)&quot;, [transfer_id]) do
    {:ok, %{messages: messages}} -&gt;
      if Enum.any?(messages, fn(x) -&gt; x.severity == &quot;WARNING&quot; end) do
        set_succeeded_with_warning_state(state, transfer_id)
      else
         set_succeeded_state(state,transfer_id)
      end

    {:error, %{postgres: %{code: :raise_exception, severity: &quot;ERROR&quot;, message: message, hint: hint}}} -&gt;
      set_error_state(state, transfer_id)
    
    # ...
  end
  {:noreply, state }
end</code></pre>
<p>the <code>state</code> will be updated, after the manager <code>succeeded</code> or <code>failed</code>.</p>
<pre><code>defp set_state(state, transfer_id, sql_function_name, state_name) do
  case Postgrex.query(state, &quot;SELECT rasmus.#{sql_function_name}($1)&quot;, [transfer_id]) do
    {:ok, _} -&gt; Logger.debug(&quot;set state '#{state_name}' for #{transfer_id} succeeded&quot;)
    _ -&gt; Logger.error(&quot;set state '#{state_name}' for #{transfer_id} failed&quot;)
  end
end

defp set_error_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_error&quot;, &quot;error&quot;)
defp set_succeeded_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_succeeded&quot;, &quot;succeeded&quot;)
defp set_succeeded_with_warning_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_succeeded_with_warning&quot;, &quot;succeeded_with_warning&quot;)</code></pre>
<p>The Postgres function <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql#L64">transfer_manager</a> itself looks for the correct manager, and does some checks.</p>
<pre><code>CREATE FUNCTION transfer_manager(transfer_id TEXT) RETURNS VOID AS $$
DECLARE
    transfer_record RECORD;
    transfer_response JSONB;
BEGIN
   SELECT id, state, request, response FROM rasmus.transfer WHERE id = transfer_id::UUID INTO transfer_record;

   CASE transfer_record.request-&gt;&gt;'entity'
       -- ... 
       WHEN 'user' THEN
           BEGIN
               SELECT rasmus.user_manager(transfer_record.request) INTO transfer_response;
               PERFORM rasmus.set_response(transfer_id::UUID, transfer_response);
           END;
       -- ...
       ELSE
           BEGIN
               RAISE EXCEPTION 'entity `%` unknown', transfer_record.request-&gt;&gt;'entity'
                   USING HINT = 'entity must one of link, graph, appointment, list, person, role, privilege or user';
           END;
   END CASE;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>It also puts the <code>result</code> into the <code>response</code> column. If you are interested, what is happening within the <code>rasmus.user_manager</code> you can take a look at the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/user_account.sql">sources</a> for the <code>user_manager</code>.</p>
<p>When the <code>state</code> changes,</p>
<pre><code>CREATE TRIGGER got_response_trigger AFTER UPDATE ON transfer
    FOR EACH ROW 
    WHEN (OLD.state IS DISTINCT FROM NEW.state)
EXECUTE PROCEDURE send_transfer_message();</code></pre>
<p>the <code>counter</code> is informed, that a request is ready for processing.</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
  case Jason.decode(payload) do
    
   # ... 

   {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; state, &quot;entity&quot; =&gt; entity, &quot;action&quot; =&gt; action }} -&gt; 
     Logger.info(&quot;got a request change with state '#{state}' for action '#{action}' and entity '#{entity}' #{id}. ToDo: send message to processes using this entity.&quot;)

   # ...

  _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
  end
  {:noreply, {pid, ref}}
end</code></pre>
<p>At this point, the UI can be informed about an entity change. On a single user system the entity is send back to the client, and the view will be updated. On a multi user system, multiple clients can be updated as well. In the case of <code>rasmus</code>, multiple users can work on the same <code>graph</code> at the same time.</p>
<h1 id="example">example</h1>
<p>As mentioned before, I added a <code>user</code> to the system. Now let’s take a look at a <a href="../posts/2018-07-23-rasmus-part2.html">previous example</a>.</p>
<p><img src="../images/rasmus_frontend.png" /></p>
<p>This graph is described with <code>graphviz</code> code.</p>
<pre><code>graph {
  otp [label = &quot;*OTP tree*\nprocess configuration&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;];
  router [label =&quot;*router*\ncowboy router&quot;, url=&quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;]
  counter [label = &quot;*counter*\nlisten to notifications\nfrom database&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;]
  inbound [label = &quot;*inbound*\nsend requests towards\nthe database&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;]
  manager [label = &quot;*manager*\nexecute the\ndatabase manager&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;]
  client [label = &quot;*client*\nreact / visjs app&quot;, url = &quot;https://github.com/enter-haken/rasmus/tree/master/frontend&quot;]
  configuration [label = &quot;*configuration*\ndatabase configuration&quot;, url = &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;]
  database [label = &quot;*PostgreSQL*&quot;, url =&quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;]
  transfer [label = &quot;*transfer*\ninterface table&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;]
  postcreate [label = &quot;*postcreate*\ntable manipulation\nafter DDL&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;]
  crud [label = &quot;*CRUD*\ngeneric CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;]
  otp -- router [ label = &quot;supervises&quot;]
  otp -- counter [ label = &quot;supervises&quot;]
  otp -- inbound [ label = &quot;supervises&quot;]
  otp -- manager [ label = &quot;supervises&quot;]
  counter -- manager [ label = &quot;executes the\nmanager&quot;]
  counter -- database [ label =&quot;listens for\ndatabase notifications&quot;]
  router -- client [label = &quot;serves&quot;]
  inbound -- transfer [label = &quot;insert request&quot;]
  database -- transfer 
  database -- postcreate
  database -- configuration
  database -- crud
}</code></pre>
<p>Due to there is no frontend, let’s make some <code>curl</code> stuff.</p>
<pre><code>$ curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
   &quot;entity&quot;: &quot;user&quot;,
   &quot;data&quot;: {
     &quot;first_name&quot;: &quot;Jan Frederik&quot;,
     &quot;last_name&quot;: &quot;Hake&quot;,
     &quot;email_address&quot;: &quot;jan_hake@gmx.de&quot;,
     &quot;login&quot;: &quot;jan_hake&quot;
   }
}
BODY</code></pre>
<p>Log entries:</p>
<pre><code>14:35:11.041 module=Plug.Logger [info] POST /api
14:35:11.056 module=Web.Router [info] Got add for user with %{&quot;email_address&quot; =&gt; &quot;jan_hake@gmx.de&quot;, &quot;first_name&quot; =&gt; &quot;Jan Frederik&quot;, &quot;last_name&quot; =&gt; &quot;Hake&quot;, &quot;login&quot; =&gt; &quot;jan_hake&quot;}
14:35:11.058 module=Plug.Logger [info] Sent 200 in 17ms
14:35:11.063 module=Core.Manager [info] perform transfer_manager for transfer id: 87e8bed2-72ad-44aa-9dfe-ff7e69883df1
14:35:11.067 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 4528, messages: [], num_rows: 1, rows: nil}
14:35:11.110 module=Core.Manager [debug] set state 'succeeded' for 87e8bed2-72ad-44aa-9dfe-ff7e69883df1 succeeded
14:35:11.110 module=Core.Manager [debug] manager succeeded:  %{notice: [&quot;crypted password: $2a$06$g6YczlE0qjE6dZbLNn4tLewaL80Bx5Pms/IONU8kblzNTQjFTU1zO&quot;, &quot;salt: $2a$06$g6YczlE0qjE6dZbLNn4tLe&quot;, &quot;blank password: $2a$06$Nbp0YIoQkPykTQMmVdgWbO&quot;, &quot;INSERT INTO rasmus.user (email_address, login, last_name, first_name) VALUES ('jan_hake@gmx.de', 'jan_hake', 'Hake', 'Jan Frederik') RETURNING id;&quot;]}
14:35:11.110 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;87e8bed2-72ad-44aa-9dfe-ff7e69883df1\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;user\&quot;}&quot;</code></pre>
<p>(hint: the stuff with the password won’t stay this way. it is just some dummy stuff.)</p>
<p>The <code>user</code> is currently necessary for the owner association. The <code>user_id</code> must be stored for the the next calls.</p>
<pre><code>USER_ID=`psql -U postgres -d rasmus -c &quot;select id from rasmus.user&quot; | sed -e '1,2d' -e '4,5d' -e 's/^ //'`</code></pre>
<p>Now we take the <code>user</code> and add some links.</p>
<pre><code>curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
    &quot;entity&quot;: &quot;link&quot;,
    &quot;data&quot;: {
      &quot;id_owner&quot;: &quot;$USER_ID&quot;,
      &quot;name&quot;: &quot;otp tree&quot;,
      &quot;description&quot;: &quot;process configuration&quot;,
      &quot;url&quot;: &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;
    }
}
BODY

curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
    &quot;entity&quot;: &quot;link&quot;,
    &quot;data&quot;: {
      &quot;id_owner&quot;: &quot;$USER_ID&quot;,
      &quot;name&quot;: &quot;router&quot;,
      &quot;description&quot;: &quot;cowboy router&quot;,
      &quot;url&quot;: &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;
    }
}
BODY

...</code></pre>
<p>The <code>link</code> is stored into the database.</p>
<pre><code>CREATE TABLE &quot;link&quot;(
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_owner UUID NOT NULL REFERENCES &quot;user&quot;(id) ON DELETE CASCADE,
    name VARCHAR(80) UNIQUE NOT NULL,
    description VARCHAR(254),
    url VARCHAR(2048),
    json_view JSONB
);</code></pre>
<p>The <code>json_view</code> column is populated, when it is needed for the first time. All necessary functions can be found in the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/link.sql">database script</a>.</p>
<p>Log entries:</p>
<pre><code>14:38:28.319 module=Plug.Logger [info] POST /api
14:38:28.319 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;process configuration&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;otp tree&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;}
14:38:28.319 module=Plug.Logger [info] Sent 200 in 487µs
14:38:28.324 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.324 module=Core.Manager [info] perform transfer_manager for transfer id: e2fe6b9c-18ec-436d-97a1-2153243c90fb
14:38:28.331 module=Plug.Logger [info] POST /api
14:38:28.332 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;cowboy router&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;router&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;}
14:38:28.332 module=Plug.Logger [info] Sent 200 in 462µs
14:38:28.334 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.340 module=Plug.Logger [info] POST /api
14:38:28.340 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;listen to notifications\nfrom database&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;counter&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;}
14:38:28.340 module=Plug.Logger [info] Sent 200 in 292µs
14:38:28.340 module=Core.Manager [debug] set state 'succeeded' for e2fe6b9c-18ec-436d-97a1-2153243c90fb succeeded
14:38:28.341 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex', 'otp tree', 'process configuration', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.341 module=Core.Manager [info] perform transfer_manager for transfer id: 44c832eb-b034-4e4f-884c-4d20c3da6fa1
14:38:28.341 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;e2fe6b9c-18ec-436d-97a1-2153243c90fb\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.342 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.346 module=Plug.Logger [info] POST /api
14:38:28.346 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;send requests towards\nthe database&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;inbound&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;}
14:38:28.346 module=Plug.Logger [info] Sent 200 in 220µs
14:38:28.347 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.350 module=Core.Manager [debug] set state 'succeeded' for 44c832eb-b034-4e4f-884c-4d20c3da6fa1 succeeded
14:38:28.350 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex', 'router', 'cowboy router', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.350 module=Core.Manager [info] perform transfer_manager for transfer id: 1812a173-715c-4d7f-9983-29706dc5174b
14:38:28.350 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;44c832eb-b034-4e4f-884c-4d20c3da6fa1\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.350 module=Plug.Logger [info] POST /api
14:38:28.350 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;execute the\ndatabase manager&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;manager&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}
14:38:28.350 module=Plug.Logger [info] Sent 200 in 175µs
14:38:28.352 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.354 module=Plug.Logger [info] POST /api
14:38:28.354 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;react / visjs app&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;client&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}
14:38:28.354 module=Plug.Logger [info] Sent 200 in 223µs
14:38:28.359 module=Plug.Logger [info] POST /api
14:38:28.359 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;database configuration&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;configuration&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;}
14:38:28.359 module=Plug.Logger [info] Sent 200 in 157µs
14:38:28.360 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.361 module=Core.Manager [debug] set state 'succeeded' for 1812a173-715c-4d7f-9983-29706dc5174b succeeded
14:38:28.361 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex', 'counter', 'listen to notifications\nfrom database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.361 module=Core.Manager [info] perform transfer_manager for transfer id: 00039c03-2b12-42ee-b0ee-4f3251eba820
14:38:28.361 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;1812a173-715c-4d7f-9983-29706dc5174b\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.362 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.363 module=Plug.Logger [info] POST /api
14:38:28.363 module=Web.Router [info] Got add for link with %{&quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;database&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;}
14:38:28.363 module=Plug.Logger [info] Sent 200 in 163µs
14:38:28.365 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.367 module=Plug.Logger [info] POST /api
14:38:28.367 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;interface table&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;transfer&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;}
14:38:28.367 module=Plug.Logger [info] Sent 200 in 157µs
14:38:28.368 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.369 module=Core.Manager [debug] set state 'succeeded' for 00039c03-2b12-42ee-b0ee-4f3251eba820 succeeded
14:38:28.369 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex', 'inbound', 'send requests towards\nthe database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.369 module=Core.Manager [info] perform transfer_manager for transfer id: 488b40d5-e364-413b-b796-5706533b36ed
14:38:28.369 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;00039c03-2b12-42ee-b0ee-4f3251eba820\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.371 module=Plug.Logger [info] POST /api
14:38:28.371 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;table manipulation\nafter DDL&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;postcreate&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;}
14:38:28.371 module=Plug.Logger [info] Sent 200 in 138µs
14:38:28.372 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.374 module=Plug.Logger [info] POST /api
14:38:28.374 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;generic CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;crud&quot;, &quot;url&quot; =&gt; &quot;https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;}
14:38:28.374 module=Plug.Logger [info] Sent 200 in 210µs
14:38:28.376 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.377 module=Core.Manager [debug] set state 'succeeded' for 488b40d5-e364-413b-b796-5706533b36ed succeeded
14:38:28.377 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex', 'manager', 'execute the\ndatabase manager', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.377 module=Core.Manager [info] perform transfer_manager for transfer id: 912e14df-ee7c-45c0-898a-895c98d1a36a
14:38:28.377 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;488b40d5-e364-413b-b796-5706533b36ed\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.381 module=Core.Manager [debug] set state 'succeeded' for 912e14df-ee7c-45c0-898a-895c98d1a36a succeeded
14:38:28.381 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex', 'client', 'react / visjs app', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.381 module=Core.Manager [info] perform transfer_manager for transfer id: a3492a80-4289-46bd-bfc2-9b880af42517
14:38:28.381 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;912e14df-ee7c-45c0-898a-895c98d1a36a\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.388 module=Core.Manager [debug] set state 'succeeded' for a3492a80-4289-46bd-bfc2-9b880af42517 succeeded
14:38:28.388 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/tree/master/config', 'configuration', 'database configuration', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.388 module=Core.Manager [info] perform transfer_manager for transfer id: 1aac3309-39f0-4f4a-b92f-a89e8a49e6ba
14:38:28.388 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;a3492a80-4289-46bd-bfc2-9b880af42517\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.392 module=Core.Manager [debug] set state 'succeeded' for 1aac3309-39f0-4f4a-b92f-a89e8a49e6ba succeeded
14:38:28.392 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, id_owner) VALUES ('https://github.com/enter-haken/rasmus/tree/master/database_scripts', 'database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.392 module=Core.Manager [info] perform transfer_manager for transfer id: 9feb5f68-9f97-4351-b324-7b8d8436a94f
14:38:28.392 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;1aac3309-39f0-4f4a-b92f-a89e8a49e6ba\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.396 module=Core.Manager [debug] set state 'succeeded' for 9feb5f68-9f97-4351-b324-7b8d8436a94f succeeded
14:38:28.396 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql', 'transfer', 'interface table', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.396 module=Core.Manager [info] perform transfer_manager for transfer id: 965ff0e8-43ae-4b7d-b76e-a55bcd721058
14:38:28.396 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;9feb5f68-9f97-4351-b324-7b8d8436a94f\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.399 module=Core.Manager [debug] set state 'succeeded' for 965ff0e8-43ae-4b7d-b76e-a55bcd721058 succeeded
14:38:28.400 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql', 'postcreate', 'table manipulation\nafter DDL', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.400 module=Core.Manager [info] perform transfer_manager for transfer id: 161771a3-e153-44bf-89bf-42f7b5b2cd53
14:38:28.400 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;965ff0e8-43ae-4b7d-b76e-a55bcd721058\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.406 module=Core.Manager [debug] set state 'succeeded' for 161771a3-e153-44bf-89bf-42f7b5b2cd53 succeeded
14:38:28.406 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql', 'crud', 'generic CREATE, READ\nUPDATE, DELETE\nfunctions', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.406 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;161771a3-e153-44bf-89bf-42f7b5b2cd53\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;</code></pre>
<p>As you can see, the <code>inbound</code> tasks are very quick. A <code>manager</code> task can take a while and it will report to the <code>counter</code>, when it is ready.</p>
<p>After all links are inserted you can post a get request, to get the graph.</p>
<pre><code>curl -H &quot;Content-Type: application/json&quot; -d '{&quot;action&quot; : &quot;get&quot;, &quot;entity&quot;:&quot;graph&quot;, &quot;data&quot; : { &quot;id_owner&quot;:&quot;'&quot;$USER_ID&quot;'&quot;  }}' $API_URL</code></pre>
<p>The <code>request</code> is inserted into the <code>transfer</code> table and the <code>counter</code> will call the corresponding manager for the <code>graph</code>.</p>
<p>The result of</p>
<pre><code>CREATE FUNCTION get_graph_for(raw_request JSONB) RETURNS JSONB AS $$
  import json

  request = json.loads(raw_request)

  link_request = json.dumps({
    &quot;entity&quot; : &quot;link&quot;,
    &quot;action&quot; : &quot;get&quot;,
    &quot;data&quot; : {
      &quot;id_owner&quot; : request[&quot;data&quot;][&quot;id_owner&quot;]
    }
  })

  links = json.loads(plpy.execute(plpy.prepare(
      &quot;SELECT rasmus.link_get_manager($1)&quot;,[&quot;jsonb&quot;]), [link_request])[0][&quot;link_get_manager&quot;])

  response = {
    &quot;owner&quot; : request[&quot;data&quot;][&quot;id_owner&quot;],
    &quot;nodes&quot; : links
  }

  return json.dumps(response)

$$ LANGUAGE plpython3u</code></pre>
<p>will be inserted into the <code>response</code> column and the <code>counter</code> is informed, that the <code>graph</code> request is ready for processing.</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
  case Jason.decode(payload) do
    
    # ...

    {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; state, &quot;entity&quot; =&gt; &quot;graph&quot;, &quot;action&quot; =&gt; &quot;get&quot; }} -&gt; 
      Logger.info(&quot;got a 'get' request for a graph&quot;)
      Core.Entity.Graph.get(id);
    
    # ...

    _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
  end
  {:noreply, {pid, ref}}
end</code></pre>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/entity/graph.ex#L30">Core.Entity.Graph.get/1</a> function</p>
<pre><code>def handle_cast({:get, transfer_id}, state) do
  case Postgrex.query(state, &quot;SELECT response FROM  rasmus.transfer WHERE id = $1&quot;, [UUID.string_to_binary!(transfer_id)]) do
    {:ok, result} -&gt; Logger.debug(&quot;got response from transfer: #{inspect(result)}&quot;)
    {:error, error} -&gt; Logger.error(&quot;getting response from transfer failed: #{inspect(error)}. Tried to get #{inspect(transfer_id)}&quot;)
  end
  {:noreply, state }
end

# ...

def get(transfer_id) do
  GenServer.cast(:graph, {:get, transfer_id})
end</code></pre>
<p>puts the result into the <code>rasmus</code> log.</p>
<p>Log entries:</p>
<pre><code>...

14:44:28.126 module=Plug.Logger [info] POST /api
14:44:28.126 module=Web.Router [info] Got get for graph with %{&quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;}
...
14:44:28.156 module=Core.Counter [info] got a 'get' request for a graph
14:44:28.157 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;dirty or empty ids for link: []&quot;, &quot;SELECT id, json_view FROM rasmus.link WHERE id_owner = '376d0e62-2438-455a-ada6-b1a188274f38'&quot;, &quot;update json_view for link 98b83cb9-5273-424f-bbd9-cd0d1b006014&quot;, &quot;update json_view for link 606f21fa-879f-4dda-a710-31e436046d09&quot;, &quot;update json_view for link fcea53b3-81bf-419b-8443-5944fb674c46&quot;, &quot;update json_view for link aadd3610-c71d-48c2-983a-1c74f8ff4dd0&quot;, &quot;update json_view for link cde93d44-1324-476d-b7ba-1b8a737ef90a&quot;, &quot;update json_view for link 71cda2ab-4116-49f9-9dfc-3b08a3462260&quot;, &quot;update json_view for link 890b3947-bd9e-4506-8ca5-ded220503f00&quot;, &quot;update json_view for link 0c31d9dd-8d39-4536-85b7-0048c58dd872&quot;, &quot;update json_view for link 8c8bbb39-7047-4260-95c4-20c0eed6c69b&quot;, &quot;update json_view for link 78a2b625-9116-4e8d-8bf7-b3124d105d73&quot;, &quot;update json_view for link 8c99ce4a-cea4-42e5-a991-17b2c34fa8e8&quot;, &quot;dirty or empty ids for link: [{\&quot;id\&quot;: \&quot;8c99ce4a-cea4-42e5-a991-17b2c34fa8e8\&quot;}, {\&quot;id\&quot;: \&quot;78a2b625-9116-4e8d-8bf7-b3124d105d73\&quot;}, {\&quot;id\&quot;: \&quot;8c8bbb39-7047-4260-95c4-20c0eed6c69b\&quot;}, {\&quot;id\&quot;: \&quot;0c31d9dd-8d39-4536-85b7-0048c58dd872\&quot;}, {\&quot;id\&quot;: \&quot;890b3947-bd9e-4506-8ca5-ded220503f00\&quot;}, {\&quot;id\&quot;: \&quot;71cda2ab-4116-49f9-9dfc-3b08a3462260\&quot;}, {\&quot;id\&quot;: \&quot;cde93d44-1324-476d-b7ba-1b8a737ef90a\&quot;}, {\&quot;id\&quot;: \&quot;aadd3610-c71d-48c2-983a-1c74f8ff4dd0\&quot;}, {\&quot;id\&quot;: \&quot;fcea53b3-81bf-419b-8443-5944fb674c46\&quot;}, {\&quot;id\&quot;: \&quot;606f21fa-879f-4dda-a710-31e436046d09\&quot;}, {\&quot;id\&quot;: \&quot;98b83cb9-5273-424f-bbd9-cd0d1b006014\&quot;}]&quot;, &quot;SELECT id, json_view FROM rasmus.link WHERE id_owner = '376d0e62-2438-455a-ada6-b1a188274f38'&quot;]}
14:44:28.160 module=Core.Entity.Graph [debug] got response from transfer: %Postgrex.Result{columns: [&quot;response&quot;], command: :select, connection_id: 7981, messages: [], num_rows: 1, rows: [[%{&quot;nodes&quot; =&gt; [%{&quot;description&quot; =&gt; &quot;process configuration&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;8c99ce4a-cea4-42e5-a991-17b2c34fa8e8&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;otp tree&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;}, %{&quot;description&quot; =&gt; &quot;cowboy router&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;78a2b625-9116-4e8d-8bf7-b3124d105d73&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;router&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;}, %{&quot;description&quot; =&gt; &quot;listen to notifications\nfrom database&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;8c8bbb39-7047-4260-95c4-20c0eed6c69b&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;counter&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;}, %{&quot;description&quot; =&gt; &quot;send requests towards\nthe database&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;0c31d9dd-8d39-4536-85b7-0048c58dd872&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;inbound&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;}, %{&quot;description&quot; =&gt; &quot;execute the\ndatabase manager&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;890b3947-bd9e-4506-8ca5-ded220503f00&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;manager&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}, %{&quot;description&quot; =&gt; &quot;react / visjs app&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;71cda2ab-4116-49f9-9dfc-3b08a3462260&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;client&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}, %{&quot;description&quot; =&gt; &quot;database configuration&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;cde93d44-1324-476d-b7ba-1b8a737ef90a&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;configuration&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;}, %{&quot;description&quot; =&gt; nil, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;aadd3610-c71d-48c2-983a-1c74f8ff4dd0&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;database&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;}, %{&quot;description&quot; =&gt; &quot;interface table&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;fcea53b3-81bf-419b-8443-5944fb674c46&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;transfer&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;}, %{&quot;description&quot; =&gt; &quot;table manipulation\nafter DDL&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;606f21fa-879f-4dda-a710-31e436046d09&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;postcreate&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;}, %{&quot;description&quot; =&gt; &quot;generic CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;98b83cb9-5273-424f-bbd9-cd0d1b006014&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;crud&quot;, &quot;url&quot; =&gt; &quot;https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;}], &quot;owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;}]]}</code></pre>
<p>(hint: I reseeded the database to get a cleaner log for the <code>link</code> inserts. the <code>id</code>s won’t match with the other log example)</p>
<p>(hint: at the time of writing, the edges are not part of the response.)</p>
<h1 id="next-steps">next steps</h1>
<p>So far so good.</p>
<p>Currently, I am working on the <a href="https://en.wikipedia.org/wiki/Adjacency_list">adjacency lists</a> for rasmus. You can take a look into the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/graph_edge.sql">database scripts</a> for the graph itself, but it is still kind of raw.</p>

        </section>

        <section id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
              <img alt="Creative Commons Lizenzvertrag" style="border-width:0;vertical-align:middle;" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
            </a>
        </section>
    </body>
</html>
