<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>enter_haken - first steps with rasmus</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109218061-1"></script>
        <script>
          var gaProperty = 'UA-109218061-1';
          var disableString = 'ga-disable-' + gaProperty;
       
          if (document.cookie.indexOf(disableString + '=true') > -1) {
              window[disableString] = true;
          }
 
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaProperty, { 'anonymize_ip' : true });
        </script>
    </head>
    <body>
        <div id="header">
            <div id="navigation">
                <a href="../">enter_haken</a>
                <a href="../projects.html">projects</a>
                <a href="../cookbook.html">cookbook</a>
                <a href="../notes.html">notes</a>
                <a href="../read.html">read</a>
                <a href="../about.html">about</a>
            </div>
        </div>

        <div id="content">
            <h1>first steps with rasmus</h1>

<div class="info">
    
    Posted on July 31, 2018
    
        
</div>

<p>Having the first parts of <code>rasmus</code> <a href="../posts/2018-07-23-rasmus-part2.html">in motion</a>, I started my first tests. There is no user management yet and the frontend is somehow static. So the first inserts will be made via <code>curl</code>.</p>
<div class="overflow"><?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="387pt" height="638pt" viewBox="0.00 0.00 386.50 638.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 634)">
<title>%3</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-634 382.5,-634 382.5,4 -4,4"></polygon>
<!-- curl -->
<g id="node1" class="node">
<title>curl</title>
<path fill="#ffffff" stroke="#ffffff" d="M298,-630C298,-630 237,-630 237,-630 231,-630 225,-624 225,-618 225,-618 225,-606 225,-606 225,-600 231,-594 237,-594 237,-594 298,-594 298,-594 304,-594 310,-600 310,-606 310,-606 310,-618 310,-618 310,-624 304,-630 298,-630"></path>
<text text-anchor="start" x="252" y="-615.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="256" y="-615.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">curl</text>
<text text-anchor="start" x="233" y="-601.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">web client </text>
</g>
<!-- router -->
<g id="node2" class="node">
<title>router</title>
<path fill="#ffffff" stroke="#ffffff" d="M300,-547C300,-547 235,-547 235,-547 229,-547 223,-541 223,-535 223,-535 223,-509 223,-509 223,-503 229,-497 235,-497 235,-497 300,-497 300,-497 306,-497 312,-503 312,-509 312,-509 312,-535 312,-535 312,-541 306,-547 300,-547"></path>
<text text-anchor="start" x="244.5" y="-532.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="248.5" y="-532.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">router</text>
<text text-anchor="start" x="235" y="-518.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">managing</text>
<text text-anchor="start" x="231" y="-504.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">http routes </text>
</g>
<!-- curl&#45;&gt;router -->
<g id="edge1" class="edge">
<title>curl-&gt;router</title>
<path fill="none" stroke="#000000" d="M267.5,-593.7872C267.5,-583.2736 267.5,-569.693 267.5,-557.1779"></path>
<polygon fill="#000000" stroke="#000000" points="271.0001,-557.0065 267.5,-547.0065 264.0001,-557.0065 271.0001,-557.0065"></polygon>
<text text-anchor="start" x="267.5" y="-569" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> </text>
<text text-anchor="start" x="271.5" y="-569" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00" fill="#000000">POST</text>
<text text-anchor="start" x="299.5" y="-569" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> request </text>
</g>
<!-- inbound -->
<g id="node3" class="node">
<title>inbound</title>
<path fill="#ffffff" stroke="#ffffff" d="M275.5,-450C275.5,-450 157.5,-450 157.5,-450 151.5,-450 145.5,-444 145.5,-438 145.5,-438 145.5,-412 145.5,-412 145.5,-406 151.5,-400 157.5,-400 157.5,-400 275.5,-400 275.5,-400 281.5,-400 287.5,-406 287.5,-412 287.5,-412 287.5,-438 287.5,-438 287.5,-444 281.5,-450 275.5,-450"></path>
<text text-anchor="start" x="185.5" y="-435.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="189.5" y="-435.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">inbound</text>
<text text-anchor="start" x="153.5" y="-421.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">add entities into the</text>
<text text-anchor="start" x="172.5" y="-407.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">transfer table </text>
</g>
<!-- router&#45;&gt;inbound -->
<g id="edge2" class="edge">
<title>router-&gt;inbound</title>
<path fill="none" stroke="#000000" d="M254.2335,-496.7676C248.2127,-485.3163 240.9994,-471.5969 234.4998,-459.2348"></path>
<polygon fill="#000000" stroke="#000000" points="237.4518,-457.3284 229.7001,-450.1061 231.2559,-460.586 237.4518,-457.3284"></polygon>
<text text-anchor="start" x="244.5" y="-471" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> validation </text>
</g>
<!-- transfer -->
<g id="node5" class="node">
<title>transfer</title>
<path fill="#ffffff" stroke="#ffffff" d="M261.5,-342C261.5,-342 127.5,-342 127.5,-342 121.5,-342 115.5,-336 115.5,-330 115.5,-330 115.5,-318 115.5,-318 115.5,-312 121.5,-306 127.5,-306 127.5,-306 261.5,-306 261.5,-306 267.5,-306 273.5,-312 273.5,-318 273.5,-318 273.5,-330 273.5,-330 273.5,-336 267.5,-342 261.5,-342"></path>
<text text-anchor="start" x="165.5" y="-327.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="169.5" y="-327.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">transfer</text>
<text text-anchor="start" x="123.5" y="-313.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">database gatekeeper </text>
</g>
<!-- inbound&#45;&gt;transfer -->
<g id="edge4" class="edge">
<title>inbound-&gt;transfer</title>
<path fill="none" stroke="#000000" d="M211.0052,-399.774C207.8714,-385.3868 203.9343,-367.3122 200.6915,-352.4245"></path>
<polygon fill="#000000" stroke="#000000" points="204.0225,-351.2715 198.4743,-342.2456 197.1829,-352.7614 204.0225,-351.2715"></polygon>
<text text-anchor="start" x="207.5" y="-374" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> insert into</text>
<text text-anchor="start" x="209" y="-363" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000">database </text>
</g>
<!-- socket -->
<g id="node4" class="node">
<title>socket</title>
<path fill="#ffffff" stroke="#ffffff" d="M327,-36C327,-36 222,-36 222,-36 216,-36 210,-30 210,-24 210,-24 210,-12 210,-12 210,-6 216,0 222,0 222,0 327,0 327,0 333,0 339,-6 339,-12 339,-12 339,-24 339,-24 339,-30 333,-36 327,-36"></path>
<text text-anchor="start" x="234.5" y="-21.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="238.5" y="-21.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">websocket</text>
<text text-anchor="start" x="218" y="-7.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">client connection </text>
</g>
<!-- socket&#45;&gt;router -->
<g id="edge3" class="edge">
<title>socket-&gt;router</title>
<path fill="none" stroke="#000000" d="M291.949,-36.3002C296.2802,-41.6637 300.5281,-47.7705 303.5,-54 316.2241,-80.6717 317.5,-89.4486 317.5,-119 317.5,-425 317.5,-425 317.5,-425 317.5,-447.7943 306.4564,-470.5879 294.7495,-488.3469"></path>
<polygon fill="#000000" stroke="#000000" points="291.8212,-486.4275 288.9947,-496.6384 297.5719,-490.4188 291.8212,-486.4275"></polygon>
<text text-anchor="start" x="317.5" y="-275.5" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> backchannel </text>
</g>
<!-- counter -->
<g id="node6" class="node">
<title>counter</title>
<path fill="#ffffff" stroke="#ffffff" d="M212,-250C212,-250 89,-250 89,-250 83,-250 77,-244 77,-238 77,-238 77,-212 77,-212 77,-206 83,-200 89,-200 89,-200 212,-200 212,-200 218,-200 224,-206 224,-212 224,-212 224,-238 224,-238 224,-244 218,-250 212,-250"></path>
<text text-anchor="start" x="121.5" y="-235.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="125.5" y="-235.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">counter</text>
<text text-anchor="start" x="85" y="-221.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">Postgres notification</text>
<text text-anchor="start" x="125" y="-207.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">listener </text>
</g>
<!-- transfer&#45;&gt;counter -->
<g id="edge5" class="edge">
<title>transfer-&gt;counter</title>
<path fill="none" stroke="#000000" d="M186.4297,-305.8419C180.677,-292.8983 172.7657,-275.0978 165.8308,-259.4943"></path>
<polygon fill="#000000" stroke="#000000" points="168.9268,-257.8425 161.6671,-250.1259 162.5302,-260.6855 168.9268,-257.8425"></polygon>
<text text-anchor="start" x="180" y="-281" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> send a</text>
<text text-anchor="start" x="178.5" y="-271" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00" fill="#000000">receipt</text>
<text text-anchor="start" x="210.5" y="-271" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> </text>
</g>
<!-- manager -->
<g id="node7" class="node">
<title>manager</title>
<path fill="#ffffff" stroke="#ffffff" d="M131,-144C131,-144 12,-144 12,-144 6,-144 0,-138 0,-132 0,-132 0,-106 0,-106 0,-100 6,-94 12,-94 12,-94 131,-94 131,-94 137,-94 143,-100 143,-106 143,-106 143,-132 143,-132 143,-138 137,-144 131,-144"></path>
<text text-anchor="start" x="39" y="-129.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="43" y="-129.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">manager</text>
<text text-anchor="start" x="35.5" y="-115.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">executes a</text>
<text text-anchor="start" x="8" y="-101.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">database manager </text>
</g>
<!-- counter&#45;&gt;manager -->
<g id="edge6" class="edge">
<title>counter-&gt;manager</title>
<path fill="none" stroke="#000000" d="M77.5854,-199.8933C70.8679,-194.9374 64.9331,-189.0312 60.5,-182 55.27,-173.7049 54.958,-163.6349 56.7931,-154.0019"></path>
<polygon fill="#000000" stroke="#000000" points="60.2085,-154.7755 59.3665,-144.2142 53.4386,-152.9955 60.2085,-154.7755"></polygon>
<text text-anchor="start" x="60.5" y="-175" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> executes the</text>
<text text-anchor="start" x="68" y="-165" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00" fill="#000000">manager</text>
<text text-anchor="start" x="109" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> </text>
</g>
<!-- graph_elixir -->
<g id="node8" class="node">
<title>graph_elixir</title>
<path fill="#ffffff" stroke="#ffffff" d="M277.5,-137C277.5,-137 185.5,-137 185.5,-137 179.5,-137 173.5,-131 173.5,-125 173.5,-125 173.5,-113 173.5,-113 173.5,-107 179.5,-101 185.5,-101 185.5,-101 277.5,-101 277.5,-101 283.5,-101 289.5,-107 289.5,-113 289.5,-113 289.5,-125 289.5,-125 289.5,-131 283.5,-137 277.5,-137"></path>
<text text-anchor="start" x="209" y="-122.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000"> </text>
<text text-anchor="start" x="213" y="-122.8" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="14.00" fill="#000000">graph</text>
<text text-anchor="start" x="181.5" y="-108.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">entity manager </text>
</g>
<!-- counter&#45;&gt;graph_elixir -->
<g id="edge8" class="edge">
<title>counter-&gt;graph_elixir</title>
<path fill="none" stroke="#000000" d="M189.1953,-199.7688C195.5403,-194.4408 201.6242,-188.4557 206.5,-182 214.3438,-171.6146 220.0764,-158.4436 224.0579,-146.8325"></path>
<polygon fill="#000000" stroke="#000000" points="227.445,-147.7292 227.1151,-137.1395 220.7691,-145.6236 227.445,-147.7292"></polygon>
<text text-anchor="start" x="218.5" y="-175" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> load the result</text>
<text text-anchor="start" x="219.5" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000">from </text>
<text text-anchor="start" x="242.5" y="-165" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="10.00" fill="#000000">transfer</text>
<text text-anchor="start" x="278.5" y="-165" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> </text>
</g>
<!-- manager&#45;&gt;counter -->
<g id="edge7" class="edge">
<title>manager-&gt;counter</title>
<path fill="none" stroke="#000000" d="M103.9447,-144.1056C109.8923,-149.6024 115.7213,-155.6808 120.5,-162 126.9667,-170.5513 132.5476,-180.7193 137.0823,-190.3643"></path>
<polygon fill="#000000" stroke="#000000" points="133.9984,-192.0431 141.2623,-199.7557 140.3935,-189.1966 133.9984,-192.0431"></polygon>
<text text-anchor="start" x="133.5" y="-169.5" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000"> gets the result </text>
</g>
<!-- graph_elixir&#45;&gt;socket -->
<g id="edge9" class="edge">
<title>graph_elixir-&gt;socket</title>
<path fill="none" stroke="#000000" d="M238.3829,-100.9455C243.4635,-87.8338 250.6557,-69.7111 257.5,-54 258.7301,-51.1762 260.0471,-48.2447 261.3834,-45.3285"></path>
<polygon fill="#000000" stroke="#000000" points="264.5787,-46.758 265.6354,-36.216 258.2352,-43.7981 264.5787,-46.758"></polygon>
<text text-anchor="start" x="257.5" y="-68" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000">update the</text>
<text text-anchor="start" x="268.5" y="-57" font-family="Helvetica,sans-Serif" font-size="10.00" fill="#000000">client</text>
</g>
</g>
</svg>
</div>
<p>The <code>backchannel</code> isn’t in place yet.</p>
<p>Currently you can see the result in the <code>rasmus</code> log. Let’s demonstrate this workflow with an example.</p>
<!--more-->
<h1 id="router">router</h1>
<p>At first a <code>user</code> must be inserted into the database.</p>
<pre><code>API_URL=&quot;http://localhost:8080/api&quot;

curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
   &quot;entity&quot;: &quot;user&quot;,
   &quot;data&quot;: {
     &quot;first_name&quot;: &quot;Jan Frederik&quot;,
     &quot;last_name&quot;: &quot;Hake&quot;,
     &quot;email_address&quot;: &quot;jan_hake@gmx.de&quot;,
     &quot;login&quot;: &quot;jan_hake&quot;
   }
}
BODY</code></pre>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex">router</a> make some simple checks on the posted json data.</p>
<pre><code>post &quot;/api&quot; do
    with {:ok, action} &lt;- get_action_from(conn.body_params),
         {:ok, entity}  &lt;- get_entity_from(conn.body_params),
         {:ok, data } &lt;- get_data_from(conn.body_params)
    do
      Logger.info(&quot;Got #{action} for #{entity} with #{inspect(data)}&quot;)

      Core.Inbound.add(conn.body_params)

      conn
      |&gt; send_resp(200, get_succeeded_response())
    else
      {:error, message} -&gt;
        Logger.warn(&quot;Got malformed request: #{message}&quot;)

        conn
        |&gt; send_resp(422, get_error_response(message))
    end
end</code></pre>
<p>Only the <code>actions</code> in</p>
<pre><code>@actions [&quot;add&quot;,&quot;update&quot;,&quot;get&quot;,&quot;delete&quot;]</code></pre>
<p>will be valid <code>actions</code>.</p>
<pre><code>defp get_action_from(%{ &quot;action&quot; =&gt;  action } = _body_params) do
    case Enum.member?(@actions, action) do
      true -&gt; {:ok, action }
      _ -&gt; { :error, &quot;Action '#{action}' is not valid. Valid actions are #{get_quoted(@actions)}&quot;}
    end
  end

defp get_action_from(_body_params), do: { :error, &quot;action is missing. Valid actions are #{get_quoted(@actions)}&quot; }</code></pre>
<p>Otherwise you get into the <code>error</code> path.</p>
<p>The similar things will be checked for valid <code>entities</code>.</p>
<pre><code>@entities [&quot;user&quot;,&quot;privilege&quot;,&quot;role&quot;,&quot;link&quot;,&quot;appointment&quot;,&quot;list&quot;,&quot;graph&quot;]

defp get_entity_from(%{ &quot;entity&quot; =&gt; entity } = _body_params) do
  case Enum.member?(@entities, entity) do
    true -&gt; {:ok, entity }
    _ -&gt; { :error, &quot;Entity '#{entity}' is not valid. Valid entities are #{get_quoted(@entities)}&quot; }
  end
end

defp get_entity_from(_body_params), do: { :error, &quot;entity is missing. Valid entities are #{get_quoted(@entities)}&quot; }</code></pre>
<p>A helper function will make some pretty stuff with the error message.</p>
<pre><code># get_quoted([&quot;a&quot;,&quot;b&quot;]) -&gt; 'a', 'b'
defp get_quoted(strings) do
  strings
  |&gt; Enum.map(fn(x) -&gt; &quot;\'#{x}\'&quot; end)
  |&gt; Enum.join(&quot;, &quot;)
end</code></pre>
<p>If everything has worked as expected,</p>
<pre><code> Core.Inbound.add(conn.body_params)</code></pre>
<p>will add the <code>entity</code> into the database.</p>
<h1 id="inbound">Inbound</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex">inbound</a> <code>GenServer</code> has the task, to insert <code>entities</code> into the database.</p>
<pre><code>def handle_cast({:add, payload}, state) do
  case Postgrex.query(state, &quot;INSERT INTO rasmus.transfer (request) VALUES ($1)&quot;, [payload]) do
    {:ok, result} -&gt; Logger.debug(&quot;added into transfer: #{inspect(result)}&quot;)
    {:error, error} -&gt; Logger.error(&quot;adding into transfer failed: #{inspect(error)}. Tried to add #{inspect(payload)}&quot;)
  end
  {:noreply, state }
end</code></pre>
<p>The <code>client</code> function</p>
<pre><code>def add(entity) do
  GenServer.cast(:inbound_worker, {:add, entity})
end</code></pre>
<p>is called from the <code>router</code>.</p>
<h1 id="transfer">transfer</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql#L35">transfer</a> table it self is quiet simple</p>
<pre><code>CREATE TABLE transfer(
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    state transfer_state NOT NULL DEFAULT 'pending',
    request JSONB NOT NULL,
    response JSONB
);</code></pre>
<p>When a <code>request</code> is inserted, a <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/notifications.sql">notification</a> will be send to the backend.</p>
<pre><code>CREATE FUNCTION send_message(id UUID, state transfer_state, request JSONB, response JSONB) RETURNS VOID AS $$
DECLARE
    message_response JSONB;
BEGIN
    message_response := '[]' || (
        jsonb_build_object('id', id) ||
        jsonb_build_object('state', state) ||
        jsonb_build_object('action', request-&gt;&gt;'action') ||
        jsonb_build_object('entity', request-&gt;&gt;'entity')
    );

    PERFORM pg_notify('rasmus', message_response-&gt;&gt;0);
END
$$ LANGUAGE plpgsql;

CREATE FUNCTION send_transfer_message() RETURNS TRIGGER AS $$
BEGIN 
    PERFORM rasmus.send_message(NEW.id, NEW.state, NEW.request, NEW.response);
    RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER send_receipt_trigger BEFORE INSERT ON transfer
FOR EACH ROW EXECUTE PROCEDURE send_transfer_message();</code></pre>
<p>At this point, it does not happen very much. This approach will reduce the inbound message queue from the <code>inbound</code> <code>GenServer</code>. Inserting a <code>request</code> should be as fast as possible.</p>
<h1 id="counter">counter</h1>
<p>The <code>counter</code> listens to Postgres notifications,</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
    case Jason.decode(payload) do

      {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; &quot;pending&quot;, }} -&gt; Core.Manager.perform(id)

      #
      # ...
      #

      _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
    end
    {:noreply, {pid, ref}}
end</code></pre>
<p>and calls the corresponding <code>manager</code> within the database.</p>
<h1 id="manager">manager</h1>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex">manager</a> performs the CRUD tasks for every entity.</p>
<p>As you can see in the shortened version,</p>
<pre><code>def handle_cast(transfer_id, state) do
  case Postgrex.query(state, &quot;SELECT rasmus.transfer_manager($1)&quot;, [transfer_id]) do
    {:ok, %{messages: messages}} -&gt;
      if Enum.any?(messages, fn(x) -&gt; x.severity == &quot;WARNING&quot; end) do
        set_succeeded_with_warning_state(state, transfer_id)
      else
         set_succeeded_state(state,transfer_id)
      end

    {:error, %{postgres: %{code: :raise_exception, severity: &quot;ERROR&quot;, message: message, hint: hint}}} -&gt;
      set_error_state(state, transfer_id)
    
    # ...
  end
  {:noreply, state }
end</code></pre>
<p>the <code>state</code> will be updated, after the manager <code>succeeded</code> or <code>failed</code>.</p>
<pre><code>defp set_state(state, transfer_id, sql_function_name, state_name) do
  case Postgrex.query(state, &quot;SELECT rasmus.#{sql_function_name}($1)&quot;, [transfer_id]) do
    {:ok, _} -&gt; Logger.debug(&quot;set state '#{state_name}' for #{transfer_id} succeeded&quot;)
    _ -&gt; Logger.error(&quot;set state '#{state_name}' for #{transfer_id} failed&quot;)
  end
end

defp set_error_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_error&quot;, &quot;error&quot;)
defp set_succeeded_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_succeeded&quot;, &quot;succeeded&quot;)
defp set_succeeded_with_warning_state(state, transfer_id), do: set_state(state, transfer_id, &quot;set_succeeded_with_warning&quot;, &quot;succeeded_with_warning&quot;)</code></pre>
<p>The Postgres function <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql#L64">transfer_manager</a> itself looks for the correct manager, and does some checks.</p>
<pre><code>CREATE FUNCTION transfer_manager(transfer_id TEXT) RETURNS VOID AS $$
DECLARE
    transfer_record RECORD;
    transfer_response JSONB;
BEGIN
   SELECT id, state, request, response FROM rasmus.transfer WHERE id = transfer_id::UUID INTO transfer_record;

   CASE transfer_record.request-&gt;&gt;'entity'
       -- ... 
       WHEN 'user' THEN
           BEGIN
               SELECT rasmus.user_manager(transfer_record.request) INTO transfer_response;
               PERFORM rasmus.set_response(transfer_id::UUID, transfer_response);
           END;
       -- ...
       ELSE
           BEGIN
               RAISE EXCEPTION 'entity `%` unknown', transfer_record.request-&gt;&gt;'entity'
                   USING HINT = 'entity must one of link, graph, appointment, list, person, role, privilege or user';
           END;
   END CASE;
END
$$ LANGUAGE plpgsql;</code></pre>
<p>It also puts the <code>result</code> into the <code>response</code> column. If you are interested, what is happening within the <code>rasmus.user_manager</code> you can take a look at the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/user_account.sql">sources</a> for the <code>user_manager</code>.</p>
<p>When the <code>state</code> changes,</p>
<pre><code>CREATE TRIGGER got_response_trigger AFTER UPDATE ON transfer
    FOR EACH ROW 
    WHEN (OLD.state IS DISTINCT FROM NEW.state)
EXECUTE PROCEDURE send_transfer_message();</code></pre>
<p>the <code>counter</code> is informed, that a request is ready for processing.</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
  case Jason.decode(payload) do
    
   # ... 

   {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; state, &quot;entity&quot; =&gt; entity, &quot;action&quot; =&gt; action }} -&gt; 
     Logger.info(&quot;got a request change with state '#{state}' for action '#{action}' and entity '#{entity}' #{id}. ToDo: send message to processes using this entity.&quot;)

   # ...

  _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
  end
  {:noreply, {pid, ref}}
end</code></pre>
<p>At this point, the UI can be informed about an entity change. On a single user system the entity is send back to the client, and the view will be updated. On a multi user system, multiple clients can be updated as well. In the case of <code>rasmus</code>, multiple users can work on the same <code>graph</code> at the same time.</p>
<h1 id="example">example</h1>
<p>As mentioned before, I added a <code>user</code> to the system. Now let’s take a look at a <a href="../posts/2018-07-23-rasmus-part2.html">previous example</a>.</p>
<div class="figure">
<img src="../images/rasmus_frontend.png" />

</div>
<p>This graph is described with <code>graphviz</code> code.</p>
<pre><code>graph {
  otp [label = &quot;*OTP tree*\nprocess configuration&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;];
  router [label =&quot;*router*\ncowboy router&quot;, url=&quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;]
  counter [label = &quot;*counter*\nlisten to notifications\nfrom database&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;]
  inbound [label = &quot;*inbound*\nsend requests towards\nthe database&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;]
  manager [label = &quot;*manager*\nexecute the\ndatabase manager&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;]
  client [label = &quot;*client*\nreact / visjs app&quot;, url = &quot;https://github.com/enter-haken/rasmus/tree/master/frontend&quot;]
  configuration [label = &quot;*configuration*\ndatabase configuration&quot;, url = &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;]
  database [label = &quot;*PostgreSQL*&quot;, url =&quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;]
  transfer [label = &quot;*transfer*\ninterface table&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;]
  postcreate [label = &quot;*postcreate*\ntable manipulation\nafter DDL&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;]
  crud [label = &quot;*CRUD*\ngeneric CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, url = &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;]
  otp -- router [ label = &quot;supervises&quot;]
  otp -- counter [ label = &quot;supervises&quot;]
  otp -- inbound [ label = &quot;supervises&quot;]
  otp -- manager [ label = &quot;supervises&quot;]
  counter -- manager [ label = &quot;executes the\nmanager&quot;]
  counter -- database [ label =&quot;listens for\ndatabase notifications&quot;]
  router -- client [label = &quot;serves&quot;]
  inbound -- transfer [label = &quot;insert request&quot;]
  database -- transfer 
  database -- postcreate
  database -- configuration
  database -- crud
}</code></pre>
<p>Due to there is no frontend, let’s make some <code>curl</code> stuff.</p>
<pre><code>$ curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
   &quot;entity&quot;: &quot;user&quot;,
   &quot;data&quot;: {
     &quot;first_name&quot;: &quot;Jan Frederik&quot;,
     &quot;last_name&quot;: &quot;Hake&quot;,
     &quot;email_address&quot;: &quot;jan_hake@gmx.de&quot;,
     &quot;login&quot;: &quot;jan_hake&quot;
   }
}
BODY</code></pre>
<p>Log entries:</p>
<pre><code>14:35:11.041 module=Plug.Logger [info] POST /api
14:35:11.056 module=Web.Router [info] Got add for user with %{&quot;email_address&quot; =&gt; &quot;jan_hake@gmx.de&quot;, &quot;first_name&quot; =&gt; &quot;Jan Frederik&quot;, &quot;last_name&quot; =&gt; &quot;Hake&quot;, &quot;login&quot; =&gt; &quot;jan_hake&quot;}
14:35:11.058 module=Plug.Logger [info] Sent 200 in 17ms
14:35:11.063 module=Core.Manager [info] perform transfer_manager for transfer id: 87e8bed2-72ad-44aa-9dfe-ff7e69883df1
14:35:11.067 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 4528, messages: [], num_rows: 1, rows: nil}
14:35:11.110 module=Core.Manager [debug] set state 'succeeded' for 87e8bed2-72ad-44aa-9dfe-ff7e69883df1 succeeded
14:35:11.110 module=Core.Manager [debug] manager succeeded:  %{notice: [&quot;crypted password: $2a$06$g6YczlE0qjE6dZbLNn4tLewaL80Bx5Pms/IONU8kblzNTQjFTU1zO&quot;, &quot;salt: $2a$06$g6YczlE0qjE6dZbLNn4tLe&quot;, &quot;blank password: $2a$06$Nbp0YIoQkPykTQMmVdgWbO&quot;, &quot;INSERT INTO rasmus.user (email_address, login, last_name, first_name) VALUES ('jan_hake@gmx.de', 'jan_hake', 'Hake', 'Jan Frederik') RETURNING id;&quot;]}
14:35:11.110 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;87e8bed2-72ad-44aa-9dfe-ff7e69883df1\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;user\&quot;}&quot;</code></pre>
<p>(hint: the stuff with the password won’t stay this way. it is just some dummy stuff.)</p>
<p>The <code>user</code> is currently necessary for the owner association. The <code>user_id</code> must be stored for the the next calls.</p>
<pre><code>USER_ID=`psql -U postgres -d rasmus -c &quot;select id from rasmus.user&quot; | sed -e '1,2d' -e '4,5d' -e 's/^ //'`</code></pre>
<p>Now we take the <code>user</code> and add some links.</p>
<pre><code>curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
    &quot;entity&quot;: &quot;link&quot;,
    &quot;data&quot;: {
      &quot;id_owner&quot;: &quot;$USER_ID&quot;,
      &quot;name&quot;: &quot;otp tree&quot;,
      &quot;description&quot;: &quot;process configuration&quot;,
      &quot;url&quot;: &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;
    }
}
BODY

curl -H &quot;Content-Type: application/json&quot; -X POST $API_URL -d @- &lt;&lt;BODY
{
  &quot;action&quot;: &quot;add&quot;,
    &quot;entity&quot;: &quot;link&quot;,
    &quot;data&quot;: {
      &quot;id_owner&quot;: &quot;$USER_ID&quot;,
      &quot;name&quot;: &quot;router&quot;,
      &quot;description&quot;: &quot;cowboy router&quot;,
      &quot;url&quot;: &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;
    }
}
BODY

...</code></pre>
<p>The <code>link</code> is stored into the database.</p>
<pre><code>CREATE TABLE &quot;link&quot;(
    id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    id_owner UUID NOT NULL REFERENCES &quot;user&quot;(id) ON DELETE CASCADE,
    name VARCHAR(80) UNIQUE NOT NULL,
    description VARCHAR(254),
    url VARCHAR(2048),
    json_view JSONB
);</code></pre>
<p>The <code>json_view</code> column is populated, when it is needed for the first time. All necessary functions can be found in the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/link.sql">database script</a>.</p>
<p>Log entries:</p>
<pre><code>14:38:28.319 module=Plug.Logger [info] POST /api
14:38:28.319 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;process configuration&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;otp tree&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;}
14:38:28.319 module=Plug.Logger [info] Sent 200 in 487µs
14:38:28.324 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.324 module=Core.Manager [info] perform transfer_manager for transfer id: e2fe6b9c-18ec-436d-97a1-2153243c90fb
14:38:28.331 module=Plug.Logger [info] POST /api
14:38:28.332 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;cowboy router&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;router&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;}
14:38:28.332 module=Plug.Logger [info] Sent 200 in 462µs
14:38:28.334 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.340 module=Plug.Logger [info] POST /api
14:38:28.340 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;listen to notifications\nfrom database&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;counter&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;}
14:38:28.340 module=Plug.Logger [info] Sent 200 in 292µs
14:38:28.340 module=Core.Manager [debug] set state 'succeeded' for e2fe6b9c-18ec-436d-97a1-2153243c90fb succeeded
14:38:28.341 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex', 'otp tree', 'process configuration', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.341 module=Core.Manager [info] perform transfer_manager for transfer id: 44c832eb-b034-4e4f-884c-4d20c3da6fa1
14:38:28.341 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;e2fe6b9c-18ec-436d-97a1-2153243c90fb\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.342 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.346 module=Plug.Logger [info] POST /api
14:38:28.346 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;send requests towards\nthe database&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;inbound&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;}
14:38:28.346 module=Plug.Logger [info] Sent 200 in 220µs
14:38:28.347 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.350 module=Core.Manager [debug] set state 'succeeded' for 44c832eb-b034-4e4f-884c-4d20c3da6fa1 succeeded
14:38:28.350 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex', 'router', 'cowboy router', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.350 module=Core.Manager [info] perform transfer_manager for transfer id: 1812a173-715c-4d7f-9983-29706dc5174b
14:38:28.350 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;44c832eb-b034-4e4f-884c-4d20c3da6fa1\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.350 module=Plug.Logger [info] POST /api
14:38:28.350 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;execute the\ndatabase manager&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;manager&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}
14:38:28.350 module=Plug.Logger [info] Sent 200 in 175µs
14:38:28.352 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.354 module=Plug.Logger [info] POST /api
14:38:28.354 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;react / visjs app&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;client&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}
14:38:28.354 module=Plug.Logger [info] Sent 200 in 223µs
14:38:28.359 module=Plug.Logger [info] POST /api
14:38:28.359 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;database configuration&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;configuration&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;}
14:38:28.359 module=Plug.Logger [info] Sent 200 in 157µs
14:38:28.360 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.361 module=Core.Manager [debug] set state 'succeeded' for 1812a173-715c-4d7f-9983-29706dc5174b succeeded
14:38:28.361 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex', 'counter', 'listen to notifications\nfrom database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.361 module=Core.Manager [info] perform transfer_manager for transfer id: 00039c03-2b12-42ee-b0ee-4f3251eba820
14:38:28.361 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;1812a173-715c-4d7f-9983-29706dc5174b\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.362 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.363 module=Plug.Logger [info] POST /api
14:38:28.363 module=Web.Router [info] Got add for link with %{&quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;database&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;}
14:38:28.363 module=Plug.Logger [info] Sent 200 in 163µs
14:38:28.365 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.367 module=Plug.Logger [info] POST /api
14:38:28.367 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;interface table&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;transfer&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;}
14:38:28.367 module=Plug.Logger [info] Sent 200 in 157µs
14:38:28.368 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.369 module=Core.Manager [debug] set state 'succeeded' for 00039c03-2b12-42ee-b0ee-4f3251eba820 succeeded
14:38:28.369 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex', 'inbound', 'send requests towards\nthe database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.369 module=Core.Manager [info] perform transfer_manager for transfer id: 488b40d5-e364-413b-b796-5706533b36ed
14:38:28.369 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;00039c03-2b12-42ee-b0ee-4f3251eba820\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.371 module=Plug.Logger [info] POST /api
14:38:28.371 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;table manipulation\nafter DDL&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;postcreate&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;}
14:38:28.371 module=Plug.Logger [info] Sent 200 in 138µs
14:38:28.372 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.374 module=Plug.Logger [info] POST /api
14:38:28.374 module=Web.Router [info] Got add for link with %{&quot;description&quot; =&gt; &quot;generic CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, &quot;id_owner&quot; =&gt; &quot;fed1e016-0730-4d04-b6cd-bdd8da676e76&quot;, &quot;name&quot; =&gt; &quot;crud&quot;, &quot;url&quot; =&gt; &quot;https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;}
14:38:28.374 module=Plug.Logger [info] Sent 200 in 210µs
14:38:28.376 module=Core.Inbound [debug] added into transfer: %Postgrex.Result{columns: nil, command: :insert, connection_id: 5768, messages: [], num_rows: 1, rows: nil}
14:38:28.377 module=Core.Manager [debug] set state 'succeeded' for 488b40d5-e364-413b-b796-5706533b36ed succeeded
14:38:28.377 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex', 'manager', 'execute the\ndatabase manager', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.377 module=Core.Manager [info] perform transfer_manager for transfer id: 912e14df-ee7c-45c0-898a-895c98d1a36a
14:38:28.377 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;488b40d5-e364-413b-b796-5706533b36ed\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.381 module=Core.Manager [debug] set state 'succeeded' for 912e14df-ee7c-45c0-898a-895c98d1a36a succeeded
14:38:28.381 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex', 'client', 'react / visjs app', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.381 module=Core.Manager [info] perform transfer_manager for transfer id: a3492a80-4289-46bd-bfc2-9b880af42517
14:38:28.381 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;912e14df-ee7c-45c0-898a-895c98d1a36a\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.388 module=Core.Manager [debug] set state 'succeeded' for a3492a80-4289-46bd-bfc2-9b880af42517 succeeded
14:38:28.388 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/tree/master/config', 'configuration', 'database configuration', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.388 module=Core.Manager [info] perform transfer_manager for transfer id: 1aac3309-39f0-4f4a-b92f-a89e8a49e6ba
14:38:28.388 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;a3492a80-4289-46bd-bfc2-9b880af42517\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.392 module=Core.Manager [debug] set state 'succeeded' for 1aac3309-39f0-4f4a-b92f-a89e8a49e6ba succeeded
14:38:28.392 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, id_owner) VALUES ('https://github.com/enter-haken/rasmus/tree/master/database_scripts', 'database', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.392 module=Core.Manager [info] perform transfer_manager for transfer id: 9feb5f68-9f97-4351-b324-7b8d8436a94f
14:38:28.392 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;1aac3309-39f0-4f4a-b92f-a89e8a49e6ba\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.396 module=Core.Manager [debug] set state 'succeeded' for 9feb5f68-9f97-4351-b324-7b8d8436a94f succeeded
14:38:28.396 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql', 'transfer', 'interface table', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.396 module=Core.Manager [info] perform transfer_manager for transfer id: 965ff0e8-43ae-4b7d-b76e-a55bcd721058
14:38:28.396 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;9feb5f68-9f97-4351-b324-7b8d8436a94f\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.399 module=Core.Manager [debug] set state 'succeeded' for 965ff0e8-43ae-4b7d-b76e-a55bcd721058 succeeded
14:38:28.400 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql', 'postcreate', 'table manipulation\nafter DDL', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.400 module=Core.Manager [info] perform transfer_manager for transfer id: 161771a3-e153-44bf-89bf-42f7b5b2cd53
14:38:28.400 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;965ff0e8-43ae-4b7d-b76e-a55bcd721058\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;
14:38:28.406 module=Core.Manager [debug] set state 'succeeded' for 161771a3-e153-44bf-89bf-42f7b5b2cd53 succeeded
14:38:28.406 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;INSERT INTO rasmus.link (url, name, description, id_owner) VALUES ('https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql', 'crud', 'generic CREATE, READ\nUPDATE, DELETE\nfunctions', 'fed1e016-0730-4d04-b6cd-bdd8da676e76') RETURNING id;&quot;]}
14:38:28.406 module=Core.Counter [warn] got unhandled notification: &quot;{\&quot;id\&quot;: \&quot;161771a3-e153-44bf-89bf-42f7b5b2cd53\&quot;, \&quot;state\&quot;: \&quot;succeeded\&quot;, \&quot;action\&quot;: \&quot;add\&quot;, \&quot;entity\&quot;: \&quot;link\&quot;}&quot;</code></pre>
<p>As you can see, the <code>inbound</code> tasks are very quick. A <code>manager</code> task can take a while and it will report to the <code>counter</code>, when it is ready.</p>
<p>After all links are inserted you can post a get request, to get the graph.</p>
<pre><code>curl -H &quot;Content-Type: application/json&quot; -d '{&quot;action&quot; : &quot;get&quot;, &quot;entity&quot;:&quot;graph&quot;, &quot;data&quot; : { &quot;id_owner&quot;:&quot;'&quot;$USER_ID&quot;'&quot;  }}' $API_URL</code></pre>
<p>The <code>request</code> is inserted into the <code>transfer</code> table and the <code>counter</code> will call the corresponding manager for the <code>graph</code>.</p>
<p>The result of</p>
<pre><code>CREATE FUNCTION get_graph_for(raw_request JSONB) RETURNS JSONB AS $$
  import json

  request = json.loads(raw_request)

  link_request = json.dumps({
    &quot;entity&quot; : &quot;link&quot;,
    &quot;action&quot; : &quot;get&quot;,
    &quot;data&quot; : {
      &quot;id_owner&quot; : request[&quot;data&quot;][&quot;id_owner&quot;]
    }
  })

  links = json.loads(plpy.execute(plpy.prepare(
      &quot;SELECT rasmus.link_get_manager($1)&quot;,[&quot;jsonb&quot;]), [link_request])[0][&quot;link_get_manager&quot;])

  response = {
    &quot;owner&quot; : request[&quot;data&quot;][&quot;id_owner&quot;],
    &quot;nodes&quot; : links
  }

  return json.dumps(response)

$$ LANGUAGE plpython3u</code></pre>
<p>will be inserted into the <code>response</code> column and the <code>counter</code> is informed, that the <code>graph</code> request is ready for processing.</p>
<pre><code>def handle_info({:notification, pid, ref, &quot;rasmus&quot;, payload},_) do
  case Jason.decode(payload) do
    
    # ...

    {:ok , %{ &quot;id&quot; =&gt; id, &quot;state&quot; =&gt; state, &quot;entity&quot; =&gt; &quot;graph&quot;, &quot;action&quot; =&gt; &quot;get&quot; }} -&gt; 
      Logger.info(&quot;got a 'get' request for a graph&quot;)
      Core.Entity.Graph.get(id);
    
    # ...

    _ -&gt; Logger.warn(&quot;got unhandled notification: #{inspect(payload)}&quot;)
  end
  {:noreply, {pid, ref}}
end</code></pre>
<p>The <a href="https://github.com/enter-haken/rasmus/blob/master/lib/core/entity/graph.ex#L30">Core.Entity.Graph.get/1</a> function</p>
<pre><code>def handle_cast({:get, transfer_id}, state) do
  case Postgrex.query(state, &quot;SELECT response FROM  rasmus.transfer WHERE id = $1&quot;, [UUID.string_to_binary!(transfer_id)]) do
    {:ok, result} -&gt; Logger.debug(&quot;got response from transfer: #{inspect(result)}&quot;)
    {:error, error} -&gt; Logger.error(&quot;getting response from transfer failed: #{inspect(error)}. Tried to get #{inspect(transfer_id)}&quot;)
  end
  {:noreply, state }
end

# ...

def get(transfer_id) do
  GenServer.cast(:graph, {:get, transfer_id})
end</code></pre>
<p>puts the result into the <code>rasmus</code> log.</p>
<p>Log entries:</p>
<pre><code>...

14:44:28.126 module=Plug.Logger [info] POST /api
14:44:28.126 module=Web.Router [info] Got get for graph with %{&quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;}
...
14:44:28.156 module=Core.Counter [info] got a 'get' request for a graph
14:44:28.157 module=Core.Manager [debug] manager succeded:  %{notice: [&quot;dirty or empty ids for link: []&quot;, &quot;SELECT id, json_view FROM rasmus.link WHERE id_owner = '376d0e62-2438-455a-ada6-b1a188274f38'&quot;, &quot;update json_view for link 98b83cb9-5273-424f-bbd9-cd0d1b006014&quot;, &quot;update json_view for link 606f21fa-879f-4dda-a710-31e436046d09&quot;, &quot;update json_view for link fcea53b3-81bf-419b-8443-5944fb674c46&quot;, &quot;update json_view for link aadd3610-c71d-48c2-983a-1c74f8ff4dd0&quot;, &quot;update json_view for link cde93d44-1324-476d-b7ba-1b8a737ef90a&quot;, &quot;update json_view for link 71cda2ab-4116-49f9-9dfc-3b08a3462260&quot;, &quot;update json_view for link 890b3947-bd9e-4506-8ca5-ded220503f00&quot;, &quot;update json_view for link 0c31d9dd-8d39-4536-85b7-0048c58dd872&quot;, &quot;update json_view for link 8c8bbb39-7047-4260-95c4-20c0eed6c69b&quot;, &quot;update json_view for link 78a2b625-9116-4e8d-8bf7-b3124d105d73&quot;, &quot;update json_view for link 8c99ce4a-cea4-42e5-a991-17b2c34fa8e8&quot;, &quot;dirty or empty ids for link: [{\&quot;id\&quot;: \&quot;8c99ce4a-cea4-42e5-a991-17b2c34fa8e8\&quot;}, {\&quot;id\&quot;: \&quot;78a2b625-9116-4e8d-8bf7-b3124d105d73\&quot;}, {\&quot;id\&quot;: \&quot;8c8bbb39-7047-4260-95c4-20c0eed6c69b\&quot;}, {\&quot;id\&quot;: \&quot;0c31d9dd-8d39-4536-85b7-0048c58dd872\&quot;}, {\&quot;id\&quot;: \&quot;890b3947-bd9e-4506-8ca5-ded220503f00\&quot;}, {\&quot;id\&quot;: \&quot;71cda2ab-4116-49f9-9dfc-3b08a3462260\&quot;}, {\&quot;id\&quot;: \&quot;cde93d44-1324-476d-b7ba-1b8a737ef90a\&quot;}, {\&quot;id\&quot;: \&quot;aadd3610-c71d-48c2-983a-1c74f8ff4dd0\&quot;}, {\&quot;id\&quot;: \&quot;fcea53b3-81bf-419b-8443-5944fb674c46\&quot;}, {\&quot;id\&quot;: \&quot;606f21fa-879f-4dda-a710-31e436046d09\&quot;}, {\&quot;id\&quot;: \&quot;98b83cb9-5273-424f-bbd9-cd0d1b006014\&quot;}]&quot;, &quot;SELECT id, json_view FROM rasmus.link WHERE id_owner = '376d0e62-2438-455a-ada6-b1a188274f38'&quot;]}
14:44:28.160 module=Core.Entity.Graph [debug] got response from transfer: %Postgrex.Result{columns: [&quot;response&quot;], command: :select, connection_id: 7981, messages: [], num_rows: 1, rows: [[%{&quot;nodes&quot; =&gt; [%{&quot;description&quot; =&gt; &quot;process configuration&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;8c99ce4a-cea4-42e5-a991-17b2c34fa8e8&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;otp tree&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/rasmus_app.ex&quot;}, %{&quot;description&quot; =&gt; &quot;cowboy router&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;78a2b625-9116-4e8d-8bf7-b3124d105d73&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;router&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/web/router.ex&quot;}, %{&quot;description&quot; =&gt; &quot;listen to notifications\nfrom database&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;8c8bbb39-7047-4260-95c4-20c0eed6c69b&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;counter&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/counter.ex&quot;}, %{&quot;description&quot; =&gt; &quot;send requests towards\nthe database&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;0c31d9dd-8d39-4536-85b7-0048c58dd872&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;inbound&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/inbound.ex&quot;}, %{&quot;description&quot; =&gt; &quot;execute the\ndatabase manager&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;890b3947-bd9e-4506-8ca5-ded220503f00&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;manager&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}, %{&quot;description&quot; =&gt; &quot;react / visjs app&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;71cda2ab-4116-49f9-9dfc-3b08a3462260&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;client&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/lib/core/manager.ex&quot;}, %{&quot;description&quot; =&gt; &quot;database configuration&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;cde93d44-1324-476d-b7ba-1b8a737ef90a&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;configuration&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/config&quot;}, %{&quot;description&quot; =&gt; nil, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;aadd3610-c71d-48c2-983a-1c74f8ff4dd0&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;database&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/tree/master/database_scripts&quot;}, %{&quot;description&quot; =&gt; &quot;interface table&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;fcea53b3-81bf-419b-8443-5944fb674c46&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;transfer&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/transfer.sql&quot;}, %{&quot;description&quot; =&gt; &quot;table manipulation\nafter DDL&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;606f21fa-879f-4dda-a710-31e436046d09&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;postcreate&quot;, &quot;url&quot; =&gt; &quot;https://github.com/enter-haken/rasmus/blob/master/database_scripts/postcreate.sql&quot;}, %{&quot;description&quot; =&gt; &quot;generic CREATE, READ\nUPDATE, DELETE\nfunctions&quot;, &quot;entity&quot; =&gt; &quot;link&quot;, &quot;id&quot; =&gt; &quot;98b83cb9-5273-424f-bbd9-cd0d1b006014&quot;, &quot;id_owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;, &quot;is_dirty&quot; =&gt; false, &quot;name&quot; =&gt; &quot;crud&quot;, &quot;url&quot; =&gt; &quot;https: //github.com/enter-haken/rasmus/blob/master/database_scripts/crud.sql&quot;}], &quot;owner&quot; =&gt; &quot;376d0e62-2438-455a-ada6-b1a188274f38&quot;}]]}</code></pre>
<p>(hint: I reseeded the database to get a cleaner log for the <code>link</code> inserts. the <code>id</code>s won’t match with the other log example)</p>
<p>(hint: at the time of writing, the edges are not part of the response.)</p>
<h1 id="next-steps">next steps</h1>
<p>So far so good.</p>
<p>Currently, I am working on the <a href="https://en.wikipedia.org/wiki/Adjacency_list">adjacency lists</a> for rasmus. You can take a look into the <a href="https://github.com/enter-haken/rasmus/blob/master/database_scripts/graph_edge.sql">database scripts</a> for the graph itself, but it is still kind of raw.</p>

        </div>
        <div id="footer"> 
            created by Jan Frederik Hake | 
            <a href="https://enter-haken.github.io/atom.xml">atom feed</a> | 
            generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
            <a href="https://github.com/enter-haken/blog">blog source</a> |
            the source code on this site is covered by a <a href="../license.html">MIT license</a> | 
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
        </div>
    </body>
</html>
